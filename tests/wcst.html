<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wisconsin Card Sorting Test (WCST) - Neuroscript</title>
    <script src="../neuroscript-norms.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .input-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .input-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
        }
        .input-group {
            flex: 1;
        }
        label {
            display: block;
            font-weight: bold;
            color: #34495e;
            margin-bottom: 5px;
        }
        input[type="number"], select {
            width: 100%;
            padding: 8px;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        .data-entry-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .data-entry-table th, .data-entry-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }
        .data-entry-table th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        .data-entry-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .data-entry-table tr:hover {
            background-color: #e3f2fd;
        }
        .data-entry-table input[type="number"] {
            width: 80px;
            padding: 6px;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }
        .data-entry-table input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
            background-color: #fff;
        }
        .data-entry-table input.invalid {
            border-color: #e74c3c;
            background-color: #fadbd8;
        }
        .data-entry-table td:first-child {
            font-weight: bold;
            width: 40%;
        }
        .data-entry-table td:nth-child(2), .data-entry-table td:nth-child(3) {
            width: 30%;
            text-align: center;
        }
        .t-score-input {
            background-color: #e8f4fd;
            border-color: #6c757d;
        }
        .percentile-select {
            width: 120px;
            padding: 6px;
            border: 2px solid #6c757d;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff3e0;
        }
        .percentile-select:focus {
            outline: none;
            border-color: #3498db;
        }
        .na-cell {
            color: #6c757d;
            font-style: italic;
        }
        .section-divider {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .section-divider td {
            padding: 10px 8px;
            border-top: 2px solid #dee2e6;
        }
        .validation-messages {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            display: none;
        }
        .validation-messages.show {
            display: block;
        }
        .validation-messages ul {
            margin: 0;
            padding-left: 20px;
        }
        .validation-messages li {
            color: #856404;
            margin: 5px 0;
        }
        .btn {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .report-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 5px solid #3498db;
        }
        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
        }
        .score-table th, .score-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .score-table th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        .score-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .interpretation {
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f5e8;
            border-radius: 5px;
            border-left: 4px solid #27ae60;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .debug {
            margin: 10px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ§  Wisconsin Card Sorting Test (WCST)</h1>
            <p>Computerized Scoring and Interpretation</p>
        </div>

        <div class="input-section">
            <h3>Client Information</h3>
            <div class="input-row">
                <div class="input-group">
                    <label for="clientAge">Age:</label>
                    <input type="number" id="clientAge" min="16" max="89">
                </div>
                <div class="input-group">
                    <label for="clientGender">Gender:</label>
                    <select id="clientGender">
                        <option value="">Select...</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="clientEducation">Education (years):</label>
                    <input type="number" id="clientEducation" min="6" max="25">
                </div>
                <div class="input-group">
                    <label for="readingLevel">Reading Level:</label>
                    <select id="readingLevel">
                        <option value="">Select...</option>
                        <option value="1">Grade 1</option>
                        <option value="2">Grade 2</option>
                        <option value="3">Grade 3</option>
                        <option value="4">Grade 4</option>
                        <option value="5">Grade 5</option>
                        <option value="6">Grade 6</option>
                        <option value="7">Grade 7</option>
                        <option value="8">Grade 8</option>
                        <option value="9">Grade 9</option>
                        <option value="10">Grade 10</option>
                        <option value="11">Grade 11</option>
                        <option value="12">Grade 12</option>
                        <option value="college">College</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="input-section">
            <h3>WCST Computerized Printout - Test Results Section</h3>
            <p><em>Enter scores exactly as they appear on the computerized WCST printout:</em></p>
            
            <div class="printout-table">
                <table class="data-entry-table">
                    <thead>
                        <tr>
                            <th>Measure</th>
                            <th>Raw Score</th>
                            <th>T-Score / Percentile Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Raw scores only -->
                        <tr>
                            <td>Trials Administered</td>
                            <td><input type="number" id="trialsAdministered" min="64" max="128" placeholder="128"></td>
                            <td class="na-cell">--</td>
                        </tr>
                        <tr>
                            <td>Total Correct</td>
                            <td><input type="number" id="totalCorrect" min="0" max="128" placeholder=""></td>
                            <td class="na-cell">--</td>
                        </tr>
                        
                        <!-- Raw scores + T-scores -->
                        <tr class="section-divider">
                            <td colspan="3"><strong>Measures with T-Scores</strong></td>
                        </tr>
                        <tr>
                            <td>Total Errors</td>
                            <td><input type="number" id="totalErrors" min="0" max="128" placeholder=""></td>
                            <td><input type="number" id="totalErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>% Errors</td>
                            <td><input type="number" id="percentErrors" min="0" max="100" step="0.1" placeholder="" readonly></td>
                            <td><input type="number" id="percentErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>Perseverative Responses</td>
                            <td><input type="number" id="perseverativeResponses" min="0" max="128" placeholder=""></td>
                            <td><input type="number" id="perseverativeResponsesT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>% Perseverative Responses</td>
                            <td><input type="number" id="percentPerseverativeResponses" min="0" max="100" step="0.1" placeholder="" readonly></td>
                            <td><input type="number" id="percentPerseverativeResponsesT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>Perseverative Errors</td>
                            <td><input type="number" id="perseverativeErrors" min="0" max="128" placeholder=""></td>
                            <td><input type="number" id="perseverativeErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>% Perseverative Errors</td>
                            <td><input type="number" id="percentPerseverativeErrors" min="0" max="100" step="0.1" placeholder="" readonly></td>
                            <td><input type="number" id="percentPerseverativeErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>Non-Perseverative Errors</td>
                            <td><input type="number" id="nonperseverativeErrors" min="0" max="128" placeholder=""></td>
                            <td><input type="number" id="nonperseverativeErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>% Non-Perseverative Errors</td>
                            <td><input type="number" id="percentNonperseverativeErrors" min="0" max="100" step="0.1" placeholder="" readonly></td>
                            <td><input type="number" id="percentNonperseverativeErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>Conceptual Level Responses</td>
                            <td><input type="number" id="conceptualLevelResponses" min="0" max="128" placeholder=""></td>
                            <td class="na-cell">--</td>
                        </tr>
                        <tr>
                            <td>% Conceptual Level Responses</td>
                            <td><input type="number" id="percentConceptualLevelResponses" min="0" max="100" step="0.1" placeholder="" readonly></td>
                            <td><input type="number" id="percentConceptualLevelResponsesT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        
                        <!-- Raw scores + Percentile ranges -->
                        <tr class="section-divider">
                            <td colspan="3"><strong>Measures with Percentile Ranges</strong></td>
                        </tr>
                        <tr>
                            <td>Categories Completed</td>
                            <td><input type="number" id="categoriesCompleted" min="0" max="6" placeholder=""></td>
                            <td>
                                <select id="categoriesCompletedPercentile" class="percentile-select">
                                    <option value="">Select range...</option>
                                    <option value="<=1%">â‰¤1%</option>
                                    <option value="2-5%">2-5%</option>
                                    <option value="6-10%">6-10%</option>
                                    <option value="11-15%">11-15%</option>
                                    <option value=">=16%">â‰¥16%</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Trials to Complete First Category</td>
                            <td><input type="number" id="trialsToFirstCategory" min="0" max="128" placeholder=""></td>
                            <td>
                                <select id="trialsToFirstCategoryPercentile" class="percentile-select">
                                    <option value="">Select range...</option>
                                    <option value="<=1%">â‰¤1%</option>
                                    <option value="2-5%">2-5%</option>
                                    <option value="6-10%">6-10%</option>
                                    <option value="11-15%">11-15%</option>
                                    <option value=">=16%">â‰¥16%</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Failure to Maintain Set</td>
                            <td><input type="number" id="failureToMaintainSet" min="0" max="6" placeholder=""></td>
                            <td>
                                <select id="failureToMaintainSetPercentile" class="percentile-select">
                                    <option value="">Select range...</option>
                                    <option value="<=1%">â‰¤1%</option>
                                    <option value="2-5%">2-5%</option>
                                    <option value="6-10%">6-10%</option>
                                    <option value="11-15%">11-15%</option>
                                    <option value=">=16%">â‰¥16%</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Learning to Learn</td>
                            <td><input type="number" id="learningToLearn" min="-5" max="15" step="0.01" placeholder=""></td>
                            <td>
                                <select id="learningToLearnPercentile" class="percentile-select">
                                    <option value="">Select range...</option>
                                    <option value="<=1%">â‰¤1%</option>
                                    <option value="2-5%">2-5%</option>
                                    <option value="6-10%">6-10%</option>
                                    <option value="11-15%">11-15%</option>
                                    <option value=">=16%">â‰¥16%</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div id="validationMessages" class="validation-messages"></div>
            </div>
        </div>

        <div id="debugInfo" class="debug" style="display: none;"></div>

        <button class="btn" onclick="generateReport()">Generate Report</button>
        <button class="btn" onclick="completeTest()" id="completeBtn" disabled>Complete Test</button>

        <div id="reportContent" class="report-section" style="display: none;">
            <h3>WCST Report</h3>
            <div id="scoreTable"></div>
            <div id="narrative"></div>
        </div>
    </div>

    <script>
        let currentNarrative = '';
        let currentScoreTable = '';

        // Database availability check
        function checkDatabaseAvailability() {
            const debug = document.getElementById('debugInfo');
            debug.style.display = 'block';
            
            if (typeof window.NeuroscriptDB === 'undefined') {
                debug.innerHTML = 'âŒ ERROR: neuroscript-norms.js database not loaded!';
                return false;
            }
            
            debug.innerHTML = 'âœ… Database loaded successfully';
            setTimeout(() => { debug.style.display = 'none'; }, 2000);
            return true;
        }

        // Get clinical interpretation using external database
        function getClinicalInterpretationFromDB(tScore) {
            if (!window.NeuroscriptDB) {
                console.error('Database not available');
                return 'Unable to determine range';
            }

            try {
                const data = window.NeuroscriptDB.getByTScore(tScore);
                let interpretation = data.aacn; // Use AACN labels as default
                
                // Add Heaton impairment level for T<40
                if (tScore < 40) {
                    if (data.percentile <= 2) {
                        interpretation += `, indicating a moderately to severely impaired level`;
                    } else if (data.percentile <= 9) {
                        interpretation += `, indicating a mildly to moderately impaired level`;
                    } else if (data.percentile <= 16) {
                        interpretation += `, indicating a mildly impaired level`;
                    }
                }
                
                return interpretation;
            } catch (error) {
                console.error('Error getting clinical interpretation:', error);
                return 'Unable to determine range';
            }
        }

        // Enhanced T-score normative conversion using database
        function getTScoreFromPercentile(percentile) {
            if (!window.NeuroscriptDB) return 50; // Default if database unavailable
            
            // Find closest percentile match in database
            const closest = window.NeuroscriptDB.conversionTable.reduce((prev, curr) => 
                Math.abs(curr.percentile - percentile) < Math.abs(prev.percentile - percentile) ? curr : prev
            );
            return closest.t;
        }

        // WCST Normative data - using Heaton et al. (1993) norms
        function getWCSTTScore(rawScore, measure, age, education) {
            // Simplified normative calculations for demonstration
            // In practice, you would use complete normative tables
            const ageFactor = age < 50 ? 0 : (age - 50) * 0.2;
            const educationFactor = education < 12 ? (12 - education) * 0.5 : 0;
            
            let tScore = 50;
            
            switch(measure) {
                case 'categoriesCompleted':
                    tScore = 50 + (rawScore - 3) * 5 - ageFactor - educationFactor;
                    break;
                case 'perseverativeErrors':
                    tScore = 50 - (rawScore - 15) * 0.8 + ageFactor + educationFactor;
                    break;
                case 'perseverativeErrorsPercent':
                    tScore = 50 - (rawScore - 12) * 1.2 + ageFactor + educationFactor;
                    break;
                case 'nonperseverativeErrors':
                    tScore = 50 - (rawScore - 8) * 0.6 + ageFactor + educationFactor;
                    break;
                case 'conceptualLevelResponses':
                    tScore = 50 + (rawScore - 60) * 0.3 - ageFactor - educationFactor;
                    break;
                case 'conceptualLevelResponsesPercent':
                    tScore = 50 + (rawScore - 65) * 0.4 - ageFactor - educationFactor;
                    break;
                case 'trialsToFirstCategory':
                    tScore = 50 - (rawScore - 20) * 0.4 + ageFactor + educationFactor;
                    break;
                case 'failureToMaintainSet':
                    tScore = 50 - (rawScore - 1) * 3 + ageFactor + educationFactor;
                    break;
            }
            
            // Constrain to reasonable bounds
            return Math.max(20, Math.min(80, tScore));
        }

        // Auto-calculate and display T-scores as user enters data
        function updateTScores() {
            const age = parseInt(document.getElementById('clientAge').value) || 25;
            const education = parseInt(document.getElementById('clientEducation').value) || 12;

            const measures = [
                { id: 'categoriesCompleted', measure: 'categoriesCompleted' },
                { id: 'perseverativeErrors', measure: 'perseverativeErrors' },
                { id: 'nonperseverativeErrors', measure: 'nonperseverativeErrors' },
                { id: 'conceptualLevelResponses', measure: 'conceptualLevelResponses' },
                { id: 'trialsToFirstCategory', measure: 'trialsToFirstCategory' },
                { id: 'failureToMaintainSet', measure: 'failureToMaintainSet' }
            ];

            measures.forEach(item => {
                const value = parseInt(document.getElementById(item.id).value);
                if (!isNaN(value)) {
                    const tScore = Math.round(getWCSTTScore(value, item.measure, age, education));
                    document.getElementById(item.id + 'T').textContent = tScore;
                } else {
                    document.getElementById(item.id + 'T').textContent = '--';
                }
            });
        }

        // Auto-calculate percentages and update display
        function updateCalculatedValues() {
            const trialsAdmin = parseInt(document.getElementById('trialsAdministered').value) || 0;
            
            if (trialsAdmin > 0) {
                // Calculate % Errors
                const totalErrors = parseInt(document.getElementById('totalErrors').value) || 0;
                const percentErrors = ((totalErrors / trialsAdmin) * 100).toFixed(1);
                document.getElementById('percentErrors').value = percentErrors;
                
                // Calculate % Perseverative Responses
                const persevResponses = parseInt(document.getElementById('perseverativeResponses').value) || 0;
                const percentPersevResponses = ((persevResponses / trialsAdmin) * 100).toFixed(1);
                document.getElementById('percentPerseverativeResponses').value = percentPersevResponses;
                
                // Calculate % Perseverative Errors
                const persevErrors = parseInt(document.getElementById('perseverativeErrors').value) || 0;
                const percentPersevErrors = ((persevErrors / trialsAdmin) * 100).toFixed(1);
                document.getElementById('percentPerseverativeErrors').value = percentPersevErrors;
                
                // Calculate % Non-Perseverative Errors
                const nonPersevErrors = parseInt(document.getElementById('nonperseverativeErrors').value) || 0;
                const percentNonPersevErrors = ((nonPersevErrors / trialsAdmin) * 100).toFixed(1);
                document.getElementById('percentNonperseverativeErrors').value = percentNonPersevErrors;
                
                // Calculate % Conceptual Level Responses
                const conceptualResponses = parseInt(document.getElementById('conceptualLevelResponses').value) || 0;
                const percentConceptual = ((conceptualResponses / trialsAdmin) * 100).toFixed(1);
                document.getElementById('percentConceptualLevelResponses').value = percentConceptual;
            }
        }

        // Enhanced validation with new field structure
        function validateInput(elementId, min, max, customValidation = null) {
            const element = document.getElementById(elementId);
            const value = parseFloat(element.value);
            
            let isValid = true;
            let errorMessage = '';
            
            if (isNaN(value)) {
                element.classList.remove('invalid');
                return { valid: true, message: '' }; // Allow empty fields
            }
            
            if (value < min || value > max) {
                isValid = false;
                errorMessage = `${elementId.replace(/([A-Z])/g, ' $1')} must be between ${min}-${max}`;
            } else if (customValidation) {
                const customResult = customValidation(value);
                if (!customResult.valid) {
                    isValid = false;
                    errorMessage = customResult.message;
                }
            }
            
            if (isValid) {
                element.classList.remove('invalid');
            } else {
                element.classList.add('invalid');
            }
            
            return { valid: isValid, message: errorMessage };
        }

        function validateAllInputs() {
            let allValid = true;
            let errorMessages = [];
            
            // Trials administered
            const trialsResult = validateInput('trialsAdministered', 64, 128);
            if (!trialsResult.valid) errorMessages.push(trialsResult.message);
            allValid &= trialsResult.valid;
            
            const trialsAdmin = parseInt(document.getElementById('trialsAdministered').value) || 128;
            
            // Total correct
            const correctResult = validateInput('totalCorrect', 0, trialsAdmin, (value) => {
                return value <= trialsAdmin ? {valid: true} : {valid: false, message: 'Total correct cannot exceed trials administered'};
            });
            if (!correctResult.valid) errorMessages.push(correctResult.message);
            allValid &= correctResult.valid;
            
            // Total errors
            const errorsResult = validateInput('totalErrors', 0, trialsAdmin, (value) => {
                const totalCorrect = parseInt(document.getElementById('totalCorrect').value) || 0;
                return (value + totalCorrect <= trialsAdmin) ? {valid: true} : {valid: false, message: 'Total correct + total errors cannot exceed trials administered'};
            });
            if (!errorsResult.valid) errorMessages.push(errorsResult.message);
            allValid &= errorsResult.valid;
            
            const totalErrors = parseInt(document.getElementById('totalErrors').value) || 0;
            
            // Perseverative responses
            const persevRespResult = validateInput('perseverativeResponses', 0, trialsAdmin, (value) => {
                return value <= totalErrors ? {valid: true} : {valid: false, message: 'Perseverative responses cannot exceed total errors'};
            });
            if (!persevRespResult.valid) errorMessages.push(persevRespResult.message);
            allValid &= persevRespResult.valid;
            
            const persevResponses = parseInt(document.getElementById('perseverativeResponses').value) || 0;
            
            // Perseverative errors
            const persevErrResult = validateInput('perseverativeErrors', 0, persevResponses, (value) => {
                return value <= persevResponses ? {valid: true} : {valid: false, message: 'Perseverative errors cannot exceed perseverative responses'};
            });
            if (!persevErrResult.valid) errorMessages.push(persevErrResult.message);
            allValid &= persevErrResult.valid;
            
            const persevErrors = parseInt(document.getElementById('perseverativeErrors').value) || 0;
            
            // Non-perseverative errors
            const nonPersevResult = validateInput('nonperseverativeErrors', 0, totalErrors, (value) => {
                const expectedNonPersev = totalErrors - persevErrors;
                return Math.abs(value - expectedNonPersev) <= 1 ? {valid: true} : {valid: false, message: `Non-perseverative errors should be approximately ${expectedNonPersev} (total errors - perseverative errors)`};
            });
            if (!nonPersevResult.valid) errorMessages.push(nonPersevResult.message);
            allValid &= nonPersevResult.valid;
            
            // Categories completed
            const catResult = validateInput('categoriesCompleted', 0, 6);
            if (!catResult.valid) errorMessages.push(catResult.message);
            allValid &= catResult.valid;
            
            // Trials to first category
            const trialsResult_first = validateInput('trialsToFirstCategory', 0, trialsAdmin, (value) => {
                return value <= trialsAdmin ? {valid: true} : {valid: false, message: 'Trials to first category cannot exceed trials administered'};
            });
            if (!trialsResult_first.valid) errorMessages.push(trialsResult_first.message);
            allValid &= trialsResult_first.valid;
            
            // Failure to maintain set
            const failureResult = validateInput('failureToMaintainSet', 0, 6);
            if (!failureResult.valid) errorMessages.push(failureResult.message);
            allValid &= failureResult.valid;
            
            // Conceptual level responses
            const conceptualResult = validateInput('conceptualLevelResponses', 0, trialsAdmin, (value) => {
                return value <= trialsAdmin ? {valid: true} : {valid: false, message: 'Conceptual level responses cannot exceed trials administered'};
            });
            if (!conceptualResult.valid) errorMessages.push(conceptualResult.message);
            allValid &= conceptualResult.valid;
            
            // Learning to learn
            const learningResult = validateInput('learningToLearn', -5, 15);
            if (!learningResult.valid) errorMessages.push(learningResult.message);
            allValid &= learningResult.valid;
            
            // Display validation messages
            const validationDiv = document.getElementById('validationMessages');
            if (errorMessages.length > 0) {
                validationDiv.innerHTML = '<strong>Please correct the following:</strong><ul>' + 
                    errorMessages.map(msg => `<li>${msg}</li>`).join('') + '</ul>';
                validationDiv.classList.add('show');
            } else {
                validationDiv.classList.remove('show');
            }
            
            return allValid;
        }

        function generateReport() {
            if (!checkDatabaseAvailability()) {
                alert('Database not available. Cannot generate report.');
                return;
            }

            if (!validateAllInputs()) {
                alert('Please correct all validation errors before generating the report.');
                return;
            }

            const data = collectData();
            if (!data) return;

            // Generate score table
            currentScoreTable = generateScoreTable(data);
            
            // Generate narrative
            currentNarrative = generateNarrative(data);
            
            // Display results
            document.getElementById('scoreTable').innerHTML = currentScoreTable;
            document.getElementById('narrative').innerHTML = currentNarrative;
            document.getElementById('reportContent').style.display = 'block';
            document.getElementById('completeBtn').disabled = false;
        }

        function collectData() {
            const requiredRawFields = [
                'trialsAdministered', 'totalCorrect', 'totalErrors', 'perseverativeResponses',
                'perseverativeErrors', 'nonperseverativeErrors', 'conceptualLevelResponses',
                'categoriesCompleted', 'trialsToFirstCategory', 'failureToMaintainSet', 'learningToLearn'
            ];

            const tScoreFields = [
                'totalErrorsT', 'percentErrorsT', 'perseverativeResponsesT', 'percentPerseverativeResponsesT',
                'perseverativeErrorsT', 'percentPerseverativeErrorsT', 'nonperseverativeErrorsT', 
                'percentNonperseverativeErrorsT', 'percentConceptualLevelResponsesT'
            ];

            const percentileFields = [
                'categoriesCompletedPercentile', 'trialsToFirstCategoryPercentile', 
                'failureToMaintainSetPercentile', 'learningToLearnPercentile'
            ];

            const data = {};
            
            // Collect raw scores
            for (const field of requiredRawFields) {
                const value = parseFloat(document.getElementById(field).value);
                if (isNaN(value)) {
                    alert(`Please enter a value for ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
                    return null;
                }
                data[field] = value;
            }

            // Collect T-scores (only for measures that have them)
            for (const field of tScoreFields) {
                const element = document.getElementById(field);
                if (element) {
                    const value = parseFloat(element.value);
                    if (isNaN(value)) {
                        alert(`Please enter the T-score for ${field.replace(/([A-Z])/g, ' $1').replace('T', '').toLowerCase()}`);
                        return null;
                    }
                    data[field] = value;
                }
            }

            // Collect percentile ranges (for measures that have them)
            for (const field of percentileFields) {
                const element = document.getElementById(field);
                if (element) {
                    const value = element.value;
                    if (!value) {
                        alert(`Please select the percentile range for ${field.replace(/([A-Z])/g, ' $1').replace('Percentile', '').toLowerCase()}`);
                        return null;
                    }
                    data[field] = value;
                }
            }

            // Client demographics (from parent page)
            data.age = parseInt(document.getElementById('clientAge').value) || 25;
            data.gender = document.getElementById('clientGender').value || 'male';
            data.education = parseInt(document.getElementById('clientEducation').value) || 12;
            data.readingLevel = document.getElementById('readingLevel').value || '12';

            return data;
        }

        function generateScoreTable(data) {
            // Get T-scores from the input fields (entered from printout)
            const scores = [
                {
                    measure: 'Categories Completed',
                    raw: data.categoriesCompleted,
                    tScore: data.categoriesCompletedT,
                    interpretation: ''
                },
                {
                    measure: 'Perseverative Errors',
                    raw: data.perseverativeErrors,
                    tScore: data.perseverativeErrorsT,
                    interpretation: ''
                },
                {
                    measure: 'Perseverative Errors (%)',
                    raw: data.perseverativeErrorsPercent + '%',
                    tScore: data.perseverativeErrorsT, // Use same T-score as perseverative errors
                    interpretation: ''
                },
                {
                    measure: 'Non-Perseverative Errors',
                    raw: data.nonperseverativeErrors,
                    tScore: data.nonperseverativeErrorsT,
                    interpretation: ''
                },
                {
                    measure: 'Conceptual Level Responses',
                    raw: data.conceptualLevelResponses,
                    tScore: data.conceptualLevelResponsesT,
                    interpretation: ''
                },
                {
                    measure: 'Conceptual Level Responses (%)',
                    raw: data.conceptualLevelResponsesPercent + '%',
                    tScore: data.conceptualLevelResponsesT, // Use same T-score as conceptual level responses
                    interpretation: ''
                },
                {
                    measure: 'Trials to First Category',
                    raw: data.trialsToFirstCategory,
                    tScore: data.trialsToFirstCategoryT,
                    interpretation: ''
                },
                {
                    measure: 'Failure to Maintain Set',
                    raw: data.failureToMaintainSet,
                    tScore: data.failureToMaintainSetT,
                    interpretation: ''
                }
            ];

            // Add interpretations using database
            scores.forEach(score => {
                score.interpretation = getClinicalInterpretationFromDB(score.tScore);
            });

            let table = `
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>Measure</th>
                            <th>Raw Score</th>
                            <th>T-Score</th>
                            <th>Clinical Range</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            scores.forEach(score => {
                table += `
                    <tr>
                        <td>${score.measure}</td>
                        <td>${score.raw}</td>
                        <td>${score.tScore}</td>
                        <td>${score.interpretation}</td>
                    </tr>
                `;
            });

            table += `
                    </tbody>
                </table>
            `;

            return table;
        }

        function generateNarrative(data) {
            const pronoun = data.gender === 'female' ? 'she' : 'he';
            const possessive = data.gender === 'female' ? 'her' : 'his';
            const pronoun_cap = data.gender === 'female' ? 'She' : 'He';

            // Use T-scores from the printout (not calculated)
            const catCompletedT = data.categoriesCompletedT;
            const persevErrorsT = data.perseverativeErrorsT;
            const conceptualRespT = data.conceptualLevelResponsesT;
            const trialsFirstCatT = data.trialsToFirstCategoryT;

            // Get clinical interpretations using database
            const catCompletedRange = getClinicalInterpretationFromDB(catCompletedT);
            const persevErrorsRange = getClinicalInterpretationFromDB(persevErrorsT);
            const conceptualRespRange = getClinicalInterpretationFromDB(conceptualRespT);

            let narrative = `
                <div class="interpretation">
                    <h4>Wisconsin Card Sorting Test (WCST) Results</h4>
                    
                    <p><strong>Executive Function and Cognitive Flexibility:</strong></p>
                    <p>The client completed ${data.categoriesCompleted} out of 6 possible categories (T=${catCompletedT}), which falls in the ${catCompletedRange} range. This indicates ${possessive} level of conceptual reasoning and ability to identify abstract sorting principles.</p>
                    
                    <p><strong>Perseverative Responding:</strong></p>
                    <p>${pronoun_cap} made ${data.perseverativeErrors} perseverative errors (T=${persevErrorsT}), representing ${data.perseverativeErrorsPercent}% of total responses. This performance falls in the ${persevErrorsRange} range, suggesting ${persevErrorsT < 40 ? 'elevated' : persevErrorsT > 60 ? 'reduced' : 'typical'} perseverative tendencies.</p>
                    
                    <p><strong>Conceptual Responding:</strong></p>
                    <p>${pronoun_cap} achieved ${data.conceptualLevelResponses} conceptual level responses (${data.conceptualLevelResponsesPercent}% of total responses, T=${conceptualRespT}), which is in the ${conceptualRespRange} range. This reflects ${possessive} ability to maintain abstract concepts once identified.</p>
                    
                    <p><strong>Set-Formation Efficiency:</strong></p>
                    <p>The client required ${data.trialsToFirstCategory} trials to complete the first category (T=${trialsFirstCatT}), indicating ${trialsFirstCatT < 40 ? 'difficulty with' : trialsFirstCatT > 60 ? 'efficient' : 'typical performance in'} initial concept formation.</p>
                    
                    ${data.failureToMaintainSet > 0 ? `<p><strong>Set Maintenance:</strong> ${pronoun_cap} demonstrated ${data.failureToMaintainSet} failure(s) to maintain set, suggesting ${data.failureToMaintainSet > 2 ? 'significant difficulty' : 'some difficulty'} maintaining cognitive control once a category was established.</p>` : ''}
                    
                    <p><strong>Clinical Summary:</strong></p>
                    <p>Overall, these results suggest ${
                        catCompletedT >= 50 && persevErrorsT >= 45 && conceptualRespT >= 50 ? 
                        'intact executive functioning with good cognitive flexibility and concept formation abilities' :
                        catCompletedT < 40 || persevErrorsT < 35 || conceptualRespT < 40 ?
                        'evidence of executive dysfunction, with particular difficulties in cognitive flexibility and/or concept formation' :
                        'mixed executive functioning, with some areas of strength and some areas of relative weakness'
                    }.</p>
                </div>
            `;

            // Add warnings for extreme scores or unusual patterns
            let warnings = [];
            
            if (data.categoriesCompleted === 0) {
                warnings.push("No categories completed - consider potential motivational, attentional, or severe executive dysfunction.");
            }
            
            if (data.perseverativeErrorsPercent > 30) {
                warnings.push("Extremely high perseverative error rate - consider frontal lobe dysfunction.");
            }
            
            if (data.trialsToFirstCategory > 50) {
                warnings.push("Unusually high trials to first category - may indicate significant concept formation difficulties.");
            }

            if (warnings.length > 0) {
                narrative += '<div class="warning"><h4>Clinical Warnings:</h4><ul>';
                warnings.forEach(warning => {
                    narrative += `<li>${warning}</li>`;
                });
                narrative += '</ul></div>';
            }

            return narrative;
        }

        function completeTest() {
            if (!currentNarrative) {
                alert('Please generate the report first.');
                return;
            }

            const results = {
                narrative: currentNarrative,
                scoreTable: currentScoreTable,
                testName: 'Wisconsin Card Sorting Test',
                completedAt: new Date().toISOString()
            };

            window.parent.postMessage({
                type: 'testComplete',
                testName: 'wcst',
                results: results
            }, '*');
        }

        // Listen for client info from parent
        window.addEventListener('message', function(event) {
            if (event.data.type === 'clientInfo') {
                const clientInfo = event.data.data;

                if (clientInfo.clientAge) {
                    document.getElementById('clientAge').value = clientInfo.clientAge;
                }

                if (clientInfo.clientGender) {
                    document.getElementById('clientGender').value = clientInfo.clientGender;
                }

                if (clientInfo.clientEducation) {
                    document.getElementById('clientEducation').value = clientInfo.clientEducation;
                }

                if (clientInfo.readingLevel) {
                    document.getElementById('readingLevel').value = clientInfo.readingLevel;
                }
            }
        });

        // Auto-validate and update T-scores on input changes
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateAllInputs();
                    updateTScores();
                });
                input.addEventListener('change', function() {
                    validateAllInputs();
                    updateTScores();
                });
            });
            
            // Check database on load
            setTimeout(checkDatabaseAvailability, 500);
        });
    </script>
</body>
</html>
