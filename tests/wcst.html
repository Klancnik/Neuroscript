<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wisconsin Card Sorting Test (WCST) - Neuroscript</title>
    <script src="../neuroscript-norms.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .input-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .data-entry-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .data-entry-table th, .data-entry-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: middle;
        }
        .data-entry-table th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        .data-entry-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .data-entry-table tr:hover {
            background-color: #e3f2fd;
        }
        .data-entry-table input[type="number"] {
            width: 80px;
            padding: 6px;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }
        .data-entry-table input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
            background-color: #fff;
        }
        .data-entry-table input.invalid {
            border-color: #e74c3c;
            background-color: #fadbd8;
        }
        .data-entry-table td:first-child {
            font-weight: bold;
            width: 40%;
        }
        .data-entry-table td:nth-child(2), .data-entry-table td:nth-child(3) {
            width: 30%;
            text-align: center;
        }
        .t-score-input {
            background-color: #e8f4fd;
            border-color: #6c757d;
        }
        .percentile-select {
            width: 120px;
            padding: 6px;
            border: 2px solid #6c757d;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff3e0;
        }
        .percentile-select:focus {
            outline: none;
            border-color: #3498db;
        }
        .na-cell {
            color: #6c757d;
            font-style: italic;
        }
        .calculated-cell {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: bold;
            font-style: italic;
            text-align: center;
            padding: 8px;
        }
        .section-divider {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .section-divider td {
            padding: 10px 8px;
            border-top: 2px solid #dee2e6;
        }
        .validation-messages {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            display: none;
        }
        .validation-messages.show {
            display: block;
        }
        .validation-messages ul {
            margin: 0;
            padding-left: 20px;
        }
        .validation-messages li {
            color: #856404;
            margin: 5px 0;
        }
        .btn {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .report-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 5px solid #3498db;
        }
        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
        }
        .score-table th, .score-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .score-table th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        .score-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .interpretation {
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f5e8;
            border-radius: 5px;
            border-left: 4px solid #27ae60;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .debug {
            margin: 10px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Wisconsin Card Sorting Test (WCST)</h1>
            <p>Computerized Scoring and Interpretation</p>
        </div>

        <div class="input-section">
            <h3>WCST Computerized Printout - Test Results Section</h3>
            <p><em>Enter scores exactly as they appear on the computerized WCST printout:</em></p>
            
            <div class="printout-table">
                <table class="data-entry-table">
                    <thead>
                        <tr>
                            <th>Measure</th>
                            <th>Raw Score</th>
                            <th>T-Score / Percentile Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Raw scores only -->
                        <tr>
                            <td>Trials Administered</td>
                            <td><input type="number" id="trialsAdministered" min="60" max="128" placeholder=""></td>
                            <td class="na-cell">--</td>
                        </tr>
                        <tr>
                            <td>Total Correct</td>
                            <td><input type="number" id="totalCorrect" min="0" max="128" placeholder=""></td>
                            <td class="na-cell">--</td>
                        </tr>
                        
                        <!-- Raw scores + T-scores -->
                        <tr class="section-divider">
                            <td colspan="3"><strong>Measures with T-Scores</strong></td>
                        </tr>
                        <tr>
                            <td>Total Errors</td>
                            <td><input type="number" id="totalErrors" min="0" max="128" placeholder=""></td>
                            <td><input type="number" id="totalErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>% Errors</td>
                            <td class="calculated-cell" id="percentErrorsDisplay">--</td>
                            <td><input type="number" id="percentErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>Perseverative Responses</td>
                            <td><input type="number" id="perseverativeResponses" min="0" max="128" placeholder=""></td>
                            <td><input type="number" id="perseverativeResponsesT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>% Perseverative Responses</td>
                            <td class="calculated-cell" id="percentPerseverativeResponsesDisplay">--</td>
                            <td><input type="number" id="percentPerseverativeResponsesT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>Perseverative Errors</td>
                            <td><input type="number" id="perseverativeErrors" min="0" max="128" placeholder=""></td>
                            <td><input type="number" id="perseverativeErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>% Perseverative Errors</td>
                            <td class="calculated-cell" id="percentPerseverativeErrorsDisplay">--</td>
                            <td><input type="number" id="percentPerseverativeErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>Non-Perseverative Errors</td>
                            <td><input type="number" id="nonperseverativeErrors" min="0" max="128" placeholder=""></td>
                            <td><input type="number" id="nonperseverativeErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>% Non-Perseverative Errors</td>
                            <td class="calculated-cell" id="percentNonperseverativeErrorsDisplay">--</td>
                            <td><input type="number" id="percentNonperseverativeErrorsT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        <tr>
                            <td>Conceptual Level Responses</td>
                            <td><input type="number" id="conceptualLevelResponses" min="0" max="128" placeholder=""></td>
                            <td class="na-cell">--</td>
                        </tr>
                        <tr>
                            <td>% Conceptual Level Responses</td>
                            <td class="calculated-cell" id="percentConceptualLevelResponsesDisplay">--</td>
                            <td><input type="number" id="percentConceptualLevelResponsesT" min="20" max="80" placeholder="T-score" class="t-score-input"></td>
                        </tr>
                        
                        <!-- Raw scores + Percentile ranges -->
                        <tr class="section-divider">
                            <td colspan="3"><strong>Measures with Percentile Ranges</strong></td>
                        </tr>
                        <tr>
                            <td>Categories Completed</td>
                            <td><input type="number" id="categoriesCompleted" min="0" max="6" placeholder=""></td>
                            <td>
                                <select id="categoriesCompletedPercentile" class="percentile-select">
                                    <option value="">Select range...</option>
                                    <option value="<=1%">≤1%</option>
                                    <option value="2-5%">2-5%</option>
                                    <option value="6-10%">6-10%</option>
                                    <option value="11-16%">11-16%</option>
                                    <option value=">16%">>16%</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Trials to Complete First Category</td>
                            <td><input type="number" id="trialsToFirstCategory" min="0" max="128" placeholder=""></td>
                            <td>
                                <select id="trialsToFirstCategoryPercentile" class="percentile-select">
                                    <option value="">Select range...</option>
                                    <option value="<=1%">≤1%</option>
                                    <option value="2-5%">2-5%</option>
                                    <option value="6-10%">6-10%</option>
                                    <option value="11-16%">11-16%</option>
                                    <option value=">16%">>16%</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Failure to Maintain Set</td>
                            <td><input type="number" id="failureToMaintainSet" min="0" max="6" placeholder=""></td>
                            <td>
                                <select id="failureToMaintainSetPercentile" class="percentile-select">
                                    <option value="">Select range...</option>
                                    <option value="<=1%">≤1%</option>
                                    <option value="2-5%">2-5%</option>
                                    <option value="6-10%">6-10%</option>
                                    <option value="11-16%">11-16%</option>
                                    <option value=">16%">>16%</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Learning to Learn</td>
                            <td><input type="number" id="learningToLearn" min="-5" max="15" step="0.01" placeholder=""></td>
                            <td>
                                <select id="learningToLearnPercentile" class="percentile-select">
                                    <option value="">Select range...</option>
                                    <option value="<=1%">≤1%</option>
                                    <option value="2-5%">2-5%</option>
                                    <option value="6-10%">6-10%</option>
                                    <option value="11-16%">11-16%</option>
                                    <option value=">16%">>16%</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div id="validationMessages" class="validation-messages"></div>
            </div>
        </div>

        <div id="debugInfo" class="debug" style="display: none;"></div>

        <button class="btn" onclick="generateReport()">Generate Report</button>
        <button class="btn" onclick="completeTest()" id="completeBtn" disabled>Complete Test</button>

        <div id="reportContent" class="report-section" style="display: none;">
            <h3>WCST Report</h3>
            <div id="scoreTable"></div>
            <div id="narrative"></div>
        </div>
    </div>

    <script>
        let currentNarrative = '';
        let currentScoreTable = '';

        // Hidden client info inputs for message listener compatibility
        const hiddenClientInputs = document.createElement('div');
        hiddenClientInputs.style.display = 'none';
        hiddenClientInputs.innerHTML = `
            <input type="number" id="clientAge" value="25">
            <select id="clientGender"><option value="male" selected>Male</option></select>
            <input type="number" id="clientEducation" value="12">
            <select id="readingLevel"><option value="12" selected>12</option></select>
        `;
        document.body.appendChild(hiddenClientInputs);

        // Database availability check
        function checkDatabaseAvailability() {
            const debug = document.getElementById('debugInfo');
            debug.style.display = 'block';
            
            if (typeof window.NeuroscriptDB === 'undefined') {
                debug.innerHTML = '❌ ERROR: neuroscript-norms.js database not loaded!';
                return false;
            }
            
            debug.innerHTML = '✅ Database loaded successfully';
            setTimeout(() => { debug.style.display = 'none'; }, 2000);
            return true;
        }

        // Get clinical interpretation using external database
        function getClinicalInterpretationFromDB(tScore) {
            if (!window.NeuroscriptDB) {
                console.error('Database not available');
                return 'Unable to determine range';
            }

            try {
                const data = window.NeuroscriptDB.getByTScore(tScore);
                let interpretation = data.aacn; // Use AACN labels as default
                
                // Add Heaton impairment level for T<40
                if (tScore < 40) {
                    if (data.percentile <= 2) {
                        interpretation += ` range, indicating a moderately to severely impaired level of impairment`;
                    } else if (data.percentile <= 9) {
                        interpretation += ` range, indicating a mild to moderately impaired level of impairment`;
                    } else if (data.percentile <= 16) {
                        interpretation += ` range, indicating a mildly impaired level of impairment`;
                    }
                } else {
                    interpretation += ' range';
                }
                
                return interpretation;
            } catch (error) {
                console.error('Error getting clinical interpretation:', error);
                return 'Unable to determine range';
            }
        }

        // Auto-calculate percentages and update display
        function updateCalculatedValues() {
            const trialsAdmin = parseInt(document.getElementById('trialsAdministered').value) || 0;
            
            if (trialsAdmin > 0) {
                // Calculate and display % Errors
                const totalErrors = parseInt(document.getElementById('totalErrors').value) || 0;
                const percentErrors = ((totalErrors / trialsAdmin) * 100).toFixed(1);
                document.getElementById('percentErrorsDisplay').textContent = percentErrors + '%';
                
                // Calculate and display % Perseverative Responses
                const persevResponses = parseInt(document.getElementById('perseverativeResponses').value) || 0;
                const percentPersevResponses = ((persevResponses / trialsAdmin) * 100).toFixed(1);
                document.getElementById('percentPerseverativeResponsesDisplay').textContent = percentPersevResponses + '%';
                
                // Calculate and display % Perseverative Errors
                const persevErrors = parseInt(document.getElementById('perseverativeErrors').value) || 0;
                const percentPersevErrors = ((persevErrors / trialsAdmin) * 100).toFixed(1);
                document.getElementById('percentPerseverativeErrorsDisplay').textContent = percentPersevErrors + '%';
                
                // Calculate and display % Non-Perseverative Errors
                const nonPersevErrors = parseInt(document.getElementById('nonperseverativeErrors').value) || 0;
                const percentNonPersevErrors = ((nonPersevErrors / trialsAdmin) * 100).toFixed(1);
                document.getElementById('percentNonperseverativeErrorsDisplay').textContent = percentNonPersevErrors + '%';
                
                // Calculate and display % Conceptual Level Responses
                const conceptualResponses = parseInt(document.getElementById('conceptualLevelResponses').value) || 0;
                const percentConceptual = ((conceptualResponses / trialsAdmin) * 100).toFixed(1);
                document.getElementById('percentConceptualLevelResponsesDisplay').textContent = percentConceptual + '%';
            } else {
                // Reset displays if no trials administered
                document.getElementById('percentErrorsDisplay').textContent = '--';
                document.getElementById('percentPerseverativeResponsesDisplay').textContent = '--';
                document.getElementById('percentPerseverativeErrorsDisplay').textContent = '--';
                document.getElementById('percentNonperseverativeErrorsDisplay').textContent = '--';
                document.getElementById('percentConceptualLevelResponsesDisplay').textContent = '--';
            }
        }

        // Enhanced validation with new field structure
        function validateInput(elementId, min, max, customValidation = null) {
            const element = document.getElementById(elementId);
            if (!element) return { valid: true, message: '' };
            
            const value = parseFloat(element.value);
            
            let isValid = true;
            let errorMessage = '';
            
            if (isNaN(value)) {
                element.classList.remove('invalid');
                return { valid: true, message: '' }; // Allow empty fields
            }
            
            if (value < min || value > max) {
                isValid = false;
                errorMessage = `${elementId.replace(/([A-Z])/g, ' $1')} must be between ${min}-${max}`;
            } else if (customValidation) {
                const customResult = customValidation(value);
                if (!customResult.valid) {
                    isValid = false;
                    errorMessage = customResult.message;
                }
            }
            
            if (isValid) {
                element.classList.remove('invalid');
            } else {
                element.classList.add('invalid');
            }
            
            return { valid: isValid, message: errorMessage };
        }

        function validateAllInputs() {
            let allValid = true;
            let errorMessages = [];
            
            // Trials administered
            const trialsResult = validateInput('trialsAdministered', 60, 128);
            if (!trialsResult.valid) errorMessages.push(trialsResult.message);
            allValid &= trialsResult.valid;
            
            const trialsAdmin = parseInt(document.getElementById('trialsAdministered').value) || 128;
            
            // Total correct
            const correctResult = validateInput('totalCorrect', 0, trialsAdmin, (value) => {
                return value <= trialsAdmin ? {valid: true} : {valid: false, message: 'Total correct cannot exceed trials administered'};
            });
            if (!correctResult.valid) errorMessages.push(correctResult.message);
            allValid &= correctResult.valid;
            
            // Total errors
            const errorsResult = validateInput('totalErrors', 0, trialsAdmin, (value) => {
                const totalCorrect = parseInt(document.getElementById('totalCorrect').value) || 0;
                return (value + totalCorrect <= trialsAdmin) ? {valid: true} : {valid: false, message: 'Total correct + total errors cannot exceed trials administered'};
            });
            if (!errorsResult.valid) errorMessages.push(errorsResult.message);
            allValid &= errorsResult.valid;
            
            // Display validation messages
            const validationDiv = document.getElementById('validationMessages');
            if (errorMessages.length > 0) {
                validationDiv.innerHTML = '<strong>Please correct the following:</strong><ul>' + 
                    errorMessages.map(msg => `<li>${msg}</li>`).join('') + '</ul>';
                validationDiv.classList.add('show');
            } else {
                validationDiv.classList.remove('show');
            }
            
            return allValid;
        }

        function generateReport() {
            if (!checkDatabaseAvailability()) {
                alert('Database not available. Cannot generate report.');
                return;
            }

            if (!validateAllInputs()) {
                alert('Please correct all validation errors before generating the report.');
                return;
            }

            const data = collectData();
            if (!data) return;

            // Generate score table
            currentScoreTable = generateScoreTable(data);
            
            // Generate narrative
            currentNarrative = generateNarrative(data);
            
            // Display results
            document.getElementById('scoreTable').innerHTML = currentScoreTable;
            document.getElementById('narrative').innerHTML = currentNarrative;
            document.getElementById('reportContent').style.display = 'block';
            document.getElementById('completeBtn').disabled = false;
        }

        function collectData() {
            const requiredRawFields = [
                'trialsAdministered', 'totalCorrect', 'totalErrors', 'perseverativeResponses',
                'perseverativeErrors', 'nonperseverativeErrors', 'conceptualLevelResponses',
                'categoriesCompleted', 'trialsToFirstCategory', 'failureToMaintainSet', 'learningToLearn'
            ];

            const tScoreFields = [
                'totalErrorsT', 'percentErrorsT', 'perseverativeResponsesT', 'percentPerseverativeResponsesT',
                'perseverativeErrorsT', 'percentPerseverativeErrorsT', 'nonperseverativeErrorsT', 
                'percentNonperseverativeErrorsT', 'percentConceptualLevelResponsesT'
            ];

            const percentileFields = [
                'categoriesCompletedPercentile', 'trialsToFirstCategoryPercentile', 
                'failureToMaintainSetPercentile', 'learningToLearnPercentile'
            ];

            const data = {};
            
            // Collect raw scores
            for (const field of requiredRawFields) {
                const element = document.getElementById(field);
                if (!element) {
                    console.log(`Element ${field} not found`);
                    continue;
                }
                const value = parseFloat(element.value);
                if (isNaN(value)) {
                    alert(`Please enter a value for ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
                    return null;
                }
                data[field] = value;
            }

            // Collect T-scores (only for measures that have them)
            for (const field of tScoreFields) {
                const element = document.getElementById(field);
                if (element) {
                    const value = parseFloat(element.value);
                    if (isNaN(value)) {
                        alert(`Please enter the T-score for ${field.replace(/([A-Z])/g, ' $1').replace('T', '').toLowerCase()}`);
                        return null;
                    }
                    data[field] = value;
                }
            }

            // Collect percentile ranges (for measures that have them)
            for (const field of percentileFields) {
                const element = document.getElementById(field);
                if (element) {
                    const value = element.value;
                    if (!value) {
                        alert(`Please select the percentile range for ${field.replace(/([A-Z])/g, ' $1').replace('Percentile', '').toLowerCase()}`);
                        return null;
                    }
                    data[field] = value;
                }
            }

            // Client demographics (from hidden inputs)
            data.age = parseInt(document.getElementById('clientAge').value) || 25;
            data.gender = document.getElementById('clientGender').value || 'male';
            data.education = parseInt(document.getElementById('clientEducation').value) || 12;
            data.readingLevel = document.getElementById('readingLevel').value || '12';

            // Add calculated percentages to data
            data.percentErrors = parseFloat(document.getElementById('percentErrorsDisplay').textContent.replace('%', '')) || 0;
            data.percentPerseverativeResponses = parseFloat(document.getElementById('percentPerseverativeResponsesDisplay').textContent.replace('%', '')) || 0;
            data.percentPerseverativeErrors = parseFloat(document.getElementById('percentPerseverativeErrorsDisplay').textContent.replace('%', '')) || 0;
            data.percentNonperseverativeErrors = parseFloat(document.getElementById('percentNonperseverativeErrorsDisplay').textContent.replace('%', '')) || 0;
            data.percentConceptualLevelResponses = parseFloat(document.getElementById('percentConceptualLevelResponsesDisplay').textContent.replace('%', '')) || 0;

            return data;
        }

        function generateScoreTable(data) {
            // Get T-scores from the input fields (entered from printout)
            const scores = [
                {
                    measure: 'Categories Completed',
                    raw: data.categoriesCompleted,
                    tScore: null,
                    percentileRange: data.categoriesCompletedPercentile,
                    interpretation: data.categoriesCompletedPercentile
                },
                {
                    measure: 'Total Errors',
                    raw: data.totalErrors,
                    tScore: data.totalErrorsT,
                    percentileRange: null,
                    interpretation: ''
                },
                {
                    measure: 'Perseverative Errors',
                    raw: data.perseverativeErrors,
                    tScore: data.perseverativeErrorsT,
                    percentileRange: null,
                    interpretation: ''
                }
            ];

            // Add interpretations using database for T-scores
            scores.forEach(score => {
                if (score.tScore) {
                    score.interpretation = getClinicalInterpretationFromDB(score.tScore);
                }
            });

            let table = `
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>Measure</th>
                            <th>Raw Score</th>
                            <th>T-Score</th>
                            <th>Percentile Range</th>
                            <th>Clinical Range</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            scores.forEach(score => {
                table += `
                    <tr>
                        <td>${score.measure}</td>
                        <td>${score.raw}</td>
                        <td>${score.tScore || '--'}</td>
                        <td>${score.percentileRange || '--'}</td>
                        <td>${score.interpretation}</td>
                    </tr>
                `;
            });

            table += `
                    </tbody>
                </table>
            `;

            return table;
        }

        function generateNarrative(data) {
            const pronoun = data.gender === 'female' ? 'she' : 'he';
            const possessive = data.gender === 'female' ? 'her' : 'his';
            const pronoun_cap = data.gender === 'female' ? 'She' : 'He';

            // Use T-scores from the printout (not calculated)
            const totalErrorsT = data.totalErrorsT || 50;
            const persevErrorsT = data.perseverativeErrorsT || 50;

            // Get clinical interpretations using database
            const totalErrorsRange = getClinicalInterpretationFromDB(totalErrorsT);
            const persevErrorsRange = getClinicalInterpretationFromDB(persevErrorsT);

            let narrative = `
                <div class="interpretation">
                    <h4>Wisconsin Card Sorting Test (WCST) Results</h4>
                    
                    <p>The client completed ${data.categoriesCompleted} out of 6 possible categories (${data.categoriesCompletedPercentile} percentile range), indicating ${possessive} level of conceptual reasoning and ability to identify abstract sorting principles. ${pronoun_cap} made ${data.totalErrors} total errors (T=${totalErrorsT}), which falls in the ${totalErrorsRange}. ${pronoun_cap} made ${data.perseverativeErrors} perseverative errors (T=${persevErrorsT}), representing ${data.percentPerseverativeErrors}% of total responses, which is in the ${persevErrorsRange}. Overall, these results suggest ${
                        data.categoriesCompleted >= 4 && totalErrorsT >= 45 ? 
                        'adequate executive functioning with good cognitive flexibility' :
                        data.categoriesCompleted <= 2 || totalErrorsT < 35 ?
                        'evidence of executive dysfunction with difficulties in cognitive flexibility' :
                        'mixed executive functioning with some areas of relative difficulty'
                    }.</p>
                </div>
            `;

            return narrative;
        }

        function completeTest() {
            if (!currentNarrative) {
                alert('Please generate the report first.');
                return;
            }

            const results = {
                narrative: currentNarrative,
                scoreTable: currentScoreTable,
                testName: 'Wisconsin Card Sorting Test',
                completedAt: new Date().toISOString()
            };

            window.parent.postMessage({
                type: 'testComplete',
                testName: 'wcst',
                results: results
            }, '*');
        }

        // Listen for client info from parent
        window.addEventListener('message', function(event) {
            if (event.data.type === 'clientInfo') {
                const clientInfo = event.data.data;

                if (clientInfo.clientAge) {
                    document.getElementById('clientAge').value = clientInfo.clientAge;
                }

                if (clientInfo.clientGender) {
                    document.getElementById('clientGender').value = clientInfo.clientGender;
                }

                if (clientInfo.clientEducation) {
                    document.getElementById('clientEducation').value = clientInfo.clientEducation;
                }

                if (clientInfo.readingLevel) {
                    document.getElementById('readingLevel').value = clientInfo.readingLevel;
                }
            }
        });

        // Auto-validate and update calculations on input changes
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input[type="number"], select');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    updateCalculatedValues();
                    validateAllInputs();
                });
                input.addEventListener('change', function() {
                    updateCalculatedValues();
                    validateAllInputs();
                });
            });
            
            // Check database on load
            setTimeout(checkDatabaseAvailability, 500);
        });
    </script>
</body>
</html>
