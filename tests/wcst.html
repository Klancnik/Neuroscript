<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wisconsin Card Sorting Test Clinical Report Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .complete-btn {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-left: 10px;
        }
        .complete-btn:hover {
            background: #1e7e34;
        }
        .output {
            background-color: white;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
        }
        .validation-warnings {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .warning-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }
        .warning-item {
            color: #856404;
            margin-bottom: 5px;
        }
        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-family: Arial, sans-serif;
            font-size: 12px;
        }
        .score-table th, .score-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .score-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        .section-title {
            color: #2c3e50;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Wisconsin Card Sorting Test Clinical Report Generator</h1>
        <p><strong>Based on Heaton et al. (1993) normative data with comprehensive validation warnings</strong></p>

        <div class="section-title">Client Information</div>
        <div class="input-row">
            <div class="input-group">
                <label for="clientGender">Client Gender:</label>
                <select id="clientGender">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="input-group">
                <label for="clientAge">Client Age:</label>
                <input type="number" id="clientAge" min="16" max="89" value="" placeholder="20-89" step="1">
            </div>
            <div class="input-group">
                <label for="clientEducation">Education (years):</label>
                <input type="number" id="clientEducation" min="6" max="20" value="" placeholder="6-20" step="1">
            </div>
        </div>

        <div class="section-title">WCST Raw Scores</div>
        <div class="input-row">
            <div class="input-group">
                <label for="trialsAdmin">Trials Administered:</label>
                <input type="number" id="trialsAdmin" value="" min="1" max="128" placeholder="1-128">
            </div>
            <div class="input-group">
                <label for="totalCorrect">Total Correct:</label>
                <input type="number" id="totalCorrect" value="" min="0" max="128" placeholder="0-128">
            </div>
            <div class="input-group">
                <label for="totalErrors">Total Errors:</label>
                <input type="number" id="totalErrors" value="" min="0" max="128" placeholder="0-128">
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label for="persevResponses">Perseverative Responses:</label>
                <input type="number" id="persevResponses" value="" min="0" max="128" placeholder="0-128">
            </div>
            <div class="input-group">
                <label for="persevErrors">Perseverative Errors:</label>
                <input type="number" id="persevErrors" value="" min="0" max="128" placeholder="0-128">
            </div>
            <div class="input-group">
                <label for="nonpersevErrors">Nonperseverative Errors:</label>
                <input type="number" id="nonpersevErrors" value="" min="0" max="128" placeholder="0-128">
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label for="conceptualResponses">Conceptual Level Responses:</label>
                <input type="number" id="conceptualResponses" value="" min="0" max="128" placeholder="0-128">
            </div>
            <div class="input-group">
                <label for="categoriesCompleted">Categories Completed:</label>
                <input type="number" id="categoriesCompleted" value="" min="0" max="6" placeholder="0-6">
            </div>
            <div class="input-group">
                <label for="trialsFirstCategory">Trials to Complete 1st Category:</label>
                <input type="number" id="trialsFirstCategory" value="" min="1" max="128" placeholder="1-128">
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label for="failureMaintainSet">Failure to Maintain Set:</label>
                <input type="number" id="failureMaintainSet" value="" min="0" max="10" placeholder="0-10">
            </div>
            <div class="input-group">
                <label for="learningToLearn">Learning to Learn:</label>
                <input type="number" id="learningToLearn" value="" min="-5" max="15" step="0.01" placeholder="-5 to 15">
            </div>
            <div class="input-group">
                <label for="readingLevel">Reading Level (grades):</label>
                <input type="number" id="readingLevel" value="" min="1" max="16" step="0.5" placeholder="Optional">
            </div>
        </div>

        <div class="section-title">Normative Reference Scores (from PAR printout)</div>
        <div class="input-row">
            <div class="input-group">
                <label for="totalErrorsT">Total Errors T-score:</label>
                <input type="number" id="totalErrorsT" value="" min="20" max="80" placeholder="20-80">
            </div>
            <div class="input-group">
                <label for="persevErrorsT">Perseverative Errors T-score:</label>
                <input type="number" id="persevErrorsT" value="" min="20" max="80" placeholder="20-80">
            </div>
            <div class="input-group">
                <label for="conceptualT">Conceptual Level Responses T-score:</label>
                <input type="number" id="conceptualT" value="" min="20" max="80" placeholder="20-80">
            </div>
        </div>

        <button onclick="generateReport()">Generate WCST Report</button>
        <button class="complete-btn" onclick="completeTest()">Complete Test</button>

        <div id="validationWarnings" class="validation-warnings" style="display: none;">
            <div class="warning-title">⚠️ Validation Warnings</div>
            <div id="warningsList"></div>
        </div>

        <div id="scoreTable" style="display: none;">
            <div class="section-title">WCST Score Summary Table</div>
            <table class="score-table" id="wcstScoreTable">
                <thead>
                    <tr>
                        <th>WCST Measure</th>
                        <th>Raw Score</th>
                        <th>T-Score</th>
                        <th>Percentile</th>
                        <th>Classification</th>
                    </tr>
                </thead>
                <tbody id="scoreTableBody">
                </tbody>
            </table>
        </div>

        <div class="output" id="output"></div>
    </div>

    <script>
        // Data management
        let currentNarrative = '';
        let currentScoreTable = '';

        // Heaton et al. (1993) T-score to percentile conversion
        const tScoreToPercentile = {
            20: 0.1, 21: 0.1, 22: 0.1, 23: 0.1, 24: 0.2, 25: 0.3, 26: 0.4, 27: 0.5, 28: 0.6, 29: 0.8,
            30: 1, 31: 1, 32: 2, 33: 2, 34: 3, 35: 4, 36: 5, 37: 6, 38: 8, 39: 9,
            40: 11, 41: 13, 42: 16, 43: 18, 44: 21, 45: 25, 46: 29, 47: 34, 48: 39, 49: 45,
            50: 50, 51: 55, 52: 61, 53: 66, 54: 71, 55: 75, 56: 79, 57: 82, 58: 84, 59: 87,
            60: 89, 61: 91, 62: 92, 63: 94, 64: 95, 65: 96, 66: 97, 67: 97, 68: 98, 69: 98,
            70: 99, 71: 99, 72: 99, 73: 99, 74: 99, 75: 99, 76: 99.5, 77: 99.6, 78: 99.7, 79: 99.8, 80: 99.9
        };

        function getPercentileFromT(tScore) {
            const rounded = Math.round(tScore);
            return tScoreToPercentile[rounded] || (rounded < 20 ? 0.1 : 99.9);
        }

        function getHeatonClassification(tScore) {
            if (tScore >= 70) return "Very Superior";
            if (tScore >= 64) return "Superior";
            if (tScore >= 57.5) return "High Average";
            if (tScore >= 45) return "Average";
            if (tScore >= 40) return "Below Average";
            if (tScore >= 35) return "Mildly Impaired";
            if (tScore >= 30) return "Mildly to Moderately Impaired";
            if (tScore >= 25) return "Moderately Impaired";
            if (tScore >= 20) return "Moderately to Severely Impaired";
            return "Severely Impaired";
        }

        function getHeatonWithTScore(tScore) {
            const classification = getHeatonClassification(tScore);
            if (tScore < 40) {
                return `${classification} range (T=${Math.round(tScore)})`;
            } else {
                return `${classification} range`;
            }
        }

        function validateWCSTData() {
            const warnings = [];
            const age = parseInt(document.getElementById('clientAge').value);
            const education = parseInt(document.getElementById('clientEducation').value);
            const readingLevel = parseFloat(document.getElementById('readingLevel').value);
            const totalErrors = parseInt(document.getElementById('totalErrors').value);
            const persevErrors = parseInt(document.getElementById('persevErrors').value);
            const categoriesCompleted = parseInt(document.getElementById('categoriesCompleted').value);
            const trialsFirstCategory = parseInt(document.getElementById('trialsFirstCategory').value);
            const failureMaintainSet = parseInt(document.getElementById('failureMaintainSet').value);
            const totalErrorsT = parseFloat(document.getElementById('totalErrorsT').value);
            const persevErrorsT = parseFloat(document.getElementById('persevErrorsT').value);

            if (age < 20 || age > 89) {
                warnings.push("Client age is outside Heaton et al. (1993) normative range (20-89 years). Use age-matched norms with caution.");
            }

            if (education < 6 || education > 20) {
                warnings.push("Education level is outside typical normative range. Interpret scores cautiously.");
            }

            if (readingLevel < 5) {
                warnings.push("Reading level below 5th grade may compromise test validity. Consider impact on comprehension of instructions.");
            }

            if (totalErrorsT <= 30) {
                warnings.push("Total Errors T-score ≤30 indicates severely impaired executive functioning. Consider effort/validity.");
            }

            if (totalErrorsT >= 70) {
                warnings.push("Total Errors T-score ≥70 indicates exceptionally good performance. Verify administration.");
            }

            if (persevErrorsT <= 30) {
                warnings.push("Perseverative Errors T-score ≤30 suggests significant cognitive inflexibility/set-shifting deficits.");
            }

            if (categoriesCompleted === 0) {
                warnings.push("Zero categories completed suggests severe executive dysfunction or possible poor effort/motivation.");
            }

            if (categoriesCompleted === 6 && trialsFirstCategory > 50) {
                warnings.push("All categories completed but slow initial learning suggests possible working memory issues.");
            }

            if (failureMaintainSet >= 3) {
                warnings.push("Multiple failures to maintain set (≥3) suggests attention/working memory deficits.");
            }

            if (persevErrors > totalErrors * 0.8) {
                warnings.push("Perseverative errors >80% of total errors suggests significant cognitive inflexibility.");
            }

            if (trialsFirstCategory > 25) {
                warnings.push("Trials to first category >25 suggests difficulty with initial concept formation.");
            }

            return warnings;
        }

        function generateReport() {
            // Check if minimum required fields are filled
            const totalErrorsT = document.getElementById('totalErrorsT').value;
            const categoriesCompleted = document.getElementById('categoriesCompleted').value;
            
            if (!totalErrorsT && !categoriesCompleted) {
                document.getElementById('output').textContent = 'Please enter test scores to generate the report.';
                return;
            }

            const gender = document.getElementById('clientGender').value;
            const pronoun = gender === 'male' ? 'he' : 'she';
            const pronounCap = gender === 'male' ? 'He' : 'She';
            const possessive = gender === 'male' ? 'his' : 'her';

            const totalErrors = parseInt(document.getElementById('totalErrors').value) || 0;
            const persevErrors = parseInt(document.getElementById('persevErrors').value) || 0;
            const categoriesCompleted = parseInt(document.getElementById('categoriesCompleted').value) || 0;
            const trialsFirstCategory = parseInt(document.getElementById('trialsFirstCategory').value) || 0;
            const failureMaintainSet = parseInt(document.getElementById('failureMaintainSet').value) || 0;

            const totalErrorsT = parseFloat(document.getElementById('totalErrorsT').value) || 0;
            const persevErrorsT = parseFloat(document.getElementById('persevErrorsT').value) || 0;
            const conceptualT = parseFloat(document.getElementById('conceptualT').value) || 0;

            generateScoreTable();

            let narrative = '';

            if (totalErrorsT >= 40) {
                narrative += `${pronounCap} scored in the ${getHeatonWithTScore(totalErrorsT)} on a non-verbal test of conceptualization and mental flexibility that required ${possessive} to sort cards to changing criteria (WCST). `;
            } else {
                narrative += `${pronounCap} scored in the ${getHeatonWithTScore(totalErrorsT)}, indicating ${getHeatonClassification(totalErrorsT).toLowerCase()} performance, on a non-verbal test of conceptualization and mental flexibility that required ${possessive} to sort cards to changing criteria, with immediate feedback as to error (WCST). `;
            }

            if (trialsFirstCategory <= 15) {
                narrative += `${pronounCap} solved the initial condition easily, `;
            } else if (trialsFirstCategory <= 25) {
                narrative += `${pronounCap} required additional trials to solve the initial sorting condition, `;
            } else {
                narrative += `${pronounCap} was slow in determining the initial solution to the visual reasoning problem, `;
            }

            if (failureMaintainSet === 0) {
                if (categoriesCompleted === 6) {
                    narrative += `and had no difficulty maintaining or switching mental set as appropriate. `;
                } else {
                    narrative += `maintained response set appropriately when established, but had difficulty switching mental set when criteria changed. `;
                }
            } else if (failureMaintainSet <= 2) {
                narrative += `and had some difficulty maintaining response set. `;
            } else {
                narrative += `and had greater than average difficulty in maintaining response set. `;
            }

            if (categoriesCompleted === 6) {
                narrative += `${pronounCap} was able to deduce all sorting rules. `;
            } else if (categoriesCompleted >= 4) {
                narrative += `Over the course of the task, ${pronoun} completed most of the sorting conditions. `;
            } else if (categoriesCompleted >= 2) {
                narrative += `Over the course of the task, ${pronoun} was only able to solve ${categoriesCompleted} of 6 total conditions. `;
            } else if (categoriesCompleted === 1) {
                narrative += `Over the course of the task, ${pronoun} was only able to solve 1 of 6 total conditions. `;
            } else {
                narrative += `${pronounCap} was unable to solve any of the sorting rules beyond the initial condition. `;
            }

            if (persevErrorsT >= 40) {
                narrative += `The total number of errors and the number of both perseverative or repetitive errors and non-perseverative errors was within ${getHeatonClassification(persevErrorsT)} limits relative to age- and education-matched peers. `;
            } else if (persevErrorsT >= 35) {
                narrative += `${pronounCap} showed some tendency toward perseveration (repetition of incorrect response strategies), with perseverative errors in the ${getHeatonWithTScore(persevErrorsT)}. `;
            } else if (persevErrorsT >= 30) {
                narrative += `${pronounCap} showed a moderate degree of perseveration (repetition of incorrect response strategies), with perseverative errors in the ${getHeatonWithTScore(persevErrorsT)}. `;
            } else {
                narrative += `${pronounCap} showed a very high degree of perseveration (repetition of incorrect response strategies), with perseverative errors in the ${getHeatonWithTScore(persevErrorsT)}. `;
            }

            if (totalErrorsT < 45) {
                if (categoriesCompleted === 0) {
                    narrative += `${pronounCap} was unable to solve the initial sorting rule and demonstrated significant cognitive inflexibility. `;
                }

                if (persevErrors > totalErrors * 0.6) {
                    narrative += `The majority of ${possessive} errors were perseverative in nature, suggesting difficulty shifting away from response sets when they were not appropriate. `;
                }
            }

            // Store for completion
            currentNarrative = narrative;

            const warnings = validateWCSTData();

            if (warnings.length > 0) {
                document.getElementById('validationWarnings').style.display = 'block';
                document.getElementById('warningsList').innerHTML = warnings.map(w => `<div class="warning-item">• ${w}</div>`).join('');
            } else {
                document.getElementById('validationWarnings').style.display = 'none';
            }

            document.getElementById('output').textContent = narrative;
        }

        function generateScoreTable() {
            const totalErrors = parseInt(document.getElementById('totalErrors').value) || 0;
            const persevErrors = parseInt(document.getElementById('persevErrors').value) || 0;
            const conceptualResponses = parseInt(document.getElementById('conceptualResponses').value) || 0;

            const totalErrorsT = parseFloat(document.getElementById('totalErrorsT').value) || 0;
            const persevErrorsT = parseFloat(document.getElementById('persevErrorsT').value) || 0;
            const conceptualT = parseFloat(document.getElementById('conceptualT').value) || 0;

            const scores = [
                {
                    measure: 'Total Errors',
                    raw: totalErrors,
                    tScore: totalErrorsT,
                    percentile: getPercentileFromT(totalErrorsT),
                    classification: getHeatonClassification(totalErrorsT)
                },
                {
                    measure: 'Perseverative Errors',
                    raw: persevErrors,
                    tScore: persevErrorsT,
                    percentile: getPercentileFromT(persevErrorsT),
                    classification: getHeatonClassification(persevErrorsT)
                },
                {
                    measure: 'Conceptual Level Responses',
                    raw: conceptualResponses,
                    tScore: conceptualT,
                    percentile: getPercentileFromT(conceptualT),
                    classification: getHeatonClassification(conceptualT)
                }
            ];

            // Store score table for completion
            currentScoreTable = `
                <table border="1" style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                    <tr style="background-color: #f5f5f5;">
                        <th style="padding: 8px; text-align: left;">WCST Measure</th>
                        <th style="padding: 8px; text-align: center;">Raw Score</th>
                        <th style="padding: 8px; text-align: center;">T-Score</th>
                        <th style="padding: 8px; text-align: center;">Percentile</th>
                        <th style="padding: 8px; text-align: center;">Classification</th>
                    </tr>
                    ${scores.map(score => `
                        <tr>
                            <td style="padding: 8px;">${score.measure}</td>
                            <td style="padding: 8px; text-align: center;">${score.raw}</td>
                            <td style="padding: 8px; text-align: center;">${score.tScore}</td>
                            <td style="padding: 8px; text-align: center;">${score.percentile}%</td>
                            <td style="padding: 8px; text-align: center;">${score.classification}</td>
                        </tr>
                    `).join('')}
                </table>
            `;

            const tableBody = document.getElementById('scoreTableBody');
            tableBody.innerHTML = '';

            scores.forEach(score => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = score.measure;
                row.insertCell(1).textContent = score.raw;
                row.insertCell(2).textContent = score.tScore;
                row.insertCell(3).textContent = score.percentile + '%';
                row.insertCell(4).textContent = score.classification;
            });

            document.getElementById('scoreTable').style.display = 'block';
        }

        function completeTest() {
            if (!currentNarrative) {
                alert('Please generate the report first before completing the test.');
                return;
            }

            const results = {
                narrative: currentNarrative,
                scoreTable: currentScoreTable,
                testName: 'Wisconsin Card Sorting Test',
                completedAt: new Date().toISOString()
            };

            window.parent.postMessage({
                type: 'testComplete',
                testName: 'wcst',
                results: results
            }, '*');
        }

        // Listen for client info from parent
        window.addEventListener('message', function(event) {
            if (event.data.type === 'clientInfo') {
                const clientInfo = event.data.data;

                if (clientInfo.clientAge) {
                    document.getElementById('clientAge').value = clientInfo.clientAge;
                }

                if (clientInfo.clientGender) {
                    document.getElementById('clientGender').value = clientInfo.clientGender;
                }

                if (clientInfo.clientEducation) {
                    document.getElementById('clientEducation').value = clientInfo.clientEducation;
                }

                if (clientInfo.readingLevel) {
                    document.getElementById('readingLevel').value = clientInfo.readingLevel;
                }
            }
        });

        // Auto-generate on input changes
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', generateReport);
                input.addEventListener('change', generateReport);
            });
        });
    </script>
</body>
</html>
