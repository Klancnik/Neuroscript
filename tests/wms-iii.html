<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>WMS-III Clinical Report Generator</title>
    <!-- Load shared normative database -->
    <script src="../neuroscript-norms.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="number"], select {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
        .printout-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .printout-table th {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            color: #495057;
        }
        .printout-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            vertical-align: middle;
        }
        .printout-table input {
            width: 80px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        .section-header {
            background: #e9ecef;
            padding: 12px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 15px;
            color: #495057;
            border-left: 4px solid #007bff;
        }
        .generate-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .generate-btn:hover {
            background: #0056b3;
        }
        .complete-btn {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-left: 10px;
        }
        .complete-btn:hover {
            background: #1e7e34;
        }
        .output-section {
            background: white;
            border: 2px solid #dee2e6;
            padding: 25px;
            margin-top: 30px;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }
        h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        .supplemental {
            font-style: italic;
            color: #666;
        }
        .process-score-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .validation-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WMS-III Clinical Report Generator</h1>
        <p>Enter WMS-III scores to generate clinical narrative text in Neuroscript format</p>

        <div class="input-section">
            <h3>Demographics</h3>
            <div class="input-group">
                <label>Age (years):</label>
                <input type="number" id="age" value="" placeholder="16-89" min="16" max="89">
            </div>
            <div class="input-group">
                <label>Gender:</label>
                <select id="gender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="input-group">
                <label>Education (years):</label>
                <input type="number" id="education" value="" placeholder="6-25" min="6" max="25">
            </div>
            <div class="input-group">
                <label>Reading Level (grade):</label>
                <input type="number" id="readingLevel" value="" placeholder="Optional" min="1" max="16" step="0.1">
            </div>

            <div class="section-header">Primary Index Scores</div>
            <table class="printout-table">
                <thead>
                    <tr>
                        <th style="width: 60%">Index</th>
                        <th style="width: 40%">Standard Score</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Auditory Immediate</td>
                        <td><input type="number" id="audiImmediate" placeholder="40-160" min="40" max="160"></td>
                    </tr>
                    <tr>
                        <td>Visual Immediate</td>
                        <td><input type="number" id="visualImmediate" placeholder="40-160" min="40" max="160"></td>
                    </tr>
                    <tr>
                        <td>Immediate Memory</td>
                        <td><input type="number" id="immediateMemory" placeholder="40-160" min="40" max="160"></td>
                    </tr>
                    <tr>
                        <td>Auditory Delayed</td>
                        <td><input type="number" id="audiDelayed" placeholder="40-160" min="40" max="160"></td>
                    </tr>
                    <tr>
                        <td>Visual Delayed</td>
                        <td><input type="number" id="visualDelayed" placeholder="40-160" min="40" max="160"></td>
                    </tr>
                    <tr>
                        <td>Auditory Recognition Delayed</td>
                        <td><input type="number" id="audiRecogDelayed" placeholder="40-160" min="40" max="160"></td>
                    </tr>
                    <tr>
                        <td>General Memory</td>
                        <td><input type="number" id="generalMemory" placeholder="40-160" min="40" max="160"></td>
                    </tr>
                    <tr>
                        <td>Working Memory</td>
                        <td><input type="number" id="workingMemory" placeholder="40-160" min="40" max="160"></td>
                    </tr>
                </tbody>
            </table>

            <div class="section-header">Auditory Memory Subtests</div>
            <table class="printout-table">
                <thead>
                    <tr>
                        <th style="width: 60%">Subtest</th>
                        <th style="width: 40%">Scaled Score</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Logical Memory I</td>
                        <td><input type="number" id="logicalMemory1" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Verbal Paired Associates I</td>
                        <td><input type="number" id="verbalPaired1" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Word Lists I</td>
                        <td><input type="number" id="wordLists1" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Logical Memory II</td>
                        <td><input type="number" id="logicalMemory2" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Verbal Paired Associates II</td>
                        <td><input type="number" id="verbalPaired2" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Word Lists II</td>
                        <td><input type="number" id="wordLists2" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                </tbody>
            </table>

            <div class="section-header">Visual Memory Subtests</div>
            <table class="printout-table">
                <thead>
                    <tr>
                        <th style="width: 60%">Subtest</th>
                        <th style="width: 40%">Scaled Score</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Faces I</td>
                        <td><input type="number" id="faces1" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Family Pictures I</td>
                        <td><input type="number" id="familyPictures1" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Visual Reproduction I</td>
                        <td><input type="number" id="visualRepro1" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Faces II</td>
                        <td><input type="number" id="faces2" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Family Pictures II</td>
                        <td><input type="number" id="familyPictures2" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Visual Reproduction II</td>
                        <td><input type="number" id="visualRepro2" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                </tbody>
            </table>

            <div class="section-header">Working Memory & Attention Subtests</div>
            <table class="printout-table">
                <thead>
                    <tr>
                        <th style="width: 60%">Subtest</th>
                        <th style="width: 40%">Scaled Score</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Digit Span</td>
                        <td><input type="number" id="digitSpan" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Spatial Span</td>
                        <td><input type="number" id="spatialSpan" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td>Letter-Number Sequencing</td>
                        <td><input type="number" id="letterNumber" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                    <tr>
                        <td class="supplemental">Mental Control *</td>
                        <td><input type="number" id="mentalControl" placeholder="1-19" min="1" max="19"></td>
                    </tr>
                </tbody>
            </table>

            <div class="section-header">Process Scores (Optional)</div>
            <div class="process-score-group">
                <div class="checkbox-group">
                    <label>Logical Memory Retention (%):</label>
                    <input type="number" id="logicalMemoryRetention" placeholder="0-100" min="0" max="100">
                </div>
                <div class="checkbox-group">
                    <label>Verbal Paired Associates Retention (%):</label>
                    <input type="number" id="verbalPairedRetention" placeholder="0-100" min="0" max="100">
                </div>
                <div class="checkbox-group">
                    <label>Visual Reproduction Retention (%):</label>
                    <input type="number" id="visualReproRetention" placeholder="0-100" min="0" max="100">
                </div>
                <div class="checkbox-group">
                    <label>Family Pictures Retention (%):</label>
                    <input type="number" id="familyPicturesRetention" placeholder="0-100" min="0" max="100">
                </div>
            </div>

            <button class="generate-btn" onclick="generateReport()">Generate Report</button>
            <button class="complete-btn" onclick="completeTest()">Complete Test</button>
        </div>

        <div id="output" class="output-section" style="display: none;">
            <!-- Generated report will appear here -->
        </div>
    </div>

    <script>
        let currentNarrative = '';
        let currentScoreTable = '';

        // Enhanced database integration functions
        function getIndexInterpretationFromDB(score) {
            try {
                if (!score || score === '') return '';
                return window.NeuroscriptDB.getDetailedInterpretation(score, 'standard');
            } catch (error) {
                console.error('Database error for standard score:', error);
                return 'Average range';
            }
        }

        function getSubtestInterpretationFromDB(score) {
            try {
                if (!score || score === '') return '';
                return window.NeuroscriptDB.getDetailedInterpretation(score, 'wechsler');
            } catch (error) {
                console.error('Database error for Wechsler score:', error);
                return 'Average range';
            }
        }

        // Input validation with enhanced visual feedback
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    const min = parseFloat(this.min);
                    const max = parseFloat(this.max);
                    
                    if (this.value && (isNaN(value) || value < min || value > max)) {
                        this.style.border = '2px solid red';
                        this.style.backgroundColor = '#ffe6e6';
                    } else {
                        this.style.border = '1px solid #ddd';
                        this.style.backgroundColor = 'white';
                    }
                });
            });
        });

        function generateReport() {
            try {
                const data = {
                    age: parseInt(document.getElementById('age').value) || 0,
                    gender: document.getElementById('gender').value || 'Male',
                    education: parseInt(document.getElementById('education').value) || 0,
                    readingLevel: parseFloat(document.getElementById('readingLevel').value) || null,
                    
                    // Primary indices
                    audiImmediate: parseInt(document.getElementById('audiImmediate').value) || null,
                    visualImmediate: parseInt(document.getElementById('visualImmediate').value) || null,
                    immediateMemory: parseInt(document.getElementById('immediateMemory').value) || null,
                    audiDelayed: parseInt(document.getElementById('audiDelayed').value) || null,
                    visualDelayed: parseInt(document.getElementById('visualDelayed').value) || null,
                    audiRecogDelayed: parseInt(document.getElementById('audiRecogDelayed').value) || null,
                    generalMemory: parseInt(document.getElementById('generalMemory').value) || null,
                    workingMemory: parseInt(document.getElementById('workingMemory').value) || null,

                    // Auditory subtests
                    logicalMemory1: parseInt(document.getElementById('logicalMemory1').value) || null,
                    verbalPaired1: parseInt(document.getElementById('verbalPaired1').value) || null,
                    wordLists1: parseInt(document.getElementById('wordLists1').value) || null,
                    logicalMemory2: parseInt(document.getElementById('logicalMemory2').value) || null,
                    verbalPaired2: parseInt(document.getElementById('verbalPaired2').value) || null,
                    wordLists2: parseInt(document.getElementById('wordLists2').value) || null,

                    // Visual subtests
                    faces1: parseInt(document.getElementById('faces1').value) || null,
                    familyPictures1: parseInt(document.getElementById('familyPictures1').value) || null,
                    visualRepro1: parseInt(document.getElementById('visualRepro1').value) || null,
                    faces2: parseInt(document.getElementById('faces2').value) || null,
                    familyPictures2: parseInt(document.getElementById('familyPictures2').value) || null,
                    visualRepro2: parseInt(document.getElementById('visualRepro2').value) || null,

                    // Working memory subtests
                    digitSpan: parseInt(document.getElementById('digitSpan').value) || null,
                    spatialSpan: parseInt(document.getElementById('spatialSpan').value) || null,
                    letterNumber: parseInt(document.getElementById('letterNumber').value) || null,
                    mentalControl: parseInt(document.getElementById('mentalControl').value) || null,

                    // Process scores
                    logicalMemoryRetention: parseInt(document.getElementById('logicalMemoryRetention').value) || null,
                    verbalPairedRetention: parseInt(document.getElementById('verbalPairedRetention').value) || null,
                    visualReproRetention: parseInt(document.getElementById('visualReproRetention').value) || null,
                    familyPicturesRetention: parseInt(document.getElementById('familyPicturesRetention').value) || null
                };

                const pronoun = data.gender === 'Male' ? 'His' : 'Her';
                const pronounLower = data.gender === 'Male' ? 'his' : 'her';
                const pronounObj = data.gender === 'Male' ? 'him' : 'her';

                let report = '';
                let warnings = [];

                // Validation warnings
                if (data.readingLevel && data.readingLevel < 5) {
                    warnings.push(`⚠️ Reading level below 5th grade may affect verbal test performance validity`);
                }
                if (data.age < 16 || data.age > 89) {
                    warnings.push(`⚠️ Age ${data.age} is outside WMS-III normative range (16-89 years)`);
                }

                // Cognitive Functioning Header
                let cognitiveReport = '';
                if (data.generalMemory || data.audiRecogDelayed || data.logicalMemory1 || data.logicalMemory2 || data.verbalPaired1 || data.verbalPaired2 || data.wordLists1 || data.wordLists2 || data.faces1 || data.faces2 || data.familyPictures1 || data.familyPictures2 || data.visualRepro1 || data.visualRepro2 || data.digitSpan || data.spatialSpan || data.letterNumber || data.mentalControl) {
                    cognitiveReport += '<h3>Cognitive Functioning</h3>';
                    
                    // Attention Section (working memory tests first)
                    let attentionContent = '';
                    if (data.digitSpan || data.spatialSpan || data.letterNumber || data.mentalControl) {
                        attentionContent += '<h4>Attention</h4>';
                        if (data.digitSpan) {
                            attentionContent += `<p>On a test requiring ${pronounObj} to recall strings of numbers read aloud (WMS-III Digit Span), ${pronounLower} score fell within the ${getSubtestInterpretationFromDB(data.digitSpan)} (ss=${data.digitSpan}).</p>`;
                        }
                        if (data.spatialSpan) {
                            attentionContent += `<p>On a test of visuospatial working memory requiring recall of spatial sequences (WMS-III Spatial Span), ${pronounLower} score fell within the ${getSubtestInterpretationFromDB(data.spatialSpan)} (ss=${data.spatialSpan}).</p>`;
                        }
                        if (data.letterNumber) {
                            attentionContent += `<p>On a test requiring reordering of intermixed letters and numbers (WMS-III Letter-Number Sequencing), ${pronounLower} score fell within the ${getSubtestInterpretationFromDB(data.letterNumber)} (ss=${data.letterNumber}).</p>`;
                        }
                        if (data.mentalControl) {
                            attentionContent += `<p>${pronoun} performance on mental control tasks requiring automatic cognitive processes (WMS-III Mental Control) was within the ${getSubtestInterpretationFromDB(data.mentalControl)} (ss=${data.mentalControl}).</p>`;
                        }
                    }

                    // Memory Section with Index Scores
                    let memoryContent = '';
                    if (data.generalMemory || data.audiRecogDelayed || data.logicalMemory1 || data.logicalMemory2 || data.verbalPaired1 || data.verbalPaired2 || data.wordLists1 || data.wordLists2 || data.faces1 || data.faces2 || data.familyPictures1 || data.familyPictures2 || data.visualRepro1 || data.visualRepro2) {
                        memoryContent += '<h4>Memory</h4>';
                        
                        // Index scores first - only General Memory and Recognition Memory
                        if (data.generalMemory) {
                            memoryContent += `<p>${pronoun} general memory abilities, as measured by the WMS-III General Memory Index, fell within the ${getIndexInterpretationFromDB(data.generalMemory)} (Index score = ${data.generalMemory}).</p>`;
                        }
                        if (data.audiRecogDelayed) {
                            const recognitionQuality = data.audiRecogDelayed < 85 ? 'impaired' : 'intact';
                            memoryContent += `<p>${pronoun} auditory recognition memory, as measured by the WMS-III Auditory Recognition Delayed Index, fell within the ${getIndexInterpretationFromDB(data.audiRecogDelayed)} (Index score = ${data.audiRecogDelayed}), suggesting ${recognitionQuality} ability to recognize previously heard information when multiple-choice format is provided.</p>`;
                        }

                        // Logical Memory (simplified format with test name)
                        if (data.logicalMemory1 || data.logicalMemory2) {
                            if (data.logicalMemory1 && data.logicalMemory2) {
                                const lm1Range = getSubtestInterpretationFromDB(data.logicalMemory1);
                                const lm2Range = getSubtestInterpretationFromDB(data.logicalMemory2);
                                if (lm1Range === lm2Range) {
                                    memoryContent += `<p>Recall of prose passages (WMS-III Logical Memory) was in the ${lm1Range} under both immediate (ss=${data.logicalMemory1}) and delayed (ss=${data.logicalMemory2}) conditions`;
                                } else {
                                    memoryContent += `<p>Recall of prose passages (WMS-III Logical Memory) was in the ${lm1Range} (ss=${data.logicalMemory1}) under immediate conditions, and in the ${lm2Range} (ss=${data.logicalMemory2}) under delayed conditions`;
                                }
                                if (data.logicalMemoryRetention) {
                                    memoryContent += `, with ${data.logicalMemoryRetention}% retention over the delay interval`;
                                }
                                memoryContent += `.</p>`;
                            } else if (data.logicalMemory1) {
                                memoryContent += `<p>Recall of prose passages (WMS-III Logical Memory) was in the ${getSubtestInterpretationFromDB(data.logicalMemory1)} (ss=${data.logicalMemory1}) under immediate conditions.</p>`;
                            } else if (data.logicalMemory2) {
                                memoryContent += `<p>Recall of prose passages (WMS-III Logical Memory) was in the ${getSubtestInterpretationFromDB(data.logicalMemory2)} (ss=${data.logicalMemory2}) under delayed conditions.</p>`;
                            }
                        }

                        // Verbal Paired Associates (simplified format with test name)
                        if (data.verbalPaired1 || data.verbalPaired2) {
                            if (data.verbalPaired1 && data.verbalPaired2) {
                                const vp1Range = getSubtestInterpretationFromDB(data.verbalPaired1);
                                const vp2Range = getSubtestInterpretationFromDB(data.verbalPaired2);
                                if (vp1Range === vp2Range) {
                                    memoryContent += `<p>${pronoun} ability to learn word pairs (WMS-III Verbal Paired Associates) was in the ${vp1Range} under both immediate (ss=${data.verbalPaired1}) and delayed (ss=${data.verbalPaired2}) conditions`;
                                } else {
                                    memoryContent += `<p>${pronoun} ability to learn word pairs (WMS-III Verbal Paired Associates) was in the ${vp1Range} (ss=${data.verbalPaired1}) under immediate conditions, and in the ${vp2Range} (ss=${data.verbalPaired2}) under delayed conditions`;
                                }
                                if (data.verbalPairedRetention) {
                                    memoryContent += `, with ${data.verbalPairedRetention}% retention`;
                                }
                                memoryContent += `.</p>`;
                            } else if (data.verbalPaired1) {
                                memoryContent += `<p>${pronoun} ability to learn word pairs (WMS-III Verbal Paired Associates) was in the ${getSubtestInterpretationFromDB(data.verbalPaired1)} (ss=${data.verbalPaired1}) under immediate conditions.</p>`;
                            } else if (data.verbalPaired2) {
                                memoryContent += `<p>${pronoun} ability to learn word pairs (WMS-III Verbal Paired Associates) was in the ${getSubtestInterpretationFromDB(data.verbalPaired2)} (ss=${data.verbalPaired2}) under delayed conditions.</p>`;
                            }
                        }

                        // Word Lists (simplified format with test name)
                        if (data.wordLists1 || data.wordLists2) {
                            if (data.wordLists1 && data.wordLists2) {
                                const wl1Range = getSubtestInterpretationFromDB(data.wordLists1);
                                const wl2Range = getSubtestInterpretationFromDB(data.wordLists2);
                                if (wl1Range === wl2Range) {
                                    memoryContent += `<p>${pronoun} ability to learn word lists (WMS-III Word Lists) was in the ${wl1Range} under both immediate (ss=${data.wordLists1}) and delayed (ss=${data.wordLists2}) conditions.</p>`;
                                } else {
                                    memoryContent += `<p>${pronoun} ability to learn word lists (WMS-III Word Lists) was in the ${wl1Range} (ss=${data.wordLists1}) under immediate conditions, and in the ${wl2Range} (ss=${data.wordLists2}) under delayed conditions.</p>`;
                                }
                            } else if (data.wordLists1) {
                                memoryContent += `<p>${pronoun} ability to learn word lists (WMS-III Word Lists) was in the ${getSubtestInterpretationFromDB(data.wordLists1)} (ss=${data.wordLists1}) under immediate conditions.</p>`;
                            } else if (data.wordLists2) {
                                memoryContent += `<p>${pronoun} ability to learn word lists (WMS-III Word Lists) was in the ${getSubtestInterpretationFromDB(data.wordLists2)} (ss=${data.wordLists2}) under delayed conditions.</p>`;
                            }
                        }

                        // Faces (simplified format with test name)
                        if (data.faces1 || data.faces2) {
                            if (data.faces1 && data.faces2) {
                                const f1Range = getSubtestInterpretationFromDB(data.faces1);
                                const f2Range = getSubtestInterpretationFromDB(data.faces2);
                                if (f1Range === f2Range) {
                                    memoryContent += `<p>${pronoun} ability to recognize faces (WMS-III Faces) was in the ${f1Range} under both immediate (ss=${data.faces1}) and delayed (ss=${data.faces2}) conditions.</p>`;
                                } else {
                                    memoryContent += `<p>${pronoun} ability to recognize faces (WMS-III Faces) was in the ${f1Range} (ss=${data.faces1}) under immediate conditions, and in the ${f2Range} (ss=${data.faces2}) under delayed conditions.</p>`;
                                }
                            } else if (data.faces1) {
                                memoryContent += `<p>${pronoun} ability to recognize faces (WMS-III Faces) was in the ${getSubtestInterpretationFromDB(data.faces1)} (ss=${data.faces1}) under immediate conditions.</p>`;
                            } else if (data.faces2) {
                                memoryContent += `<p>${pronoun} ability to recognize faces (WMS-III Faces) was in the ${getSubtestInterpretationFromDB(data.faces2)} (ss=${data.faces2}) under delayed conditions.</p>`;
                            }
                        }

                        // Family Pictures (simplified format with test name)
                        if (data.familyPictures1 || data.familyPictures2) {
                            if (data.familyPictures1 && data.familyPictures2) {
                                const fp1Range = getSubtestInterpretationFromDB(data.familyPictures1);
                                const fp2Range = getSubtestInterpretationFromDB(data.familyPictures2);
                                if (fp1Range === fp2Range) {
                                    memoryContent += `<p>${pronoun} ability to recall details from complex visual scenes (WMS-III Family Pictures) was in the ${fp1Range} under both immediate (ss=${data.familyPictures1}) and delayed (ss=${data.familyPictures2}) conditions`;
                                } else {
                                    memoryContent += `<p>${pronoun} ability to recall details from complex visual scenes (WMS-III Family Pictures) was in the ${fp1Range} (ss=${data.familyPictures1}) under immediate conditions, and in the ${fp2Range} (ss=${data.familyPictures2}) under delayed conditions`;
                                }
                                if (data.familyPicturesRetention) {
                                    memoryContent += `, with ${data.familyPicturesRetention}% retention`;
                                }
                                memoryContent += `.</p>`;
                            } else if (data.familyPictures1) {
                                memoryContent += `<p>${pronoun} ability to recall details from complex visual scenes (WMS-III Family Pictures) was in the ${getSubtestInterpretationFromDB(data.familyPictures1)} (ss=${data.familyPictures1}) under immediate conditions.</p>`;
                            } else if (data.familyPictures2) {
                                memoryContent += `<p>${pronoun} ability to recall details from complex visual scenes (WMS-III Family Pictures) was in the ${getSubtestInterpretationFromDB(data.familyPictures2)} (ss=${data.familyPictures2}) under delayed conditions.</p>`;
                            }
                        }

                        // Visual Reproduction (simplified format with test name)
                        if (data.visualRepro1 || data.visualRepro2) {
                            if (data.visualRepro1 && data.visualRepro2) {
                                const vr1Range = getSubtestInterpretationFromDB(data.visualRepro1);
                                const vr2Range = getSubtestInterpretationFromDB(data.visualRepro2);
                                if (vr1Range === vr2Range) {
                                    memoryContent += `<p>${pronoun} ability to reproduce geometric designs from memory (WMS-III Visual Reproduction) was in the ${vr1Range} under both immediate (ss=${data.visualRepro1}) and delayed (ss=${data.visualRepro2}) conditions`;
                                } else {
                                    memoryContent += `<p>${pronoun} ability to reproduce geometric designs from memory (WMS-III Visual Reproduction) was in the ${vr1Range} (ss=${data.visualRepro1}) under immediate conditions, and in the ${vr2Range} (ss=${data.visualRepro2}) under delayed conditions`;
                                }
                                if (data.visualReproRetention) {
                                    memoryContent += `, with ${data.visualReproRetention}% retention`;
                                }
                                memoryContent += `.</p>`;
                            } else if (data.visualRepro1) {
                                memoryContent += `<p>${pronoun} ability to reproduce geometric designs from memory (WMS-III Visual Reproduction) was in the ${getSubtestInterpretationFromDB(data.visualRepro1)} (ss=${data.visualRepro1}) under immediate conditions.</p>`;
                            } else if (data.visualRepro2) {
                                memoryContent += `<p>${pronoun} ability to reproduce geometric designs from memory (WMS-III Visual Reproduction) was in the ${getSubtestInterpretationFromDB(data.visualRepro2)} (ss=${data.visualRepro2}) under delayed conditions.</p>`;
                            }
                        }
                    }

                    if (attentionContent) {
                        cognitiveReport += attentionContent;
                    }
                    if (memoryContent) {
                        cognitiveReport += memoryContent;
                    }
                }

                // Compile final report
                if (cognitiveReport) {
                    report += cognitiveReport;
                } else {
                    report = '<p>No tests were entered for analysis. Please complete at least one WMS-III subtest or index score.</p>';
                }

                // Store current narrative and score table
                currentNarrative = report.replace(/<[^>]*>/g, '').trim();
                
                // Create score table for reporting
                const completedTests = [];
                if (data.audiImmediate) completedTests.push(['Auditory Immediate Index', data.audiImmediate, getIndexInterpretationFromDB(data.audiImmediate)]);
                if (data.visualImmediate) completedTests.push(['Visual Immediate Index', data.visualImmediate, getIndexInterpretationFromDB(data.visualImmediate)]);
                if (data.immediateMemory) completedTests.push(['Immediate Memory Index', data.immediateMemory, getIndexInterpretationFromDB(data.immediateMemory)]);
                if (data.audiDelayed) completedTests.push(['Auditory Delayed Index', data.audiDelayed, getIndexInterpretationFromDB(data.audiDelayed)]);
                if (data.visualDelayed) completedTests.push(['Visual Delayed Index', data.visualDelayed, getIndexInterpretationFromDB(data.visualDelayed)]);
                if (data.generalMemory) completedTests.push(['General Memory Index', data.generalMemory, getIndexInterpretationFromDB(data.generalMemory)]);
                if (data.workingMemory) completedTests.push(['Working Memory Index', data.workingMemory, getIndexInterpretationFromDB(data.workingMemory)]);
                
                // Add subtests to table
                if (data.logicalMemory1) completedTests.push(['Logical Memory I', data.logicalMemory1, getSubtestInterpretationFromDB(data.logicalMemory1)]);
                if (data.logicalMemory2) completedTests.push(['Logical Memory II', data.logicalMemory2, getSubtestInterpretationFromDB(data.logicalMemory2)]);
                if (data.verbalPaired1) completedTests.push(['Verbal Paired Associates I', data.verbalPaired1, getSubtestInterpretationFromDB(data.verbalPaired1)]);
                if (data.verbalPaired2) completedTests.push(['Verbal Paired Associates II', data.verbalPaired2, getSubtestInterpretationFromDB(data.verbalPaired2)]);
                if (data.wordLists1) completedTests.push(['Word Lists I', data.wordLists1, getSubtestInterpretationFromDB(data.wordLists1)]);
                if (data.wordLists2) completedTests.push(['Word Lists II', data.wordLists2, getSubtestInterpretationFromDB(data.wordLists2)]);
                if (data.faces1) completedTests.push(['Faces I', data.faces1, getSubtestInterpretationFromDB(data.faces1)]);
                if (data.faces2) completedTests.push(['Faces II', data.faces2, getSubtestInterpretationFromDB(data.faces2)]);
                if (data.familyPictures1) completedTests.push(['Family Pictures I', data.familyPictures1, getSubtestInterpretationFromDB(data.familyPictures1)]);
                if (data.familyPictures2) completedTests.push(['Family Pictures II', data.familyPictures2, getSubtestInterpretationFromDB(data.familyPictures2)]);
                if (data.visualRepro1) completedTests.push(['Visual Reproduction I', data.visualRepro1, getSubtestInterpretationFromDB(data.visualRepro1)]);
                if (data.visualRepro2) completedTests.push(['Visual Reproduction II', data.visualRepro2, getSubtestInterpretationFromDB(data.visualRepro2)]);
                if (data.digitSpan) completedTests.push(['Digit Span', data.digitSpan, getSubtestInterpretationFromDB(data.digitSpan)]);
                if (data.spatialSpan) completedTests.push(['Spatial Span', data.spatialSpan, getSubtestInterpretationFromDB(data.spatialSpan)]);
                if (data.letterNumber) completedTests.push(['Letter-Number Sequencing', data.letterNumber, getSubtestInterpretationFromDB(data.letterNumber)]);
                if (data.mentalControl) completedTests.push(['Mental Control', data.mentalControl, getSubtestInterpretationFromDB(data.mentalControl)]);

                currentScoreTable = `
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <tr style="background-color: #f8f9fa;">
                            <th style="border: 1px solid #dee2e6; padding: 8px; text-align: left;">Test/Index</th>
                            <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">Score</th>
                            <th style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">Interpretation</th>
                        </tr>
                        ${completedTests.map(test => `
                            <tr>
                                <td style="border: 1px solid #dee2e6; padding: 8px;">${test[0]}</td>
                                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">${test[1]}</td>
                                <td style="border: 1px solid #dee2e6; padding: 8px; text-align: center;">${test[2]}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;

                // Display the report
                document.getElementById('output').innerHTML = report + currentScoreTable;

                // Add validation warnings if any
                if (warnings.length > 0) {
                    document.getElementById('output').innerHTML += `<div class="validation-warning">`;
                    document.getElementById('output').innerHTML += `<h4><b>⚠️ Validation Alerts</b></h4>`;
                    warnings.forEach(warning => {
                        document.getElementById('output').innerHTML += `<p style="margin: 5px 0;">${warning}</p>`;
                    });
                    document.getElementById('output').innerHTML += `</div>`;
                }

                document.getElementById('output').style.display = 'block';

            } catch (error) {
                console.error('Error generating WMS-III report:', error);
                document.getElementById('output').innerHTML = `<p><strong>Error generating report:</strong> ${error.message}</p>`;
                document.getElementById('output').style.display = 'block';
            }
        }

        function completeTest() {
            if (!currentNarrative) {
                alert('Please generate the report first before completing the test.');
                return;
            }

            const results = {
                narrative: currentNarrative,
                scoreTable: currentScoreTable,
                testName: 'WMS-III',
                completedAt: new Date().toISOString()
            };

            try {
                window.parent.postMessage({
                    type: 'testComplete',
                    testName: 'wms-iii',
                    results: results
                }, '*');
                alert('WMS-III test completed successfully!');
            } catch (e) {
                console.log('Could not communicate with parent window:', e);
                alert('Test completed locally!');
            }
        }

        // Enhanced client demographics population
        window.addEventListener('message', function(event) {
            if (event.data.type === 'clientInfo') {
                const clientData = event.data.data;
                console.log('WMS-III received client data:', clientData);

                // Handle age field (multiple possible field names)
                if (clientData.age) {
                    document.getElementById('age').value = clientData.age;
                } else if (clientData.clientAge) {
                    document.getElementById('age').value = clientData.clientAge;
                }

                // Handle gender field with case sensitivity
                if (clientData.gender) {
                    document.getElementById('gender').value = clientData.gender;
                } else if (clientData.clientGender) {
                    const genderValue = clientData.clientGender.charAt(0).toUpperCase() + 
                                       clientData.clientGender.slice(1).toLowerCase();
                    document.getElementById('gender').value = genderValue;
                }

                // Handle education field
                if (clientData.education) {
                    document.getElementById('education').value = clientData.education;
                } else if (clientData.clientEducation) {
                    document.getElementById('education').value = clientData.clientEducation;
                }

                // Handle reading level field
                if (clientData.readingLevel) {
                    document.getElementById('readingLevel').value = clientData.readingLevel;
                }

                console.log('WMS-III demographics populated successfully');
            }
        });

        // Database loading verification
        window.addEventListener('load', function() {
            console.log('WMS-III: Checking database connection...');
            if (typeof window.NeuroscriptDB === 'undefined') {
                console.error('WMS-III: External database not loaded!');
            } else {
                console.log('WMS-III: Database loaded successfully');
                try {
                    const testConversion = window.NeuroscriptDB.getDetailedInterpretation(100, 'standard');
                    console.log('WMS-III: Database test conversion:', testConversion);
                } catch (error) {
                    console.error('WMS-III: Database test failed:', error);
                }
            }
        });
    </script>
</body>
</html>
