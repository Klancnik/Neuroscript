<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVLT-3 Clinical Text Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .section-header {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .generate-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .generate-btn:hover {
            background: #0056b3;
        }
        .complete-btn {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-left: 10px;
        }
        .complete-btn:hover {
            background: #1e7e34;
        }
        .output-section {
            background: white;
            border: 2px solid #dee2e6;
            padding: 25px;
            margin-top: 30px;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }
        h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CVLT-3 Clinical Text Generator</h1>
        <p>Enter CVLT-3 scores to generate clinical narrative text in Neuroscript format</p>

        <div class="input-section">
            <h3>Demographics</h3>
            <div class="input-group">
                <label>Gender:</label>
                <select id="gender">
                    <option value="Male" selected>Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="input-group">
                <label>Reading Level (grade):</label>
                <input type="number" id="readingLevel" value="" placeholder="Optional" min="1" max="16" step="0.1">
            </div>

            <div class="section-header">Learning Trials (Raw Scores)</div>
            <div class="score-grid">
                <div>
                    <label>Trial 1:</label>
                    <input type="number" id="trial1" value="2" min="0" max="16">
                </div>
                <div>
                    <label>Trial 2:</label>
                    <input type="number" id="trial2" value="6" min="0" max="16">
                </div>
                <div>
                    <label>Trial 3:</label>
                    <input type="number" id="trial3" value="9" min="0" max="16">
                </div>
                <div>
                    <label>Trial 4:</label>
                    <input type="number" id="trial4" value="8" min="0" max="16">
                </div>
                <div>
                    <label>Trial 5:</label>
                    <input type="number" id="trial5" value="8" min="0" max="16">
                </div>
                <div>
                    <label>List B:</label>
                    <input type="number" id="listB" value="5" min="0" max="16">
                </div>
            </div>

            <div class="section-header">Delayed Recall (Raw Scores)</div>
            <div class="score-grid">
                <div>
                    <label>Short Delay Free:</label>
                    <input type="number" id="shortFree" value="4" min="0" max="16">
                </div>
                <div>
                    <label>Short Delay Cued:</label>
                    <input type="number" id="shortCued" value="8" min="0" max="16">
                </div>
                <div>
                    <label>Long Delay Free:</label>
                    <input type="number" id="longFree" value="4" min="0" max="16">
                </div>
                <div>
                    <label>Long Delay Cued:</label>
                    <input type="number" id="longCued" value="4" min="0" max="16">
                </div>
            </div>

            <div class="section-header">Recognition & Errors</div>
            <div class="score-grid">
                <div>
                    <label>Recognition Hits:</label>
                    <input type="number" id="recogHits" value="15" min="0" max="16">
                </div>
                <div>
                    <label>False Positives:</label>
                    <input type="number" id="falsePos" value="14" min="0" max="48">
                </div>
                <div>
                    <label>Total Intrusions:</label>
                    <input type="number" id="intrusions" value="14" min="0">
                </div>
                <div>
                    <label>Forced Choice:</label>
                    <input type="number" id="forcedChoice" value="16" min="0" max="16">
                </div>
            </div>

            <div class="section-header">Index Scores (Standard Scores)</div>
            <div class="score-grid">
                <div>
                    <label>Trials 1-5 Total:</label>
                    <input type="number" id="trials15Total" value="76" min="40" max="160">
                </div>
                <div>
                    <label>Delayed Recall:</label>
                    <input type="number" id="delayedIndex" value="72" min="40" max="160">
                </div>
                <div>
                    <label>Total Recall:</label>
                    <input type="number" id="totalRecall" value="75" min="40" max="160">
                </div>
            </div>

            <div class="section-header">Process Scores (Percentiles)</div>
            <div class="score-grid">
                <div>
                    <label>Semantic Clustering (%):</label>
                    <input type="number" id="clustering" value="9" min="0" max="100">
                </div>
                <div>
                    <label>Primacy Effect (%):</label>
                    <input type="number" id="primacy" value="9" min="0" max="100" step="0.1">
                </div>
                <div>
                    <label>Recency Effect (%):</label>
                    <input type="number" id="recency" value="91" min="0" max="100" step="0.1">
                </div>
                <div>
                    <label>Learning Slope (%):</label>
                    <input type="number" id="learningSlope" value="50" min="0" max="100">
                </div>
            </div>

            <button class="generate-btn" onclick="generateCVLTText()">Generate CVLT-3 Text</button>
            <button class="complete-btn" onclick="completeTest()">Complete Test</button>
        </div>

        <div id="output" class="output-section" style="display:none;">
            <!-- Generated text will appear here -->
        </div>
    </div>

    <script>
        // Data management
        let currentNarrative = '';
        let currentScoreTable = '';

        function getStandardRange(score) {
            if (score >= 130) return "Very Superior";
            if (score >= 120) return "Superior";
            if (score >= 110) return "High Average";
            if (score >= 90) return "Average";
            if (score >= 80) return "Low Average";
            if (score >= 70) return "Below Average";
            if (score >= 55) return "Mildly Impaired";
            if (score >= 40) return "Moderately Impaired";
            return "Severely Impaired";
        }

        function getScaledRange(score) {
            if (score >= 16) return "Very Superior";
            if (score >= 14) return "Superior";
            if (score >= 12) return "High Average";
            if (score >= 8) return "Average";
            if (score >= 6) return "Low Average";
            if (score >= 4) return "Below Average";
            if (score >= 2) return "Mildly Impaired";
            return "Moderately Impaired";
        }

        function describeLearningSlope(trial1, trial5, percentile) {
            const improvement = trial5 - trial1;
            if (percentile >= 25) return "good";
            if (percentile >= 10) return "average";
            if (improvement <= 0) return "flat, showing no improvement";
            return "poor";
        }

        function describeRecallPattern(primacy, recency) {
            if (recency >= 75 && primacy <= 25) {
                return "He showed a marked recency effect, being better able to recall words from the end of the list than from the beginning or middle.";
            }
            if (primacy >= 75 && recency <= 25) {
                return "He showed a primacy effect, being better able to recall words from the beginning of the list.";
            }
            return "";
        }

        function describeClustering(percentile) {
            if (percentile >= 50) return "He made good use of a strategy of organizing words by meaning for better learning.";
            if (percentile <= 10) return "He made little use of semantic clustering strategies for learning.";
            return "He made some use of organizing words by meaning for learning.";
        }

        function describeCuingEffect(shortFree, shortCued, longFree, longCued) {
            const shortImprovement = shortCued > shortFree;
            const longImprovement = longCued > longFree;
            
            if (shortImprovement || longImprovement) {
                return "Delayed recall was improved by cuing.";
            } else if (shortCued === shortFree && longCued === longFree) {
                return "Delayed recall did not improve with cuing.";
            } else {
                return "Cuing had minimal effect on delayed recall.";
            }
        }

        function describeRecognition(hits, falsePos, forcedChoice, data) {
            const isImplausible = checkImplausiblePattern(hits, falsePos, forcedChoice, data);
            
            if (hits >= 15 && falsePos <= 2 && !isImplausible) {
                return "Performance on yes/no recognition memory trials was flawless.";
            }
            
            if (hits >= 12 && falsePos <= 5 && !isImplausible) {
                return "Performance on yes/no recognition memory trials was good.";
            }
            
            if (hits >= 8 && falsePos <= 10 && !isImplausible) {
                return "Performance on yes/no recognition memory trials was impaired.";
            }
            
            let description = `On yes/no recognition memory trials, ${getGenderPronoun('he')} correctly identified ${hits} out of 16 items, and made ${falsePos} false positive errors.`;
            
            if (isImplausible) {
                if (falsePos >= 15) {
                    description += ` This level of false positive errors occurs in less than 2% of genuinely impaired individuals and raises questions about the validity of the performance.`;
                }
                
                if (forcedChoice <= 8) {
                    const accuracy = Math.round((forcedChoice / 16) * 100);
                    description += ` ${getGenderPronoun('His')} accuracy rate was ${accuracy}% on forced-choice recognition, which is at or below chance level and extremely unusual even in severe memory impairment.`;
                    
                    const maxPreviousRecall = Math.max(data.trial1, data.trial2, data.trial3, data.trial4, data.trial5, data.shortFree, data.longFree);
                    if (forcedChoice < maxPreviousRecall || forcedChoice < hits) {
                        description += ` Of particular concern, ${getGenderPronoun('he')} failed to recognize words on forced-choice testing that had been previously recalled or recognized, which is extremely implausible.`;
                    }
                } else if (forcedChoice < 12) {
                    const accuracy = Math.round((forcedChoice / 16) * 100);
                    description += ` ${getGenderPronoun('His')} accuracy rate was only ${accuracy}% on forced-choice recognition, where any errors are highly unusual.`;
                }
            } else if (forcedChoice < 12) {
                const accuracy = Math.round((forcedChoice / 16) * 100);
                description += ` ${getGenderPronoun('His')} accuracy rate was only ${accuracy}% on forced-choice recognition, where any errors are highly unusual.`;
            }
            
            return description;
        }

        function checkImplausiblePattern(hits, falsePos, forcedChoice, data) {
            const excessiveFalsePositives = falsePos >= 15;
            const belowChanceForcedChoice = forcedChoice <= 8;
            const forcedChoiceBelowRecall = forcedChoice < Math.max(data.trial1, data.trial2, data.trial3, data.trial4, data.trial5);
            const forcedChoiceBelowRecognition = forcedChoice < hits;
            
            return excessiveFalsePositives || belowChanceForcedChoice || forcedChoiceBelowRecall || forcedChoiceBelowRecognition;
        }

        function getGenderPronoun(type) {
            const gender = document.getElementById('gender').value;
            const pronouns = {
                'Male': {
                    'he': 'he', 'He': 'He', 'his': 'his', 'His': 'His', 'him': 'him'
                },
                'Female': {
                    'he': 'she', 'He': 'She', 'his': 'her', 'His': 'Her', 'him': 'her'
                }
            };
            return pronouns[gender][type] || type;
        }

        function getPercentileFromRaw(rawScore, context) {
            if (context === 'trial1') {
                const trial1Percentiles = { 0: 0.1, 1: 0.5, 2: 2, 3: 5, 4: 9, 5: 16, 6: 25, 7: 37, 8: 50, 9: 63, 10: 75, 11: 84, 12: 91, 13: 95, 14: 98, 15: 99, 16: 99.5 };
                return trial1Percentiles[rawScore] || 50;
            }
            
            if (context === 'delayed') {
                const delayedPercentiles = { 0: 0.1, 1: 1, 2: 2, 3: 5, 4: 9, 5: 16, 6: 25, 7: 37, 8: 50, 9: 63, 10: 75, 11: 84, 12: 91, 13: 95, 14: 98, 15: 99, 16: 99.5 };
                return delayedPercentiles[rawScore] || 50;
            }
            
            return 50;
        }

        function getRangeFromPercentile(percentile) {
            let range = "";
            let heaton = "";
            
            if (percentile >= 98) range = "Very Superior";
            else if (percentile >= 91) range = "Superior";
            else if (percentile >= 75) range = "High Average";
            else if (percentile >= 25) range = "Average";
            else if (percentile >= 9) range = "Low Average";
            else if (percentile >= 2) range = "Below Average";
            else range = "Extremely Low";
            
            if (percentile >= 7 && percentile <= 15) {
                heaton = ", indicating a Mild level of impairment";
            } else if (percentile >= 2 && percentile <= 6) {
                heaton = ", indicating a Mild to Moderate level of impairment";
            } else if (percentile >= 0.6 && percentile <= 1.9) {
                heaton = ", indicating a Moderate level of impairment";
            } else if (percentile >= 0.1 && percentile <= 0.5) {
                heaton = ", indicating a Moderate to Severe level of impairment";
            } else if (percentile < 0.1) {
                heaton = ", indicating a Severe level of impairment";
            }
            
            return range + heaton;
        }

        function getStandardRangeWithHeaton(score) {
            let range = getStandardRange(score);
            let heaton = "";
            
            const percentile = getPercentile(score);
            
            if (percentile >= 7 && percentile <= 15) {
                heaton = ", indicating a Mild level of impairment";
            } else if (percentile >= 2 && percentile <= 6) {
                heaton = ", indicating a Mild to Moderate level of impairment";
            } else if (percentile >= 0.6 && percentile <= 1.9) {
                heaton = ", indicating a Moderate level of impairment";
            } else if (percentile >= 0.1 && percentile <= 0.5) {
                heaton = ", indicating a Moderate to Severe level of impairment";
            } else if (percentile < 0.1) {
                heaton = ", indicating a Severe level of impairment";
            }
            
            return range + heaton;
        }

        function getPercentile(score) {
            if (score >= 130) return 98;
            if (score >= 120) return 91;
            if (score >= 110) return 75;
            if (score >= 100) return 50;
            if (score >= 90) return 25;
            if (score >= 80) return 9;
            if (score >= 70) return 2;
            return 0.5;
        }

        function generateValidationWarnings(data) {
            let warnings = [];
            
            if (data.falsePos >= 15) {
                warnings.push("⚠️ Excessive false positives (≥15) occur in <2% of genuinely impaired individuals - validity concerns");
            }
            
            if (data.forcedChoice <= 8) {
                warnings.push("⚠️ Forced choice at/below chance level (≤8/16) - extremely implausible pattern");
            }
            
            const maxPreviousRecall = Math.max(data.trial1, data.trial2, data.trial3, data.trial4, data.trial5,
                                               data.shortFree, data.longFree, data.recogHits);
            if (data.forcedChoice < maxPreviousRecall) {
                warnings.push("⚠️ Forced choice performance below previously recalled/recognized items - implausible pattern");
            }
            
            if (data.intrusions > 20) {
                warnings.push("⚠️ Excessive intrusions (>20) - consider validity or severe impairment");
            }
            
            if (data.trial5 <= data.trial1) {
                warnings.push("⚠️ Flat or negative learning slope - consider effort or severe impairment");
            }
            
            if (!data.readingLevel) {
                warnings.push("⚠️ Reading level not assessed - may affect comprehension of verbal instructions");
            } else if (data.readingLevel < 5) {
                warnings.push("⚠️ Grade <5 reading level - verbal instruction comprehension may be compromised");
            }
            
            if (data.trials15Total < 55) {
                warnings.push("⚠️ Pervasively low performance - consider effort, hearing, or comprehension factors");
            }
            
            return warnings;
        }

        function generateCVLTText() {
            const data = {
                gender: document.getElementById('gender').value,
                readingLevel: document.getElementById('readingLevel').value ? parseFloat(document.getElementById('readingLevel').value) : null,
                trial1: parseInt(document.getElementById('trial1').value),
                trial2: parseInt(document.getElementById('trial2').value),
                trial3: parseInt(document.getElementById('trial3').value),
                trial4: parseInt(document.getElementById('trial4').value),
                trial5: parseInt(document.getElementById('trial5').value),
                listB: parseInt(document.getElementById('listB').value),
                shortFree: parseInt(document.getElementById('shortFree').value),
                shortCued: parseInt(document.getElementById('shortCued').value),
                longFree: parseInt(document.getElementById('longFree').value),
                longCued: parseInt(document.getElementById('longCued').value),
                recogHits: parseInt(document.getElementById('recogHits').value),
                falsePos: parseInt(document.getElementById('falsePos').value),
                intrusions: parseInt(document.getElementById('intrusions').value),
                forcedChoice: parseInt(document.getElementById('forcedChoice').value),
                trials15Total: parseInt(document.getElementById('trials15Total').value),
                delayedIndex: parseInt(document.getElementById('delayedIndex').value),
                totalRecall: parseInt(document.getElementById('totalRecall').value),
                clustering: parseFloat(document.getElementById('clustering').value),
                primacy: parseFloat(document.getElementById('primacy').value),
                recency: parseFloat(document.getElementById('recency').value),
                learningSlope: parseFloat(document.getElementById('learningSlope').value)
            };

            const warnings = generateValidationWarnings(data);
            const overallRange = getStandardRangeWithHeaton(data.trials15Total);
            const hasUnusualFeatures = data.intrusions > 10 || data.falsePos > 10 || data.recency > 90 || data.clustering < 10;

            let text = `${getGenderPronoun('His')} overall performance on a test of verbal list learning (CVLT-3) was within the ${overallRange} range`;

            if (hasUnusualFeatures) {
                text += ", although with some unusual features";
            }
            text += ". ";

            const trial1Percentile = getPercentileFromRaw(data.trial1, 'trial1');
            const trial1Range = getRangeFromPercentile(trial1Percentile);
            text += `${getGenderPronoun('He')} was able to recall ${data.trial1} of 16 items after an initial learning trial, performing in the ${trial1Range} range. `;

            const slopeDescription = describeLearningSlope(data.trial1, data.trial5, data.learningSlope);
            if (slopeDescription.includes("flat")) {
                text += `${getGenderPronoun('He')} showed a ${slopeDescription}. `;
            } else {
                text += `${getGenderPronoun('He')} showed a ${slopeDescription} learning slope, improving to ${data.trial5} items by the fifth trial. `;
            }

            const recallPattern = describeRecallPattern(data.primacy, data.recency);
            if (recallPattern) {
                text += recallPattern + " ";
            }

            if (data.listB < data.trial1) {
                text += `${getGenderPronoun('He')} showed proactive interference, with learning of one list interfering with the learning of a second, later list. `;
            }

            const shortDelayPercentile = getPercentileFromRaw(data.shortFree, 'delayed');
            const longDelayPercentile = getPercentileFromRaw(data.longFree, 'delayed');
            const shortDelayRange = getRangeFromPercentile(shortDelayPercentile);
            const longDelayRange = getRangeFromPercentile(longDelayPercentile);

            text += `${getGenderPronoun('He')} was able to retain ${data.shortFree} items after a short delay (${shortDelayRange} range), and ${data.longFree} after a longer delay (${longDelayRange} range). `;

            text += describeCuingEffect(data.shortFree, data.shortCued, data.longFree, data.longCued) + " ";
            text += describeClustering(data.clustering) + " ";
            text += describeRecognition(data.recogHits, data.falsePos, data.forcedChoice, data);

            // Store for completion
            currentNarrative = text;

            // Generate score table
            currentScoreTable = `
                <table border="1" style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                    <tr style="background-color: #f5f5f5;">
                        <th style="padding: 8px; text-align: left;">CVLT-3 Measure</th>
                        <th style="padding: 8px; text-align: center;">Raw Score</th>
                        <th style="padding: 8px; text-align: center;">Standard Score</th>
                        <th style="padding: 8px; text-align: center;">Range</th>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Trials 1-5 Total</td>
                        <td style="padding: 8px; text-align: center;">${data.trial1 + data.trial2 + data.trial3 + data.trial4 + data.trial5}</td>
                        <td style="padding: 8px; text-align: center;">${data.trials15Total}</td>
                        <td style="padding: 8px; text-align: center;">${getStandardRange(data.trials15Total)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Short Delay Free Recall</td>
                        <td style="padding: 8px; text-align: center;">${data.shortFree}</td>
                        <td style="padding: 8px; text-align: center;">--</td>
                        <td style="padding: 8px; text-align: center;">${getRangeFromPercentile(getPercentileFromRaw(data.shortFree, 'delayed')).split(',')[0]}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Long Delay Free Recall</td>
                        <td style="padding: 8px; text-align: center;">${data.longFree}</td>
                        <td style="padding: 8px; text-align: center;">--</td>
                        <td style="padding: 8px; text-align: center;">${getRangeFromPercentile(getPercentileFromRaw(data.longFree, 'delayed')).split(',')[0]}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Recognition Hits</td>
                        <td style="padding: 8px; text-align: center;">${data.recogHits}/16</td>
                        <td style="padding: 8px; text-align: center;">--</td>
                        <td style="padding: 8px; text-align: center;">${data.recogHits >= 15 ? 'Normal' : data.recogHits >= 12 ? 'Borderline' : 'Impaired'}</td>
                    </tr>
                </table>
            `;

            document.getElementById('output').innerHTML = `<h3><b>Learning and Memory</b></h3><p>${text}</p>`;

            if (warnings.length > 0) {
                document.getElementById('output').innerHTML += `<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 20px;">`;
                document.getElementById('output').innerHTML += `<h4><b>⚠️ Validation Alerts</b></h4>`;
                warnings.forEach(warning => {
                    document.getElementById('output').innerHTML += `<p style="margin: 5px 0;">${warning}</p>`;
                });
                document.getElementById('output').innerHTML += `</div>`;
            }

            document.getElementById('output').style.display = 'block';
        }

        function completeTest() {
            if (!currentNarrative) {
                alert('Please generate the report first before completing the test.');
                return;
            }

            const results = {
                narrative: currentNarrative,
                scoreTable: currentScoreTable,
                testName: 'CVLT-3',
                completedAt: new Date().toISOString()
            };

            window.parent.postMessage({
                type: 'testComplete',
                testName: 'cvlt-3',
                results: results
            }, '*');
        }

        // Listen for client info from parent
        window.addEventListener('message', function(event) {
            if (event.data.type === 'clientInfo') {
                const clientInfo = event.data.data;
                
                if (clientInfo.clientGender) {
                    document.getElementById('gender').value = clientInfo.clientGender === 'male' ? 'Male' : 'Female';
                }
                
                if (clientInfo.readingLevel) {
                    document.getElementById('readingLevel').value = clientInfo.readingLevel;
                }
                
                generateCVLTText();
            }
        });

        window.onload = function() {
            generateCVLTText();
        };
    </script>
</body>
</html>
