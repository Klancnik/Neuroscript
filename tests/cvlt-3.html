<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>CVLT-3 Clinical Text Generator</title>
    <!-- Load shared normative database -->
    <script src="../neuroscript-norms.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
        input[type="number"]:invalid {
            border: 2px solid #ff0000;
            background-color: #ffe6e6;
        }
        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .section-header {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .generate-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .generate-btn:hover {
            background: #0056b3;
        }
        .complete-btn {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-left: 10px;
        }
        .complete-btn:hover {
            background: #1e7e34;
        }
        .output-section {
            background: white;
            border: 2px solid #dee2e6;
            padding: 25px;
            margin-top: 30px;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }
        h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .invalid-input {
            border: 2px solid #ff0000 !important;
            background-color: #ffe6e6 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CVLT-3 Clinical Text Generator</h1>
        <p>Enter CVLT-3 scores to generate clinical narrative text in Neuroscript format</p>

        <div class="input-section">
            <h3>Demographics</h3>
            <div class="input-group">
                <label>Gender:</label>
                <select id="gender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="input-group">
                <label>Reading Level (grade):</label>
                <input type="number" id="readingLevel" value="" placeholder="Optional" min="1" max="16" step="0.1">
            </div>

            <div class="section-header">📋 Core Score Summary (From CVLT Printout Page 2)</div>
            
            <h4 style="margin: 15px 0 10px 0; color: #495057;">Immediate Recall</h4>
            <div style="display: grid; grid-template-columns: 180px 120px 120px; gap: 10px; margin-bottom: 20px; align-items: start;">
                <div style="font-weight: bold; padding: 5px 0;">
                    <div style="height: 40px; display: flex; align-items: center;">Trial 1 Correct</div>
                    <div style="height: 40px; display: flex; align-items: center;">Trial 2 Correct</div>
                    <div style="height: 40px; display: flex; align-items: center;">Trial 3 Correct</div>
                    <div style="height: 40px; display: flex; align-items: center;">Trial 4 Correct</div>
                    <div style="height: 40px; display: flex; align-items: center;">Trial 5 Correct</div>
                    <div style="height: 40px; display: flex; align-items: center;">List B Correct</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-weight: bold; margin-bottom: 5px;">Raw score</div>
                    <div style="margin-bottom: 5px;"><input type="number" id="trial1" value="" min="0" max="16" placeholder="0-16"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="trial2" value="" min="0" max="16" placeholder="0-16"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="trial3" value="" min="0" max="16" placeholder="0-16"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="trial4" value="" min="0" max="16" placeholder="0-16"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="trial5" value="" min="0" max="16" placeholder="0-16"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="listB" value="" min="0" max="16" placeholder="0-16"></div>
                </div>
                <div style="text-align: center;">
                    <div style="font-weight: bold; margin-bottom: 5px;">Scaled score</div>
                    <div style="margin-bottom: 5px;"><input type="number" id="trial1Scaled" value="" min="1" max="19" placeholder="1-19"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="trial2Scaled" value="" min="1" max="19" placeholder="1-19"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="trial3Scaled" value="" min="1" max="19" placeholder="1-19"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="trial4Scaled" value="" min="1" max="19" placeholder="1-19"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="trial5Scaled" value="" min="1" max="19" placeholder="1-19"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="listBScaled" value="" min="1" max="19" placeholder="1-19"></div>
                </div>
            </div>

            <h4 style="margin: 15px 0 10px 0; color: #495057;">Delayed Recall & Recognition</h4>
            <div style="display: grid; grid-template-columns: 180px 120px 120px; gap: 10px; margin-bottom: 20px; align-items: start;">
                <div style="font-weight: bold; padding: 5px 0;">
                    <div style="height: 40px; display: flex; align-items: center;">Short Delay Free Recall</div>
                    <div style="height: 40px; display: flex; align-items: center;">Long Delay Free Recall</div>
                    <div style="height: 40px; display: flex; align-items: center;">Long Delay Cued Recall</div>
                    <div style="height: 40px; display: flex; align-items: center;">Recognition Hits</div>
                    <div style="height: 40px; display: flex; align-items: center;">Forced Choice</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-weight: bold; margin-bottom: 5px;">Raw score</div>
                    <div style="margin-bottom: 5px;"><input type="number" id="shortFree" value="" min="0" max="16" placeholder="0-16"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="longFree" value="" min="0" max="16" placeholder="0-16"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="longCued" value="" min="0" max="16" placeholder="0-16"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="recogHits" value="" min="0" max="16" placeholder="0-16"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="forcedChoice" value="" min="0" max="16" placeholder="0-16"></div>
                </div>
                <div style="text-align: center;">
                    <div style="font-weight: bold; margin-bottom: 5px;">Scaled score</div>
                    <div style="margin-bottom: 5px;"><input type="number" id="shortFreeScaled" value="" min="1" max="19" placeholder="1-19"></div>
                    <div style="margin-bottom: 5px;"><input type="number" id="longFreeScaled" value="" min="1" max="19" placeholder="1-19"></div>
                    <div style="margin-bottom: 5px;"><span style="color: #666;">—</span></div>
                    <div style="margin-bottom: 5px;"><span style="color: #666;">—</span></div>
                    <div style="margin-bottom: 5px;"><span style="color: #666;">—</span></div>
                </div>
            </div>

            <div class="section-header">📊 Composite Index Scores (From CVLT Printout Page 3)</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                <div>
                    <label>Trials 1-5 Total Index:</label>
                    <input type="number" id="trials15Total" value="" min="40" max="160" placeholder="40-160">
                </div>
                <div>
                    <label>Delayed Recall Correct Index:</label>
                    <input type="number" id="delayedIndex" value="" min="40" max="160" placeholder="40-160">
                </div>
                <div>
                    <label>Total Recall Correct Index:</label>
                    <input type="number" id="totalRecall" value="" min="40" max="160" placeholder="40-160">
                </div>
            </div>

            <div class="section-header">🧠 Process Score Summary (From CVLT Printout Page 5) - Optional</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                <div>
                    <label>Trials 1-5 Semantic Clustering (Scaled):</label>
                    <input type="number" id="clusteringScaled" value="" min="1" max="19" placeholder="1-19">
                </div>
                <div>
                    <label>Trials 1-5 % Recall Primacy (Scaled):</label>
                    <input type="number" id="primacyScaled" value="" min="1" max="19" placeholder="1-19">
                </div>
                <div>
                    <label>Trials 1-5 % Recall Recency (Scaled):</label>
                    <input type="number" id="recencyScaled" value="" min="1" max="19" placeholder="1-19">
                </div>
                <div>
                    <label>Trials 1-5 Learning Slope (Scaled):</label>
                    <input type="number" id="learningSlopeScaled" value="" min="1" max="19" placeholder="1-19">
                </div>
            </div>

            <div class="section-header">🔍 Error Analysis & Validity (From CVLT Printout) - Optional</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                <div>
                    <label>Intrusion Errors - Trials 1-5 (Scaled):</label>
                    <input type="number" id="intrusionsScaled" value="" min="1" max="19" placeholder="1-19">
                </div>
                <div>
                    <label>Total Repetitions - Trials 1-5:</label>
                    <input type="number" id="repetitions" value="" min="0" max="50" placeholder="0-50">
                </div>
                <div>
                    <label>Forced Choice Recognition Total:</label>
                    <input type="number" id="forcedChoice" value="" min="0" max="16" placeholder="0-16">
                </div>
            </div>

            <div class="section-header">⚠️ Forced Choice Recognition Validity Indicators (From CVLT Printout Page 8)</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <label>Number of Target Words Recalled on Immediate/Delay but Missed on Forced Choice Recognition:</label>
                    <input type="number" id="fcRecalledMissed" value="" min="0" max="16" placeholder="0-16">
                </div>
                <div>
                    <label>Number of Hits on Yes/No Recognition but Missed on Forced Choice Recognition:</label>
                    <input type="number" id="fcYesNoMissed" value="" min="0" max="16" placeholder="0-16">
                </div>
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 13px;">
                <strong>Clinical Note:</strong> Two or more errors total across both forced choice validity indicators suggest significant validity concerns and should prompt careful review of effort and engagement.
            </div>

            <button class="generate-btn" onclick="generateCVLTText()">Generate CVLT-3 Report</button>
            <button class="complete-btn" onclick="completeTest()">Complete Test</button>
        </div>

        <div id="output" class="output-section" style="display: none;"></div>
    </div>

    <script>
        let currentNarrative = '';
        let currentScoreTable = '';

        // Add input validation
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    const min = parseFloat(this.min);
                    const max = parseFloat(this.max);
                    
                    if (this.value && (isNaN(value) || value < min || value > max)) {
                        this.style.border = '2px solid red';
                        this.style.backgroundColor = '#ffe6e6';
                    } else {
                        this.style.border = '1px solid #ddd';
                        this.style.backgroundColor = 'white';
                    }
                });
            });
        });

        // Database helper functions matching WMS-III pattern
        function getSubtestInterpretationFromDB(score) {
            if (!score || score === '') return null;
            const data = window.NeuroscriptDB.getRange(score, 'wechsler');
            return data ? data : 'Unable to classify';
        }

        function getIndexInterpretationFromDB(score) {
            if (!score || score === '') return null;
            const data = window.NeuroscriptDB.getRange(score, 'standard');
            return data ? data : 'Unable to classify';
        }

        function generateValidationWarnings(data) {
            const warnings = [];
            
            // Index score validation
            const indexScores = [
                {score: data.trials15Total, name: 'Trials 1-5 Total Index'},
                {score: data.delayedIndex, name: 'Delayed Recall Correct Index'},
                {score: data.totalRecall, name: 'Total Recall Correct Index'}
            ];

            indexScores.forEach(item => {
                if (item.score !== null && item.score !== undefined && item.score !== '' && (item.score < 40 || item.score > 160)) {
                    warnings.push(`⚠️ ${item.name} score (${item.score}) is outside valid range (40-160) - please check data entry`);
                }
            });

            // Scaled score validation  
            const scaledScores = [
                {score: data.trial1Scaled, name: 'Trial 1 (Scaled)'},
                {score: data.trial2Scaled, name: 'Trial 2 (Scaled)'},
                {score: data.trial3Scaled, name: 'Trial 3 (Scaled)'},
                {score: data.trial4Scaled, name: 'Trial 4 (Scaled)'},
                {score: data.trial5Scaled, name: 'Trial 5 (Scaled)'},
                {score: data.listBScaled, name: 'List B (Scaled)'},
                {score: data.shortFreeScaled, name: 'Short Delay Free Recall (Scaled)'},
                {score: data.longFreeScaled, name: 'Long Delay Free Recall (Scaled)'},
                {score: data.clusteringScaled, name: 'Semantic Clustering (Scaled)'},
                {score: data.primacyScaled, name: 'Primacy Effect (Scaled)'},
                {score: data.recencyScaled, name: 'Recency Effect (Scaled)'},
                {score: data.learningSlopeScaled, name: 'Learning Slope (Scaled)'},
                {score: data.intrusionsScaled, name: 'Total Intrusions (Scaled)'}
            ];

            scaledScores.forEach(item => {
                if (item.score !== null && item.score !== undefined && item.score !== '' && (item.score < 1 || item.score > 19)) {
                    warnings.push(`⚠️ ${item.name} score (${item.score}) is outside valid range (1-19) - please check data entry`);
                }
            });
            
            // Clinical validity warnings
            if (data.forcedChoice <= 8) {
                warnings.push("⚠️ Forced choice at/below chance level (≤8/16) - extremely implausible pattern");
            }
            
            // Forced choice validity indicators (matching printout exactly)
            const totalFCErrors = (data.fcRecalledMissed || 0) + (data.fcYesNoMissed || 0);
            if (totalFCErrors >= 2) {
                warnings.push("⚠️ SIGNIFICANT VALIDITY CONCERNS: ≥2 total errors on forced choice recognition validity indicators - review effort and engagement");
            }
            
            const maxPreviousRecall = Math.max(data.trial1 || 0, data.trial2 || 0, data.trial3 || 0, data.trial4 || 0, data.trial5 || 0,
                                               data.shortFree || 0, data.longFree || 0, data.recogHits || 0);
            if (data.forcedChoice && data.forcedChoice < maxPreviousRecall) {
                warnings.push("⚠️ Forced choice performance below previously recalled/recognized items - implausible pattern");
            }
            
            if (data.trial5 && data.trial1 && data.trial5 <= data.trial1) {
                warnings.push("⚠️ Flat or negative learning slope - consider effort or severe impairment");
            }
            
            if (!data.readingLevel) {
                warnings.push("⚠️ Reading level not assessed - may affect comprehension of verbal instructions");
            } else if (data.readingLevel < 5) {
                warnings.push("⚠️ Grade <5 reading level - verbal instruction comprehension may be compromised");
            }
            
            if (data.trials15Total && data.trials15Total < 55) {
                warnings.push("⚠️ Pervasively low performance - consider effort, hearing, or comprehension factors");
            }
            
            return warnings;
        }

        function generateCVLTText() {
            try {
                // Check if external database is loaded
                if (!window.NeuroscriptDB) {
                    document.getElementById('output').innerHTML = `<p><strong>Error:</strong> External database not loaded. Please ensure neuroscript-norms.js is properly loaded.</p>`;
                    document.getElementById('output').style.display = 'block';
                    return;
                }

                // Collect input data
                const data = {
                    gender: document.getElementById('gender').value,
                    readingLevel: document.getElementById('readingLevel').value ? 
                        parseFloat(document.getElementById('readingLevel').value) : null,
                    
                    // Raw scores
                    trial1: document.getElementById('trial1').value ? 
                        parseInt(document.getElementById('trial1').value) : null,
                    trial2: document.getElementById('trial2').value ? 
                        parseInt(document.getElementById('trial2').value) : null,
                    trial3: document.getElementById('trial3').value ? 
                        parseInt(document.getElementById('trial3').value) : null,
                    trial4: document.getElementById('trial4').value ? 
                        parseInt(document.getElementById('trial4').value) : null,
                    trial5: document.getElementById('trial5').value ? 
                        parseInt(document.getElementById('trial5').value) : null,
                    listB: document.getElementById('listB').value ? 
                        parseInt(document.getElementById('listB').value) : null,
                    shortFree: document.getElementById('shortFree').value ? 
                        parseInt(document.getElementById('shortFree').value) : null,
                    longFree: document.getElementById('longFree').value ? 
                        parseInt(document.getElementById('longFree').value) : null,
                    longCued: document.getElementById('longCued').value ? 
                        parseInt(document.getElementById('longCued').value) : null,
                    recogHits: document.getElementById('recogHits').value ? 
                        parseInt(document.getElementById('recogHits').value) : null,
                    forcedChoice: document.getElementById('forcedChoice').value ? 
                        parseInt(document.getElementById('forcedChoice').value) : null,
                    
                    // Scaled scores
                    trial1Scaled: document.getElementById('trial1Scaled').value ? 
                        parseInt(document.getElementById('trial1Scaled').value) : null,
                    trial2Scaled: document.getElementById('trial2Scaled').value ? 
                        parseInt(document.getElementById('trial2Scaled').value) : null,
                    trial3Scaled: document.getElementById('trial3Scaled').value ? 
                        parseInt(document.getElementById('trial3Scaled').value) : null,
                    trial4Scaled: document.getElementById('trial4Scaled').value ? 
                        parseInt(document.getElementById('trial4Scaled').value) : null,
                    trial5Scaled: document.getElementById('trial5Scaled').value ? 
                        parseInt(document.getElementById('trial5Scaled').value) : null,
                    listBScaled: document.getElementById('listBScaled').value ? 
                        parseInt(document.getElementById('listBScaled').value) : null,
                    shortFreeScaled: document.getElementById('shortFreeScaled').value ? 
                        parseInt(document.getElementById('shortFreeScaled').value) : null,
                    longFreeScaled: document.getElementById('longFreeScaled').value ? 
                        parseInt(document.getElementById('longFreeScaled').value) : null,
                    
                    // Index scores
                    trials15Total: document.getElementById('trials15Total').value ? 
                        parseInt(document.getElementById('trials15Total').value) : null,
                    delayedIndex: document.getElementById('delayedIndex').value ? 
                        parseInt(document.getElementById('delayedIndex').value) : null,
                    totalRecall: document.getElementById('totalRecall').value ? 
                        parseInt(document.getElementById('totalRecall').value) : null,
                    
                    // Process scores
                    clusteringScaled: document.getElementById('clusteringScaled').value ? 
                        parseInt(document.getElementById('clusteringScaled').value) : null,
                    primacyScaled: document.getElementById('primacyScaled').value ? 
                        parseInt(document.getElementById('primacyScaled').value) : null,
                    recencyScaled: document.getElementById('recencyScaled').value ? 
                        parseInt(document.getElementById('recencyScaled').value) : null,
                    learningSlopeScaled: document.getElementById('learningSlopeScaled').value ? 
                        parseInt(document.getElementById('learningSlopeScaled').value) : null,
                    intrusionsScaled: document.getElementById('intrusionsScaled').value ? 
                        parseInt(document.getElementById('intrusionsScaled').value) : null,
                    
                    // Error analysis and validity
                    repetitions: document.getElementById('repetitions').value ? 
                        parseInt(document.getElementById('repetitions').value) : null,
                    
                    // Forced choice validity indicators
                    fcRecalledMissed: document.getElementById('fcRecalledMissed').value ? 
                        parseInt(document.getElementById('fcRecalledMissed').value) : null,
                    fcYesNoMissed: document.getElementById('fcYesNoMissed').value ? 
                        parseInt(document.getElementById('fcYesNoMissed').value) : null
                };

                const warnings = generateValidationWarnings(data);
                const pronoun = data.gender === 'Male' ? 'His' : 'Her';
                const pronounLower = data.gender === 'Male' ? 'his' : 'her';
                const heShe = data.gender === 'Male' ? 'He' : 'She';

                // Enhanced narrative following WMS-III pattern
                let cognitiveReport = '<h3>Cognitive Functioning</h3>\n';
                let learningSection = '<h4>Learning and Memory</h4>\n';

                // Index scores summary (optional - add before main paragraph if present)
                if (data.trials15Total || data.delayedIndex || data.totalRecall) {
                    if (data.trials15Total) {
                        learningSection += `<p>Overall verbal learning abilities across initial trials (Trials 1-5 Total Index = ${data.trials15Total}) were in the ${getIndexInterpretationFromDB(data.trials15Total)}.</p>\n`;
                    }
                    if (data.delayedIndex) {
                        learningSection += `<p>Overall delayed memory abilities (Delayed Recall Correct Index = ${data.delayedIndex}) were in the ${getIndexInterpretationFromDB(data.delayedIndex)}.</p>\n`;
                    }
                    if (data.totalRecall) {
                        learningSection += `<p>Overall recall performance across all trials (Total Recall Correct Index = ${data.totalRecall}) was in the ${getIndexInterpretationFromDB(data.totalRecall)}.</p>\n`;
                    }
                }
                let learningParagraph = '';

                // Start with learning sentence
                if (data.trial1Scaled || data.trial5Scaled) {
                    if (data.trial1Scaled && data.trial5Scaled) {
                        const trial1Range = getSubtestInterpretationFromDB(data.trial1Scaled);
                        const trial5Range = getSubtestInterpretationFromDB(data.trial5Scaled);
                        
                        if (trial1Range === trial5Range) {
                            learningParagraph += `Learning of a 16-word list (CVLT-3) was in the ${trial1Range} on both initial presentation (ss=${data.trial1Scaled}) and final learning trial (ss=${data.trial5Scaled}). `;
                        } else {
                            learningParagraph += `Learning of a 16-word list (CVLT-3) was in the ${trial1Range} (ss=${data.trial1Scaled}) on initial presentation, and in the ${trial5Range} (ss=${data.trial5Scaled}) on the final learning trial. `;
                        }
                    } else if (data.trial1Scaled) {
                        learningParagraph += `Initial learning of a 16-word list (CVLT-3) was in the ${getSubtestInterpretationFromDB(data.trial1Scaled)} (ss=${data.trial1Scaled}). `;
                    } else if (data.trial5Scaled) {
                        learningParagraph += `Learning of a 16-word list after repeated presentations (CVLT-3) was in the ${getSubtestInterpretationFromDB(data.trial5Scaled)} (ss=${data.trial5Scaled}). `;
                    }
                }

                // Interference trial analysis
                if (data.listBScaled) {
                    learningParagraph += `Learning under interference conditions was in the ${getSubtestInterpretationFromDB(data.listBScaled)} (ss=${data.listBScaled}). `;
                }

                // Delayed recall analysis with template-based comparisons
                if (data.shortFreeScaled && data.longFreeScaled) {
                    const shortRange = getSubtestInterpretationFromDB(data.shortFreeScaled);
                    const longRange = getSubtestInterpretationFromDB(data.longFreeScaled);
                    
                    if (shortRange === longRange) {
                        learningParagraph += `Delayed recall of the word list was in the ${shortRange} under both short-delay (ss=${data.shortFreeScaled}) and long-delay (ss=${data.longFreeScaled}) conditions. `;
                    } else {
                        learningParagraph += `Delayed recall of the word list was in the ${shortRange} (ss=${data.shortFreeScaled}) under short-delay conditions, and in the ${longRange} (ss=${data.longFreeScaled}) under long-delay conditions. `;
                    }
                } else if (data.shortFreeScaled) {
                    learningParagraph += `Short-delay recall of the word list was in the ${getSubtestInterpretationFromDB(data.shortFreeScaled)} (ss=${data.shortFreeScaled}). `;
                } else if (data.longFreeScaled) {
                    learningParagraph += `Long-delay recall of the word list was in the ${getSubtestInterpretationFromDB(data.longFreeScaled)} (ss=${data.longFreeScaled}). `;
                }

                // Recognition analysis
                if (data.recogHits) {
                    let recogLevel = '';
                    if (data.recogHits >= 15) {
                        recogLevel = 'within normal limits';
                    } else if (data.recogHits >= 12) {
                        recogLevel = 'borderline';
                    } else {
                        recogLevel = 'impaired';
                    }
                    learningParagraph += `Recognition memory for the word list was ${recogLevel} (${data.recogHits}/16 correct). `;
                }

                // Process scores analysis - remove "Process Analysis:" title
                if (data.clusteringScaled || data.primacyScaled || data.recencyScaled || data.learningSlopeScaled) {
                    const processScores = [];
                    if (data.clusteringScaled) {
                        processScores.push(`semantic clustering across trials 1-5 was in the ${getSubtestInterpretationFromDB(data.clusteringScaled)} (ss=${data.clusteringScaled})`);
                    }
                    if (data.learningSlopeScaled) {
                        processScores.push(`learning slope across trials 1-5 was in the ${getSubtestInterpretationFromDB(data.learningSlopeScaled)} (ss=${data.learningSlopeScaled})`);
                    }
                    if (data.primacyScaled) {
                        processScores.push(`primacy effect (early word recall) was in the ${getSubtestInterpretationFromDB(data.primacyScaled)} (ss=${data.primacyScaled})`);
                    }
                    if (data.recencyScaled) {
                        processScores.push(`recency effect (late word recall) was in the ${getSubtestInterpretationFromDB(data.recencyScaled)} (ss=${data.recencyScaled})`);
                    }
                    
                    learningParagraph += processScores.join(', ') + '. ';
                }

                // Error analysis - remove "Error Analysis:" title
                if (data.intrusionsScaled || data.repetitions) {
                    const errorAnalysis = [];
                    if (data.intrusionsScaled) {
                        errorAnalysis.push(`intrusion errors across trials 1-5 were in the ${getSubtestInterpretationFromDB(data.intrusionsScaled)} (ss=${data.intrusionsScaled})`);
                    }
                    if (data.repetitions) {
                        errorAnalysis.push(`repetition errors across trials 1-5 totaled ${data.repetitions}`);
                    }
                    
                    learningParagraph += errorAnalysis.join(', ') + '. ';
                }

                // Forced choice validity analysis - remove "Validity Indicators:" title and fix pronoun
                if (data.fcRecalledMissed !== null || data.fcYesNoMissed !== null) {
                    const totalFCErrors = (data.fcRecalledMissed || 0) + (data.fcYesNoMissed || 0);
                    learningParagraph += `On forced choice recognition validity measures, ${heShe.toLowerCase()} missed ${data.fcRecalledMissed || 0} target words that were previously recalled and ${data.fcYesNoMissed || 0} words that were correctly identified on yes/no recognition (total errors: ${totalFCErrors}). `;
                    
                    if (totalFCErrors >= 2) {
                        learningParagraph += `This pattern raises significant concerns about effort and engagement during testing.`;
                    } else if (totalFCErrors === 1) {
                        learningParagraph += `This pattern is within acceptable limits but warrants clinical consideration.`;
                    } else {
                        learningParagraph += `This pattern supports adequate effort during testing.`;
                    }
                }

                if (learningParagraph) {
                    learningSection += `<p>${learningParagraph}</p>\n`;
                }

                // Compile final report
                const finalReport = cognitiveReport + learningSection;

                // Generate score table using database for all entries
                const adminTests = [];
                
                // Index scores
                if (data.trials15Total) adminTests.push(['Trials 1-5 Total Index', '—', data.trials15Total, getIndexInterpretationFromDB(data.trials15Total)]);
                if (data.delayedIndex) adminTests.push(['Delayed Recall Correct Index', '—', data.delayedIndex, getIndexInterpretationFromDB(data.delayedIndex)]);
                if (data.totalRecall) adminTests.push(['Total Recall Correct Index', '—', data.totalRecall, getIndexInterpretationFromDB(data.totalRecall)]);
                
                // Learning trials
                if (data.trial1Scaled) adminTests.push(['Trial 1', data.trial1, data.trial1Scaled + ' (ss)', getSubtestInterpretationFromDB(data.trial1Scaled)]);
                if (data.trial2Scaled) adminTests.push(['Trial 2', data.trial2, data.trial2Scaled + ' (ss)', getSubtestInterpretationFromDB(data.trial2Scaled)]);
                if (data.trial3Scaled) adminTests.push(['Trial 3', data.trial3, data.trial3Scaled + ' (ss)', getSubtestInterpretationFromDB(data.trial3Scaled)]);
                if (data.trial4Scaled) adminTests.push(['Trial 4', data.trial4, data.trial4Scaled + ' (ss)', getSubtestInterpretationFromDB(data.trial4Scaled)]);
                if (data.trial5Scaled) adminTests.push(['Trial 5', data.trial5, data.trial5Scaled + ' (ss)', getSubtestInterpretationFromDB(data.trial5Scaled)]);
                if (data.listBScaled) adminTests.push(['List B', data.listB, data.listBScaled + ' (ss)', getSubtestInterpretationFromDB(data.listBScaled)]);
                
                // Delayed recall
                if (data.shortFreeScaled) adminTests.push(['Short Delay Free Recall', data.shortFree, data.shortFreeScaled + ' (ss)', getSubtestInterpretationFromDB(data.shortFreeScaled)]);
                if (data.longFreeScaled) adminTests.push(['Long Delay Free Recall', data.longFree, data.longFreeScaled + ' (ss)', getSubtestInterpretationFromDB(data.longFreeScaled)]);
                if (data.longCued) adminTests.push(['Long Delay Cued Recall', data.longCued, '—', 'Not normed']);
                
                // Recognition
                if (data.recogHits) {
                    let recogLevel = '';
                    if (data.recogHits >= 15) recogLevel = 'Normal';
                    else if (data.recogHits >= 12) recogLevel = 'Borderline';
                    else recogLevel = 'Impaired';
                    adminTests.push(['Recognition Hits', data.recogHits + '/16', '—', recogLevel]);
                }
                if (data.forcedChoice) {
                    let fcLevel = '';
                    if (data.forcedChoice >= 15) fcLevel = 'Normal';
                    else if (data.forcedChoice >= 12) fcLevel = 'Borderline';
                    else fcLevel = 'Impaired';
                    adminTests.push(['Forced Choice', data.forcedChoice + '/16', '—', fcLevel]);
                }
                
                // Process scores
                if (data.clusteringScaled) adminTests.push(['Trials 1-5 Semantic Clustering', '—', data.clusteringScaled + ' (ss)', getSubtestInterpretationFromDB(data.clusteringScaled)]);
                if (data.learningSlopeScaled) adminTests.push(['Trials 1-5 Learning Slope', '—', data.learningSlopeScaled + ' (ss)', getSubtestInterpretationFromDB(data.learningSlopeScaled)]);
                if (data.primacyScaled) adminTests.push(['Trials 1-5 % Recall Primacy', '—', data.primacyScaled + ' (ss)', getSubtestInterpretationFromDB(data.primacyScaled)]);
                if (data.recencyScaled) adminTests.push(['Trials 1-5 % Recall Recency', '—', data.recencyScaled + ' (ss)', getSubtestInterpretationFromDB(data.recencyScaled)]);
                if (data.intrusionsScaled) adminTests.push(['Intrusion Errors - Trials 1-5', '—', data.intrusionsScaled + ' (ss)', getSubtestInterpretationFromDB(data.intrusionsScaled)]);
                
                // Error analysis
                if (data.repetitions) adminTests.push(['Total Repetitions - Trials 1-5', data.repetitions, '—', data.repetitions >= 10 ? 'Elevated' : 'Normal']);
                
                // Forced choice validity indicators
                if (data.fcRecalledMissed !== null || data.fcYesNoMissed !== null) {
                    const totalFC = (data.fcRecalledMissed || 0) + (data.fcYesNoMissed || 0);
                    adminTests.push(['FC: Target Words Recalled but Missed', data.fcRecalledMissed || 0, '—', data.fcRecalledMissed >= 2 ? 'Concerning' : 'Normal']);
                    adminTests.push(['FC: Yes/No Hits but Missed', data.fcYesNoMissed || 0, '—', data.fcYesNoMissed >= 2 ? 'Concerning' : 'Normal']);
                    adminTests.push(['Total FC Validity Errors', totalFC, '—', totalFC >= 2 ? 'SIGNIFICANT CONCERN' : totalFC === 1 ? 'Monitor' : 'Normal']);
                }

                let scoreTable = '';
                if (adminTests.length > 0) {
                    scoreTable = `
                    <h4>CVLT-3 Score Summary</h4>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Measure</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Raw Score</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Standard Score</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Classification</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    adminTests.forEach(test => {
                        scoreTable += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${test[0]}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${test[1]}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${test[2]}</td>
                                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${test[3]}</td>
                            </tr>
                        `;
                    });
                    
                    scoreTable += `
                        </tbody>
                    </table>
                    `;
                }

                // Store current narrative and table for completion
                currentNarrative = finalReport.replace(/<[^>]*>/g, '').trim();
                currentScoreTable = scoreTable;

                // Display results
                document.getElementById('output').innerHTML = finalReport + scoreTable;
                
                // Add validation warnings if any
                if (warnings.length > 0) {
                    document.getElementById('output').innerHTML += `<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 20px;">`;
                    document.getElementById('output').innerHTML += `<h4><b>⚠️ Validation Alerts</b></h4>`;
                    warnings.forEach(warning => {
                        document.getElementById('output').innerHTML += `<p style="margin: 5px 0;">${warning}</p>`;
                    });
                    document.getElementById('output').innerHTML += `</div>`;
                }

                document.getElementById('output').style.display = 'block';

            } catch (error) {
                console.error('Error generating CVLT-3 report:', error);
                document.getElementById('output').innerHTML = `<p><strong>Error generating report:</strong> ${error.message}</p>`;
                document.getElementById('output').style.display = 'block';
            }
        }

        function completeTest() {
            if (!currentNarrative) {
                alert('Please generate the report first before completing the test.');
                return;
            }

            const results = {
                narrative: currentNarrative,
                scoreTable: currentScoreTable,
                testName: 'CVLT-3',
                completedAt: new Date().toISOString()
            };

            try {
                window.parent.postMessage({
                    type: 'testComplete',
                    testName: 'cvlt-3',
                    results: results
                }, '*');
                alert('CVLT-3 test completed successfully!');
            } catch (e) {
                console.log('Could not communicate with parent window:', e);
                alert('Test completed locally!');
            }
        }

        // Listen for client info from parent
        window.addEventListener('message', function(event) {
            if (event.data.type === 'clientInfo') {
                const clientInfo = event.data.data;
                
                if (clientInfo.clientGender) {
                    document.getElementById('gender').value = clientInfo.clientGender === 'male' ? 'Male' : 'Female';
                }
                
                if (clientInfo.readingLevel) {
                    document.getElementById('readingLevel').value = clientInfo.readingLevel;
                }
            }
        });

        // Initialize validation on page load
        window.addEventListener('load', function() {
            console.log('CVLT-3 loaded. Checking database...');
            if (window.NeuroscriptDB) {
                console.log('Database loaded successfully');
            } else {
                console.log('Database NOT loaded. Check neuroscript-norms.js file location and loading.');
            }
        });
    </script>
</body>
</html>
