<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVLT-3 Clinical Report Generator <span class="version">v9.4</span></title>
    <script src="../neuroscript-norms.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        /* Header Demographics Section */
        .demographics-section {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .demographics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        .demographic-field {
            display: flex;
            flex-direction: column;
        }
        .demographic-field label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }
        .demographic-field input, .demographic-field select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* Section Headers */
        .section-header {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px 15px;
            margin: 25px 0 15px 0;
            font-weight: bold;
            color: #495057;
            font-size: 16px;
        }
        .section-header.core-scores {
            background: #e8f4f8;
            border-color: #b8daff;
        }
        .section-header.composite-scores {
            background: #e8f5e8;
            border-color: #b8e6b8;
        }
        .section-header.process-scores {
            background: #ffeaa7;
            border-color: #fdcb6e;
        }
        .section-header.error-analysis {
            background: #fab1a0;
            border-color: #e84393;
        }
        .section-header.validity {
            background: #fd79a8;
            border-color: #e84393;
        }
        
        /* Core Score Table Layout */
        .core-score-table {
            display: grid;
            grid-template-columns: 200px 120px 120px;
            gap: 2px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }
        .table-header {
            background: #6c757d;
            color: white;
            padding: 10px;
            font-weight: bold;
            text-align: center;
        }
        .table-subheader {
            background: #495057;
            color: white;
            padding: 8px;
            font-weight: bold;
            grid-column: span 3;
        }
        .table-row-label {
            background: #f8f9fa;
            padding: 10px;
            font-weight: 500;
            border-right: 1px solid #dee2e6;
            display: flex;
            align-items: center;
        }
        .table-input {
            padding: 8px;
            border: none;
            background: white;
            text-align: center;
            font-size: 14px;
        }
        .table-input:focus {
            outline: 2px solid #007bff;
            background: #f0f8ff;
        }
        
        /* Vertical Layout for All Sections */
        .vertical-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        .vertical-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .vertical-item label {
            font-weight: bold;
            color: #495057;
            margin: 0;
        }
        .vertical-item input {
            width: 90px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }
        .validity-item input {
            width: 90px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }
        .validity-item {
            display: grid;
            grid-template-columns: 1fr au...(truncated 33057 characters)...ta.falsePositives !== null && data.falsePositives !== undefined && data.falsePositives > 0) {
                        const fpScaledScore = data.recogHitsScaled ? ` (ss=${data.recogHitsScaled})` : '';
                        narrative += `${fpScaledScore} and made ${data.falsePositives} false positive error${data.falsePositives === 1 ? '' : 's'}`;
                    }
                    
                    narrative += '. ';
                }
            }

            // 8. Forced Choice Recognition Performance
            if (data.forcedChoice !== null && data.forcedChoice !== undefined) {
                if (data.forcedChoice < 16) {
                    const errors = 16 - data.forcedChoice;
                    if (errors === 1) {
                        narrative += `On forced choice recognition trials, ${data.gender === 'Male' ? 'he' : 'she'} made 1 error, which is unusual. `;
                    } else {
                        narrative += `On forced choice recognition trials, ${data.gender === 'Male' ? 'he' : 'she'} made ${errors} errors, which is unusual. `;
                    }
                }
            }

            // 9. Validity Concerns
            let validityConcerns = [];
            
            // Check yes/no recognition errors (significant = less than 14 correct?)
            if (data.recogHits !== null && data.recogHits !== undefined && data.recogHits < 14) {
                validityConcerns.push('significant errors on yes/no recognition');
            }
            
            // Check forced choice errors (can stand alone)
            let forcedChoiceErrors = false;
            if (data.forcedChoice !== null && data.forcedChoice !== undefined && data.forcedChoice < 16) {
                forcedChoiceErrors = true;
            }
            
            // Check validity indicators (2 or more total errors = highly unusual)
            const fcRecalledMissed = data.fcRecalledMissed || 0;
            const fcYesNoMissed = data.fcYesNoMissed || 0;
            const totalValidityErrors = fcRecalledMissed + fcYesNoMissed;
            
            // Handle validity concerns with specific language
            if (totalValidityErrors >= 2) {
                // Highly unusual inconsistencies - strongest language
                narrative += 'There were highly unusual inconsistencies between recall and recognition performance, indicating that the results of this test are likely invalid, and suggesting symptom exaggeration. ';
            } else if (forcedChoiceErrors) {
                // Forced choice errors can stand alone
                narrative += 'There were validity concerns arising from errors on forced choice recognition trials. ';
            } else if (validityConcerns.length > 0) {
                // Other validity concerns
                if (validityConcerns.length === 1) {
                    narrative += `There were validity concerns arising from ${validityConcerns[0]}. `;
                } else {
                    const lastConcern = validityConcerns.pop();
                    narrative += `There were validity concerns arising from ${validityConcerns.join(', ')} and ${lastConcern}. `;
                }
            }

            // Close paragraph
            narrative += '</p>';

            return narrative;
        }

        function generateScoreTable(data) {
            const scoreTable = [
                ['Test Component', 'Raw Score', 'Scaled Score/Index', 'Range']
            ];
            
            // Add completed tests to score table
            if (data.totalRecall) {
                scoreTable.push(['Total Recall Index', '--', data.totalRecall, getIndexInterpretationFromDB(data.totalRecall)]);
            }
            if (data.trial1 && data.trial1Scaled) {
                scoreTable.push(['Trial 1', data.trial1, `${data.trial1Scaled} (ss)`, getScaledInterpretationFromDB(data.trial1Scaled)]);
            }
            if (data.trial5 && data.trial5Scaled) {
                scoreTable.push(['Trial 5', data.trial5, `${data.trial5Scaled} (ss)`, getScaledInterpretationFromDB(data.trial5Scaled)]);
            }
            
            return scoreTable;
        }

        function saveTestData() {
            if (!currentNarrative) {
                alert('Please generate the report first before completing the test.');
                return;
            }
            
            const results = {
                narrative: currentNarrative,
                scoreTable: currentScoreTable,
                testName: 'CVLT-3',
                completedAt: new Date().toISOString()
            };
            
            // Send to master dashboard
            window.parent.postMessage({
                type: 'testComplete',
                testName: 'cvlt',
                results: results
            }, '*');
            
            console.log('CVLT-3 test completed and sent to dashboard v9.4');
        }

        function loadTestData() {
            try {
                console.log('Loading test data v9.4');
                // Plausible dummy data for demonstration
                const dummyData = JSON.parse(localStorage.getItem('cvltData')) || {
                    name: 'John Doe',
                    age: '30',
                    gender: 'Male',
                    education: '12',
                    readingLevel: '10',
                    trial1: 8,
                    trial2: 9,
                    trial3: 10,
                    trial4: 11,
                    trial5: 12,
                    totalRecall: 50,
                    trial1Scaled: 10,
                    trial5Scaled: 11,
                    listB: 6,
                    sdiFree: 8,
                    sdiCued: 9,
                    ldiFree: 10,
                    ldiCued: 11,
                    recogHits: 15,
                    falsePositives: 2,
                    recogHitsScaled: 10,
                    forcedChoice: 16,
                    fcRecalledMissed: 0,
                    fcYesNoMissed: 0,
                    // Add more fields as needed for full dummy data
                };

                // Populate fields with dummy or saved data
                document.getElementById('name').textContent = dummyData.name || '';
                document.getElementById('age').textContent = dummyData.age || '';
                document.getElementById('gender').textContent = dummyData.gender || '';
                document.getElementById('education').textContent = dummyData.education || '';
                document.getElementById('readingLevel').textContent = dummyData.readingLevel || '';
                document.getElementById('trial1').value = dummyData.trial1 || '';
                document.getElementById('trial2').value = dummyData.trial2 || '';
                document.getElementById('trial3').value = dummyData.trial3 || '';
                document.getElementById('trial4').value = dummyData.trial4 || '';
                document.getElementById('trial5').value = dummyData.trial5 || '';
                document.getElementById('totalRecall').value = dummyData.totalRecall || '';
                document.getElementById('trial1Scaled').value = dummyData.trial1Scaled || '';
                document.getElementById('trial5Scaled').value = dummyData.trial5Scaled || '';
                document.getElementById('listB').value = dummyData.listB || '';
                document.getElementById('sdiFree').value = dummyData.sdiFree || '';
                document.getElementById('sdiCued').value = dummyData.sdiCued || '';
                document.getElementById('ldiFree').value = dummyData.ldiFree || '';
                document.getElementById('ldiCued').value = dummyData.ldiCued || '';
                document.getElementById('recogHits').value = dummyData.recogHits || '';
                document.getElementById('falsePositives').value = dummyData.falsePositives || '';
                document.getElementById('recogHitsScaled').value = dummyData.recogHitsScaled || '';
                document.getElementById('forcedChoice').value = dummyData.forcedChoice || '';
                document.getElementById('fcRecalledMissed').value = dummyData.fcRecalledMissed || '';
                document.getElementById('fcYesNoMissed').value = dummyData.fcYesNoMissed || '';
                // Add population for other fields as needed

                console.log('CVLT-3 test data loaded successfully v9.4 with dummy data:', dummyData);
            } catch (error) {
                console.error('Error loading test data v9.4:', error);
            }
        }

        // === EVENT HANDLERS AND INITIALIZATION ===
        window.addEventListener('message', function(event) {
            console.log('Message received in CVLT-3 v9.4:', event.data);
            if (event.data.type === 'clientInfo') {
                const clientData = event.data.data;
                document.getElementById('name').textContent = clientData.name || '';
                document.getElementById('age').textContent = clientData.age || '';
                document.getElementById('gender').textContent = clientData.gender || '';
                document.getElementById('education').textContent = clientData.education || '';
                document.getElementById('readingLevel').textContent = clientData.readingLevel || '';
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CVLT-3 v9.4 loaded successfully');
            
            // Database loading check
            if (typeof window.NeuroscriptDB === 'undefined') {
                console.error('NeuroscriptDB not loaded in CVLT-3 v9.4!');
                setTimeout(() => {
                    if (typeof window.NeuroscriptDB === 'undefined') {
                        alert('Database loading error. Please refresh the page.');
                    }
                }, 2000);
            } else {
                console.log('NeuroscriptDB loaded successfully in CVLT-3 v9.4');
            }
        });
    </script>
</body>
</html>
