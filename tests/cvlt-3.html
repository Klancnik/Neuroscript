<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVLT-3 Enhanced v3.0</title>
    <script src="../neuroscript-norms.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 300;
        }
        
        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .section-header {
            background-color: #4a5568;
            color: white;
            padding: 12px 15px;
            margin: 20px 0 15px 0;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .demographic-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .demographic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .demographic-field {
            display: flex;
            flex-direction: column;
        }
        
        .demographic-field label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .demographic-field input, .demographic-field select {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* Core Score Table Styling */
        .core-score-table {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1px;
            background-color: #e2e8f0;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .table-header {
            background-color: #4a5568;
            color: white;
            padding: 12px 8px;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }
        
        .table-subheader {
            background-color: #718096;
            color: white;
            padding: 10px 8px;
            font-weight: 600;
            grid-column: 1 / -1;
            text-align: center;
            font-size: 13px;
        }
        
        .table-row-label {
            background-color: #f7fafc;
            padding: 8px 12px;
            font-weight: 500;
            color: #2d3748;
            display: flex;
            align-items: center;
            font-size: 13px;
            border-right: 1px solid #e2e8f0;
        }
        
        .table-input {
            background-color: white;
            border: none;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            border-right: 1px solid #e2e8f0;
        }
        
        .table-input:focus {
            outline: 2px solid #667eea;
            outline-offset: -2px;
        }
        
        /* Vertical Grid Styling */
        .vertical-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .vertical-item {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            align-items: center;
        }
        
        .vertical-item label {
            font-weight: 500;
            color: #2d3748;
            font-size: 14px;
        }
        
        .vertical-item input {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .validity-item {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 10px;
            align-items: center;
        }
        
        .validity-item label {
            font-weight: 500;
            color: #2d3748;
            font-size: 14px;
        }
        
        .validity-item input {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* Button Styling */
        .save-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .load-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .load-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .output-section {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        
        .core-scores, .process-scores, .error-analysis, .validity, .composite-scores {
            position: relative;
        }
        
        /* Input validation styling */
        .invalid-input {
            border: 2px solid #e53e3e !important;
            background-color: #fed7d7 !important;
        }
        
        .warning-text {
            color: #e53e3e;
            font-size: 12px;
            margin-top: 4px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🧠 CVLT-3 California Verbal Learning Test Enhanced v3.0</h1>
        <p>Professional Neuropsychological Assessment Generator with External Database Integration</p>
    </div>

    <div class="container">
        <!-- Demographics Section -->
        <div class="section-header">👤 Client Information</div>
        <div class="demographic-section">
            <div class="demographic-grid">
                <div class="demographic-field">
                    <label>Client Name:</label>
                    <input type="text" id="clientName" placeholder="Enter client name">
                </div>
                <div class="demographic-field">
                    <label>Age:</label>
                    <input type="number" id="age" placeholder="16-89" min="16" max="89">
                </div>
                <div class="demographic-field">
                    <label>Gender:</label>
                    <select id="gender">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="demographic-field">
                    <label>Education (years):</label>
                    <input type="number" id="education" placeholder="6-25" min="6" max="25">
                </div>
                <div class="demographic-field">
                    <label>Reading Level (grade):</label>
                    <input type="number" id="readingLevel" placeholder="Optional" min="1" max="16" step="0.1">
                </div>
            </div>
        </div>

        <!-- Core Score Summary -->
        <div class="section-header core-scores">📋 Core Score Summary (From CVLT-3 Printout Page 2)</div>
        
        <div class="core-score-table">
            <div class="table-header">Test</div>
            <div class="table-header">Raw score</div>
            <div class="table-header">Scaled score</div>
            
            <div class="table-subheader">Immediate Recall</div>
            
            <div class="table-row-label">Trial 1 Correct</div>
            <input type="number" id="trial1" class="table-input" min="0" max="16" placeholder="0-16">
            <input type="number" id="trial1Scaled" class="table-input" min="1" max="19" placeholder="1-19">
            
            <div class="table-row-label">Trial 2 Correct</div>
            <input type="number" id="trial2" class="table-input" min="0" max="16" placeholder="0-16">
            <input type="number" id="trial2Scaled" class="table-input" min="1" max="19" placeholder="1-19">
            
            <div class="table-row-label">Trial 3 Correct</div>
            <input type="number" id="trial3" class="table-input" min="0" max="16" placeholder="0-16">
            <input type="number" id="trial3Scaled" class="table-input" min="1" max="19" placeholder="1-19">
            
            <div class="table-row-label">Trial 4 Correct</div>
            <input type="number" id="trial4" class="table-input" min="0" max="16" placeholder="0-16">
            <input type="number" id="trial4Scaled" class="table-input" min="1" max="19" placeholder="1-19">
            
            <div class="table-row-label">Trial 5 Correct</div>
            <input type="number" id="trial5" class="table-input" min="0" max="16" placeholder="0-16">
            <input type="number" id="trial5Scaled" class="table-input" min="1" max="19" placeholder="1-19">
            
            <div class="table-row-label">List B Correct</div>
            <input type="number" id="listB" class="table-input" min="0" max="16" placeholder="0-16">
            <input type="number" id="listBScaled" class="table-input" min="1" max="19" placeholder="1-19">
            
            <div class="table-subheader">Delayed Recall</div>
            
            <div class="table-row-label">Short Delay Free Recall</div>
            <input type="number" id="shortFree" class="table-input" min="0" max="16" placeholder="0-16">
            <input type="number" id="shortFreeScaled" class="table-input" min="1" max="19" placeholder="1-19">
            
            <div class="table-row-label">Long Delay Free Recall</div>
            <input type="number" id="longFree" class="table-input" min="0" max="16" placeholder="0-16">
            <input type="number" id="longFreeScaled" class="table-input" min="1" max="19" placeholder="1-19">
            
            <div class="table-row-label">Long Delay Cued Recall</div>
            <input type="number" id="longCued" class="table-input" min="0" max="16" placeholder="0-16">
            <input type="number" id="longCuedScaled" class="table-input" min="1" max="19" placeholder="1-19">
            
            <div class="table-subheader">Yes/No Recognition</div>
            
            <div class="table-row-label">Total Hits</div>
            <input type="number" id="recogHits" class="table-input" min="0" max="16" placeholder="0-16">
            <input type="number" id="recogHitsScaled" class="table-input" min="1" max="19" placeholder="1-19">
            
            <div class="table-row-label">False Positives</div>
            <input type="number" id="falsePositives" class="table-input" min="0" max="50" placeholder="0-50">
            <div class="table-input" style="background: #f8f9fa; color: #6c757d;">—</div>
            
            <div class="table-subheader">Forced Choice Recognition</div>
            
            <div class="table-row-label">Total Hits</div>
            <input type="number" id="forcedChoice" class="table-input" min="0" max="16" placeholder="0-16">
            <input type="number" id="forcedChoiceScaled" class="table-input" min="1" max="19" placeholder="1-19">
        </div>

        <!-- Composite Index Scores -->
        <div class="section-header composite-scores">📊 Composite Index Scores (From CVLT-3 Printout Page 3)</div>
        <div class="vertical-grid">
            <div class="vertical-item">
                <label>Trials 1-5 Total Index:</label>
                <input type="number" id="trials15Total" min="40" max="160" placeholder="40-160">
            </div>
            <div class="vertical-item">
                <label>Delayed Recall Correct Index:</label>
                <input type="number" id="delayedIndex" min="40" max="160" placeholder="40-160">
            </div>
            <div class="vertical-item">
                <label>Total Recall Correct Index:</label>
                <input type="number" id="totalRecall" min="40" max="160" placeholder="40-160">
            </div>
        </div>

        <!-- Process Score Summary -->
        <div class="section-header process-scores">🧠 Process Score Summary (From CVLT-3 Printout Page 5) - Optional</div>
        <div class="vertical-grid">
            <div class="vertical-item">
                <label>Trials 1-5 Semantic Clustering (Scaled):</label>
                <input type="number" id="clusteringScaled" min="1" max="19" placeholder="1-19">
            </div>
            <div class="vertical-item">
                <label>Trials 1-5 % Recall Primacy (Scaled):</label>
                <input type="number" id="primacyScaled" min="1" max="19" placeholder="1-19">
            </div>
            <div class="vertical-item">
                <label>Trials 1-5 % Recall Recency (Scaled):</label>
                <input type="number" id="recencyScaled" min="1" max="19" placeholder="1-19">
            </div>
            <div class="vertical-item">
                <label>Trials 1-5 Learning Slope (Scaled):</label>
                <input type="number" id="learningSlopeScaled" min="1" max="19" placeholder="1-19">
            </div>
        </div>

        <!-- Error Analysis & Validity -->
        <div class="section-header error-analysis">🔍 Error Analysis & Validity (From CVLT-3 Printout) - Optional</div>
        <div class="vertical-grid">
            <div class="vertical-item">
                <label>Intrusion Errors - Trials 1-5 (Scaled):</label>
                <input type="number" id="intrusionsScaled" min="1" max="19" placeholder="1-19">
            </div>
            <div class="vertical-item">
                <label>Total Repetitions - Trials 1-5:</label>
                <input type="number" id="repetitions" min="0" max="50" placeholder="0-50">
            </div>
        </div>

        <!-- Forced Choice Recognition Validity -->
        <div class="section-header validity">⚠️ Forced Choice Recognition Validity Indicators (From CVLT-3 Printout Page 8)</div>
        <div class="vertical-grid">
            <div class="validity-item">
                <label>Number of Target Words Recalled on Immediate/Delay but Missed on Forced Choice Recognition:</label>
                <input type="number" id="validityIndicator" min="0" max="16" placeholder="0-16">
            </div>
        </div>

        <button class="load-btn" onclick="loadTestData()">Load Test Data</button>
        <button class="save-btn" onclick="saveTestData()">Save Test Data</button>

        <div id="output" class="output-section" style="display:none;">
            <!-- Generated report will appear here -->
        </div>
    </div>

    <script>
        console.log('CVLT-3 Enhanced v3.0 - Initializing...');
        
        // === GLOBAL VARIABLES ===
        let currentNarrative = '';
        let currentScoreTable = '';

        // === ALL FUNCTION DEFINITIONS FIRST ===
        
        function generateCVLTValidationWarnings(data) {
            console.log('generateCVLTValidationWarnings v3.0 called with data:', data);
            
            const warnings = [];
            
            // Index score validation (40-160 range)
            const indexScores = [
                {score: data.trials15Total, name: 'Trials 1-5 Total Index'},
                {score: data.delayedIndex, name: 'Delayed Recall Correct Index'},
                {score: data.totalRecall, name: 'Total Recall Correct Index'}
            ];

            indexScores.forEach(item => {
                if (item.score !== null && item.score !== undefined && item.score !== '' && (item.score < 40 || item.score > 160)) {
                    warnings.push(`⚠️ ${item.name} score (${item.score}) is outside valid range (40-160) - please check data entry`);
                }
            });
            
            // Scaled score validation (1-19 range)
            const scaledScores = [
                {score: data.trial1Scaled, name: 'Trial 1 (Scaled)'},
                {score: data.trial2Scaled, name: 'Trial 2 (Scaled)'},
                {score: data.trial3Scaled, name: 'Trial 3 (Scaled)'},
                {score: data.trial4Scaled, name: 'Trial 4 (Scaled)'},
                {score: data.trial5Scaled, name: 'Trial 5 (Scaled)'},
                {score: data.listBScaled, name: 'List B (Scaled)'},
                {score: data.shortFreeScaled, name: 'Short Delay Free Recall (Scaled)'},
                {score: data.longFreeScaled, name: 'Long Delay Free Recall (Scaled)'},
                {score: data.longCuedScaled, name: 'Long Delay Cued Recall (Scaled)'},
                {score: data.recogHitsScaled, name: 'Recognition Hits (Scaled)'},
                {score: data.forcedChoiceScaled, name: 'Forced Choice (Scaled)'},
                {score: data.clusteringScaled, name: 'Clustering (Scaled)'},
                {score: data.primacyScaled, name: 'Primacy Effect (Scaled)'},
                {score: data.recencyScaled, name: 'Recency Effect (Scaled)'},
                {score: data.learningSlopeScaled, name: 'Learning Slope (Scaled)'},
                {score: data.intrusionsScaled, name: 'Total Intrusions (Scaled)'}
            ];

            scaledScores.forEach(item => {
                if (item.score !== null && item.score !== undefined && item.score !== '' && (item.score < 1 || item.score > 19)) {
                    warnings.push(`⚠️ ${item.name} score (${item.score}) is outside valid range (1-19) - please check data entry`);
                }
            });
            
            // Clinical validity warnings (preserved from original)
            if (data.forcedChoice <= 8) {
                warnings.push("⚠️ Forced choice at/below chance level (≤8/16) - extremely implausible pattern");
            }
            
            const maxPreviousRecall = Math.max(data.trial1 || 0, data.trial2 || 0, data.trial3 || 0, data.trial4 || 0, data.trial5 || 0,
                                               data.shortFree || 0, data.longFree || 0, data.recogHits || 0);
            if (data.forcedChoice && data.forcedChoice < maxPreviousRecall) {
                warnings.push("⚠️ Forced choice performance below previously recalled/recognized items - implausible pattern");
            }
            
            if (data.repetitions > 20) {
                warnings.push("⚠️ Excessive repetitions (>20) - consider validity or severe impairment");
            }
            
            if (data.trial5 && data.trial1 && data.trial5 <= data.trial1) {
                warnings.push("⚠️ Flat or negative learning slope - consider effort or severe impairment");
            }
            
            if (!data.readingLevel) {
                warnings.push("⚠️ Reading level not assessed - may affect comprehension of verbal instructions");
            } else if (data.readingLevel < 5) {
                warnings.push("⚠️ Grade <5 reading level - verbal instruction comprehension may be compromised");
            }
            
            if (data.trials15Total && data.trials15Total < 55) {
                warnings.push("⚠️ Pervasively low performance - consider effort, hearing, or comprehension factors");
            }
            
            return warnings;
        }

        function generateCVLTText() {
            try {
                // Check if external database is loaded
                if (!window.NeuroscriptDB) {
                    document.getElementById('output').innerHTML = `<p><strong>Error:</strong> External database not loaded. Please refresh the page.</p>`;
                    document.getElementById('output').style.display = 'block';
                    return;
                }

                console.log('generateCVLTText v3.0 called');
                
                // Get all input values
                const data = {
                    clientName: document.getElementById('clientName').value,
                    age: parseInt(document.getElementById('age').value),
                    gender: document.getElementById('gender').value,
                    education: parseInt(document.getElementById('education').value),
                    readingLevel: parseFloat(document.getElementById('readingLevel').value),
                    
                    // Core scores
                    trial1: parseInt(document.getElementById('trial1').value),
                    trial1Scaled: parseInt(document.getElementById('trial1Scaled').value),
                    trial2: parseInt(document.getElementById('trial2').value),
                    trial2Scaled: parseInt(document.getElementById('trial2Scaled').value),
                    trial3: parseInt(document.getElementById('trial3').value),
                    trial3Scaled: parseInt(document.getElementById('trial3Scaled').value),
                    trial4: parseInt(document.getElementById('trial4').value),
                    trial4Scaled: parseInt(document.getElementById('trial4Scaled').value),
                    trial5: parseInt(document.getElementById('trial5').value),
                    trial5Scaled: parseInt(document.getElementById('trial5Scaled').value),
                    listB: parseInt(document.getElementById('listB').value),
                    listBScaled: parseInt(document.getElementById('listBScaled').value),
                    shortFree: parseInt(document.getElementById('shortFree').value),
                    shortFreeScaled: parseInt(document.getElementById('shortFreeScaled').value),
                    longFree: parseInt(document.getElementById('longFree').value),
                    longFreeScaled: parseInt(document.getElementById('longFreeScaled').value),
                    longCued: parseInt(document.getElementById('longCued').value),
                    longCuedScaled: parseInt(document.getElementById('longCuedScaled').value),
                    recogHits: parseInt(document.getElementById('recogHits').value),
                    recogHitsScaled: parseInt(document.getElementById('recogHitsScaled').value),
                    falsePositives: parseInt(document.getElementById('falsePositives').value),
                    forcedChoice: parseInt(document.getElementById('forcedChoice').value),
                    forcedChoiceScaled: parseInt(document.getElementById('forcedChoiceScaled').value),
                    
                    // Index scores
                    trials15Total: parseInt(document.getElementById('trials15Total').value),
                    delayedIndex: parseInt(document.getElementById('delayedIndex').value),
                    totalRecall: parseInt(document.getElementById('totalRecall').value),
                    
                    // Process scores (optional)
                    clusteringScaled: parseInt(document.getElementById('clusteringScaled').value),
                    primacyScaled: parseInt(document.getElementById('primacyScaled').value),
                    recencyScaled: parseInt(document.getElementById('recencyScaled').value),
                    learningSlopeScaled: parseInt(document.getElementById('learningSlopeScaled').value),
                    
                    // Error analysis (optional)
                    intrusionsScaled: parseInt(document.getElementById('intrusionsScaled').value),
                    repetitions: parseInt(document.getElementById('repetitions').value),
                    
                    // Validity indicator
                    validityIndicator: parseInt(document.getElementById('validityIndicator').value)
                };

                console.log('Input data collected v3.0:', data);

                // Validation
                if (!data.clientName) {
                    alert('Please enter client name');
                    return;
                }

                if (!data.age || data.age < 16 || data.age > 89) {
                    alert('Please enter valid age (16-89)');
                    return;
                }

                if (!data.education || data.education < 6 || data.education > 25) {
                    alert('Please enter valid education years (6-25)');
                    return;
                }

                // Check that at least some core scores are entered
                const hasCoreScores = data.trials15Total || data.delayedIndex || data.totalRecall ||
                                     data.trial1Scaled || data.trial5Scaled || data.longFreeScaled;
                
                if (!hasCoreScores) {
                    alert('Please enter at least some core CVLT-3 scores (index scores or key scaled scores)');
                    return;
                }

                console.log('Validation passed v3.0, generating narrative...');

                // Generate validation warnings
                const warnings = generateCVLTValidationWarnings(data);

                // Start building narrative
                let narrative = `<h2>🧠 CVLT-3 California Verbal Learning Test Results</h2>\n\n`;

                // Introduction
                narrative += `<h3>Test Overview</h3>\n`;
                narrative += `The California Verbal Learning Test, Third Edition (CVLT-3) is a comprehensive assessment of verbal learning and memory that evaluates multiple aspects of learning, recall, and recognition processes. `;
                narrative += `${data.clientName} was administered this measure to assess his verbal learning capacity, retention of learned information, and various memory processes.\n\n`;

                // Index scores section (if available)
                if (data.trials15Total || data.delayedIndex || data.totalRecall) {
                    narrative += `<h3>Index Score Performance</h3>\n`;
                    
                    if (data.trials15Total) {
                        const indexResult = window.NeuroscriptDB.getByStandardScore(data.trials15Total);
                        narrative += `On the Trials 1-5 Total Index, ${data.clientName} achieved a standard score of ${data.trials15Total}, placing his performance in the ${indexResult.aacnRange}`;
                        if (indexResult.tScore < 40) {
                            narrative += `, indicating a ${indexResult.impairmentLevel} level of impairment`;
                        }
                        narrative += ` and ranking at the ${indexResult.percentile} percentile relative to same-age peers. This index reflects his ability to learn verbal information across multiple learning trials.\n\n`;
                    }
                    
                    if (data.delayedIndex) {
                        const delayedResult = window.NeuroscriptDB.getByStandardScore(data.delayedIndex);
                        narrative += `His Delayed Recall Correct Index yielded a standard score of ${data.delayedIndex}, falling in the ${delayedResult.aacnRange}`;
                        if (delayedResult.tScore < 40) {
                            narrative += `, indicating a ${delayedResult.impairmentLevel} level of impairment`;
                        }
                        narrative += ` (${delayedResult.percentile} percentile). This index measures his ability to recall previously learned verbal information after a delay.\n\n`;
                    }
                    
                    if (data.totalRecall) {
                        const totalResult = window.NeuroscriptDB.getByStandardScore(data.totalRecall);
                        narrative += `The Total Recall Correct Index produced a standard score of ${data.totalRecall}, placing his overall verbal memory performance in the ${totalResult.aacnRange}`;
                        if (totalResult.tScore < 40) {
                            narrative += `, indicating a ${totalResult.impairmentLevel} level of impairment`;
                        }
                        narrative += ` (${totalResult.percentile} percentile).\n\n`;
                    }
                }

                // Learning trials analysis (if available)
                if (data.trial1Scaled && data.trial5Scaled) {
                    narrative += `<h3>Learning Curve Analysis</h3>\n`;
                    
                    const trial1Result = window.NeuroscriptDB.getByWechslerScore(data.trial1Scaled);
                    const trial5Result = window.NeuroscriptDB.getByWechslerScore(data.trial5Scaled);
                    
                    narrative += `${data.clientName}'s initial learning trial (Trial 1) resulted in a scaled score of ${data.trial1Scaled}, placing his immediate verbal span in the ${trial1Result.aacnRange}`;
                    if (trial1Result.tScore < 40) {
                        narrative += `, indicating a ${trial1Result.impairmentLevel} level of impairment`;
                    }
                    narrative += `. His final learning trial (Trial 5) yielded a scaled score of ${data.trial5Scaled}, falling in the ${trial5Result.aacnRange}`;
                    if (trial5Result.tScore < 40) {
                        narrative += `, indicating a ${trial5Result.impairmentLevel} level of impairment`;
                    }
                    narrative += `. `;
                    
                    // Learning slope analysis
                    const improvement = data.trial5Scaled - data.trial1Scaled;
                    if (improvement >= 3) {
                        narrative += `This represents good learning efficiency with notable improvement across trials.\n\n`;
                    } else if (improvement >= 1) {
                        narrative += `This shows modest improvement across learning trials.\n\n`;
                    } else if (improvement === 0) {
                        narrative += `This indicates minimal learning across trials, suggesting possible learning difficulties.\n\n`;
                    } else {
                        narrative += `This shows declining performance across trials, which is atypical and may suggest attention or motivation factors.\n\n`;
                    }
                }

                // Recall performance analysis (if available)
                if (data.shortFreeScaled || data.longFreeScaled || data.longCuedScaled) {
                    narrative += `<h3>Recall Performance</h3>\n`;
                    
                    if (data.shortFreeScaled) {
                        const shortResult = window.NeuroscriptDB.getByWechslerScore(data.shortFreeScaled);
                        narrative += `On short delay free recall, ${data.clientName} achieved a scaled score of ${data.shortFreeScaled}, placing his immediate retention in the ${shortResult.aacnRange}`;
                        if (shortResult.tScore < 40) {
                            narrative += `, indicating a ${shortResult.impairmentLevel} level of impairment`;
                        }
                        narrative += `. `;
                    }
                    
                    if (data.longFreeScaled) {
                        const longResult = window.NeuroscriptDB.getByWechslerScore(data.longFreeScaled);
                        narrative += `Long delay free recall resulted in a scaled score of ${data.longFreeScaled}, falling in the ${longResult.aacnRange}`;
                        if (longResult.tScore < 40) {
                            narrative += `, indicating a ${longResult.impairmentLevel} level of impairment`;
                        }
                        narrative += `. `;
                    }
                    
                    if (data.longCuedScaled) {
                        const cuedResult = window.NeuroscriptDB.getByWechslerScore(data.longCuedScaled);
                        narrative += `With semantic cues provided, his long delay cued recall yielded a scaled score of ${data.longCuedScaled}, placing performance in the ${cuedResult.aacnRange}`;
                        if (cuedResult.tScore < 40) {
                            narrative += `, indicating a ${cuedResult.impairmentLevel} level of impairment`;
                        }
                        narrative += `.\n\n`;
                    }
                }

                // Recognition performance (if available)
                if (data.recogHitsScaled || data.forcedChoiceScaled) {
                    narrative += `<h3>Recognition Performance</h3>\n`;
                    
                    if (data.recogHitsScaled) {
                        const recogResult = window.NeuroscriptDB.getByWechslerScore(data.recogHitsScaled);
                        narrative += `${data.clientName}'s yes/no recognition performance yielded a scaled score of ${data.recogHitsScaled}, placing his recognition ability in the ${recogResult.aacnRange}`;
                        if (recogResult.tScore < 40) {
                            narrative += `, indicating a ${recogResult.impairmentLevel} level of impairment`;
                        }
                        narrative += `. `;
                    }
                    
                    if (data.forcedChoiceScaled) {
                        const forcedResult = window.NeuroscriptDB.getByWechslerScore(data.forcedChoiceScaled);
                        narrative += `On forced choice recognition, he achieved a scaled score of ${data.forcedChoiceScaled}, falling in the ${forcedResult.aacnRange}`;
                        if (forcedResult.tScore < 40) {
                            narrative += `, indicating a ${forcedResult.impairmentLevel} level of impairment`;
                        }
                        narrative += `.\n\n`;
                    }
                }

                // Process scores analysis (if available)
                if (data.clusteringScaled || data.primacyScaled || data.recencyScaled || data.learningSlopeScaled) {
                    narrative += `<h3>Learning Strategy Analysis</h3>\n`;
                    
                    if (data.clusteringScaled) {
                        const clusterResult = window.NeuroscriptDB.getByWechslerScore(data.clusteringScaled);
                        narrative += `${data.clientName}'s use of semantic clustering strategies resulted in a scaled score of ${data.clusteringScaled}, falling in the ${clusterResult.aacnRange}`;
                        if (clusterResult.tScore < 40) {
                            narrative += `, indicating a ${clusterResult.impairmentLevel} level of impairment`;
                        }
                        narrative += ` for organizational strategy use. `;
                    }
                    
                    if (data.learningSlopeScaled) {
                        const slopeResult = window.NeuroscriptDB.getByWechslerScore(data.learningSlopeScaled);
                        narrative += `His learning slope across trials yielded a scaled score of ${data.learningSlopeScaled}, placing his learning efficiency in the ${slopeResult.aacnRange}`;
                        if (slopeResult.tScore < 40) {
                            narrative += `, indicating a ${slopeResult.impairmentLevel} level of impairment`;
                        }
                        narrative += `. `;
                    }
                    
                    narrative += `\n\n`;
                }

                // Error analysis (if available)
                if (data.intrusionsScaled || data.repetitions) {
                    narrative += `<h3>Error Analysis</h3>\n`;
                    
                    if (data.intrusionsScaled) {
                        const intrusionResult = window.NeuroscriptDB.getByWechslerScore(data.intrusionsScaled);
                        narrative += `${data.clientName} produced intrusion errors that resulted in a scaled score of ${data.intrusionsScaled}, placing his error control in the ${intrusionResult.aacnRange}`;
                        if (intrusionResult.tScore < 40) {
                            narrative += `, indicating a ${intrusionResult.impairmentLevel} level of impairment`;
                        }
                        narrative += `. `;
                    }
                    
                    if (data.repetitions !== null && data.repetitions !== undefined) {
                        if (data.repetitions <= 5) {
                            narrative += `He produced ${data.repetitions} repetitions, which is within normal limits and suggests good response monitoring. `;
                        } else if (data.repetitions <= 15) {
                            narrative += `He produced ${data.repetitions} repetitions, which is mildly elevated and may suggest some difficulty with response monitoring. `;
                        } else {
                            narrative += `He produced ${data.repetitions} repetitions, which is significantly elevated and suggests difficulty with response monitoring or possible perseverative tendencies. `;
                        }
                    }
                    
                    narrative += `\n\n`;
                }

                // Validity considerations
                if (data.forcedChoice || data.validityIndicator) {
                    narrative += `<h3>Validity Considerations</h3>\n`;
                    
                    if (data.forcedChoice <= 8) {
                        narrative += `⚠️ ${data.clientName}'s forced choice recognition performance (${data.forcedChoice}/16) was at or below chance level, raising significant concerns about test validity. This pattern is extremely unusual and may suggest insufficient effort, misunderstanding of instructions, or other validity concerns.\n\n`;
                    } else if (data.validityIndicator && data.validityIndicator > 2) {
                        narrative += `⚠️ The validity indicator shows ${data.validityIndicator} words that were recalled in immediate/delayed trials but missed on forced choice recognition. This pattern may suggest validity concerns and should be interpreted cautiously.\n\n`;
                    } else {
                        narrative += `The validity indicators suggest that the results are likely valid and reflect genuine memory performance.\n\n`;
                    }
                }

                // Summary and interpretation
                narrative += `<h3>Clinical Summary</h3>\n`;
                narrative += `${data.clientName}'s performance on the CVLT-3 reveals `;

                // Overall performance characterization
                const keyScores = [data.trials15Total, data.delayedIndex, data.totalRecall].filter(score => score !== null && score !== undefined);
                if (keyScores.length > 0) {
                    const avgScore = keyScores.reduce((sum, score) => sum + score, 0) / keyScores.length;
                    if (avgScore >= 110) {
                        narrative += `generally strong verbal learning and memory abilities. `;
                    } else if (avgScore >= 90) {
                        narrative += `generally adequate verbal learning and memory abilities. `;
                    } else if (avgScore >= 80) {
                        narrative += `some mild difficulties with verbal learning and memory. `;
                    } else if (avgScore >= 70) {
                        narrative += `notable difficulties with verbal learning and memory that may impact daily functioning. `;
                    } else {
                        narrative += `significant impairments in verbal learning and memory that likely impact daily functioning. `;
                    }
                }

                narrative += `These results should be interpreted within the context of his overall cognitive profile, educational background, and any relevant medical or psychiatric history. Further evaluation may be warranted if cognitive concerns persist.\n\n`;

                // Validation warnings section
                if (warnings.length > 0) {
                    narrative += `<h3>⚠️ Data Validation Warnings</h3>\n`;
                    warnings.forEach(warning => {
                        narrative += `${warning}\n`;
                    });
                    narrative += `\n`;
                }

                console.log('CVLT-3 narrative generated successfully v3.0');

                // Generate score table
                let scoreTable = `<h2>📊 CVLT-3 Score Summary</h2>\n`;
                scoreTable += `<table border="1" style="border-collapse: collapse; width: 100%; margin: 10px 0;">\n`;
                scoreTable += `<tr style="background-color: #f0f0f0;"><th>Measure</th><th>Raw Score</th><th>Scaled/Standard Score</th><th>Percentile</th><th>Range</th></tr>\n`;

                // Index scores
                if (data.trials15Total) {
                    const result = window.NeuroscriptDB.getByStandardScore(data.trials15Total);
                    scoreTable += `<tr><td><strong>Trials 1-5 Total Index</strong></td><td>—</td><td>${data.trials15Total}</td><td>${result.percentile}</td><td>${result.aacnRange}</td></tr>\n`;
                }
                
                if (data.delayedIndex) {
                    const result = window.NeuroscriptDB.getByStandardScore(data.delayedIndex);
                    scoreTable += `<tr><td><strong>Delayed Recall Correct Index</strong></td><td>—</td><td>${data.delayedIndex}</td><td>${result.percentile}</td><td>${result.aacnRange}</td></tr>\n`;
                }
                
                if (data.totalRecall) {
                    const result = window.NeuroscriptDB.getByStandardScore(data.totalRecall);
                    scoreTable += `<tr><td><strong>Total Recall Correct Index</strong></td><td>—</td><td>${data.totalRecall}</td><td>${result.percentile}</td><td>${result.aacnRange}</td></tr>\n`;
                }

                // Core scaled scores
                if (data.trial1Scaled) {
                    const result = window.NeuroscriptDB.getByWechslerScore(data.trial1Scaled);
                    scoreTable += `<tr><td>Trial 1 Correct</td><td>${data.trial1 || '—'}</td><td>${data.trial1Scaled}</td><td>${result.percentile}</td><td>${result.aacnRange}</td></tr>\n`;
                }
                
                if (data.trial5Scaled) {
                    const result = window.NeuroscriptDB.getByWechslerScore(data.trial5Scaled);
                    scoreTable += `<tr><td>Trial 5 Correct</td><td>${data.trial5 || '—'}</td><td>${data.trial5Scaled}</td><td>${result.percentile}</td><td>${result.aacnRange}</td></tr>\n`;
                }
                
                if (data.longFreeScaled) {
                    const result = window.NeuroscriptDB.getByWechslerScore(data.longFreeScaled);
                    scoreTable += `<tr><td>Long Delay Free Recall</td><td>${data.longFree || '—'}</td><td>${data.longFreeScaled}</td><td>${result.percentile}</td><td>${result.aacnRange}</td></tr>\n`;
                }
                
                if (data.forcedChoiceScaled) {
                    const result = window.NeuroscriptDB.getByWechslerScore(data.forcedChoiceScaled);
                    scoreTable += `<tr><td>Forced Choice Recognition</td><td>${data.forcedChoice || '—'}</td><td>${data.forcedChoiceScaled}</td><td>${result.percentile}</td><td>${result.aacnRange}</td></tr>\n`;
                }

                scoreTable += `</table>\n`;

                // Store results globally
                currentNarrative = narrative;
                currentScoreTable = scoreTable;

                // Display results
                document.getElementById('output').innerHTML = narrative + scoreTable;
                document.getElementById('output').style.display = 'block';

                console.log('CVLT-3 v3.0 report generation completed successfully');

            } catch (error) {
                console.error('Error in generateCVLTText v3.0:', error);
                document.getElementById('output').innerHTML = `<p><strong>Error generating report:</strong> ${error.message}</p>`;
                document.getElementById('output').style.display = 'block';
            }
        }

        function saveTestData() {
            console.log('saveTestData v3.0 called');
            
            // Generate the narrative first if not already generated
            if (!currentNarrative) {
                generateCVLTText();
                
                // Check if generation was successful
                if (!currentNarrative) {
                    alert('Please ensure all required fields are completed before saving.');
                    return;
                }
            }
            
            const results = {
                narrative: currentNarrative,
                scoreTable: currentScoreTable,
                testName: 'CVLT-3',
                completedAt: new Date().toISOString()
            };
            
            // Send data to parent/master dashboard
            if (window.parent !== window) {
                console.log('Sending CVLT-3 results to master dashboard v3.0');
                window.parent.postMessage({
                    type: 'testComplete',
                    testName: 'cvlt-3',
                    results: results
                }, '*');
            }
            
            // Show success message
            alert('CVLT-3 test data saved successfully!');
            console.log('CVLT-3 v3.0 test completion sent to master dashboard');
        }

        function loadTestData() {
            console.log('loadTestData v3.0 called');
            
            // Demo data for testing - preserving original values
            document.getElementById('clientName').value = 'Test Client';
            document.getElementById('age').value = '45';
            document.getElementById('gender').value = 'Male';
            document.getElementById('education').value = '12';
            document.getElementById('readingLevel').value = '12';
            
            // Core scores
            document.getElementById('trial1').value = '6';
            document.getElementById('trial1Scaled').value = '9';
            document.getElementById('trial5').value = '12';
            document.getElementById('trial5Scaled').value = '11';
            document.getElementById('longFree').value = '10';
            document.getElementById('longFreeScaled').value = '10';
            document.getElementById('forcedChoice').value = '14';
            document.getElementById('forcedChoiceScaled').value = '12';
            
            // Index scores
            document.getElementById('trials15Total').value = '95';
            document.getElementById('delayedIndex').value = '92';
            document.getElementById('totalRecall').value = '94';
            
            console.log('CVLT-3 demo data loaded v3.0');
        }

        // Event listener for client info from master dashboard
        window.addEventListener('message', function(event) {
            console.log('CVLT-3 v3.0 received message:', event.data);
            
            if (event.data.type === 'clientInfo') {
                const clientData = event.data.data;
                console.log('Populating CVLT-3 v3.0 with client data:', clientData);
                
                if (clientData.name) document.getElementById('clientName').value = clientData.name;
                if (clientData.age) document.getElementById('age').value = clientData.age;
                if (clientData.gender) document.getElementById('gender').value = clientData.gender;
                if (clientData.education) document.getElementById('education').value = clientData.education;
                if (clientData.readingLevel) document.getElementById('readingLevel').value = clientData.readingLevel;
            }
        });

        // Input validation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CVLT-3 v3.0 DOM loaded, setting up validation');
            
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    const min = parseFloat(this.min);
                    const max = parseFloat(this.max);
                    
                    if (this.value && (isNaN(value) || value < min || value > max)) {
                        this.style.border = '2px solid red';
                        this.style.backgroundColor = '#ffe6e6';
                    } else {
                        this.style.border = '1px solid #ddd';
                        this.style.backgroundColor = 'white';
                    }
                });
            });
        });

        console.log('CVLT-3 Enhanced v3.0 initialization complete');
    </script>
</body>
</html>
