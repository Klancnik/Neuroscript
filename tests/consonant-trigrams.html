<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consonant Trigrams Test Generator</title>
    <!-- Load shared normative database for AACN ranges and Heaton levels -->
    <script src="../neuroscript-norms.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="number"], select {
            width: 120px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        input.validation-error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .section-header {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .generate-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        .generate-btn:hover {
            background: #0056b3;
        }
        .complete-btn {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .complete-btn:hover {
            background: #1e7e34;
        }
        .output-section {
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin-top: 30px;
            border: 1px solid #ddd;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .technical-note {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            color: #0056b3;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧠 Consonant Trigrams Test Report Generator</h1>
        <p><em>Using Shura et al. (2016) validated US norms with education stratification</em></p>
        
        <div class="input-section">
            <h2>Client Demographics</h2>
            <div class="input-group">
                <label>Age:</label>
                <input type="number" id="age" value="" min="18" max="90" placeholder="18-90">
            </div>
            <div class="input-group">
                <label>Gender:</label>
                <select id="gender">
                    <option value="">Select...</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="input-group">
                <label>Education Level:</label>
                <select id="educationLevel">
                    <option value="">Select...</option>
                    <option value="lessThanBachelor">High School / Some College / Associate's</option>
                    <option value="bachelorPlus">Bachelor's Degree or Higher</option>
                </select>
            </div>
            <div class="input-group">
                <label>Years of Education:</label>
                <input type="number" id="education" value="" min="8" max="25" placeholder="8-25">
            </div>
            <div class="input-group">
                <label>Reading Level (grade):</label>
                <input type="number" id="readingLevel" value="" placeholder="Optional" min="1" max="16" step="0.1">
            </div>

            <div class="section-header">Raw Scores (Letters Recalled out of 15 per condition)</div>
            <div class="score-grid">
                <div>
                    <label>0-Second Delay (Immediate):</label>
                    <input type="number" id="delay0" value="" min="0" max="15" placeholder="0-15">
                </div>
                <div>
                    <label>9-Second Delay:</label>
                    <input type="number" id="delay9" value="" min="0" max="15" placeholder="0-15">
                    <small style="color: #666;">*Required for report</small>
                </div>
                <div>
                    <label>18-Second Delay:</label>
                    <input type="number" id="delay18" value="" min="0" max="15" placeholder="0-15">
                    <small style="color: #666;">*Required for report</small>
                </div>
            </div>

            <button class="generate-btn" onclick="generateTrigramsReport()">Generate Consonant Trigrams Report</button>
            <button class="complete-btn" onclick="completeTest()">Complete Test</button>
        </div>

        <div id="output" class="output-section" style="display:none;">
            <!-- Generated report will appear here -->
        </div>
    </div>

    <script>
        // Data management
        let currentNarrative = '';
        let currentScoreTable = '';

        // Shura et al. (2016) normative data - Healthy US Veterans sample
        const shuraNorms = {
            // Healthy controls (n=58, ages 21-60, US Veterans)
            healthyControls: {
                delay0: { mean: 14.98, sd: 0.13, range: [14, 15] },
                delay9: { mean: 11.90, sd: 2.63, range: [6, 15] },
                delay18: { mean: 10.45, sd: 3.18, range: [3, 15] }
            },
            
            // Education effect - significant finding from Shura et al.
            educationEffect: {
                bachelorPlus: 1.95,  // Bachelor's+ perform ~2 points better
                lessThanBachelor: 0   // Reference group
            },
            
            // Metadata
            sampleInfo: {
                ageRange: "21-60 years",
                source: "US Veterans",
                reliability: 0.79,
                validityTested: true
            },
            
            getPercentile: function(score, delay, educationLevel = 'lessThanBachelor') {
                const norms = this.healthyControls[`delay${delay}`];
                if (!norms) return 50;
                
                let adjustedScore = score;
                
                // Apply education correction for bachelor's+ (subtract advantage to get percentile)
                if (educationLevel === 'bachelorPlus' && delay !== 0) {
                    adjustedScore -= this.educationEffect.bachelorPlus;
                }
                
                const zScore = (adjustedScore - norms.mean) / norms.sd;
                return this.zScoreToPercentile(zScore);
            },
            
            zScoreToPercentile: function(z) {
                if (z >= 2.33) return 99;
                if (z >= 1.96) return 98;
                if (z >= 1.65) return 95;
                if (z >= 1.28) return 90;
                if (z >= 1.04) return 85;
                if (z >= 0.84) return 80;
                if (z >= 0.67) return 75;
                if (z >= 0.52) return 70;
                if (z >= 0.39) return 65;
                if (z >= 0.25) return 60;
                if (z >= 0.13) return 55;
                if (z >= 0.00) return 50;
                if (z >= -0.13) return 45;
                if (z >= -0.25) return 40;
                if (z >= -0.39) return 35;
                if (z >= -0.52) return 30;
                if (z >= -0.67) return 25;
                if (z >= -0.84) return 20;
                if (z >= -1.04) return 15;
                if (z >= -1.28) return 10;
                if (z >= -1.65) return 5;
                if (z >= -1.96) return 2;
                if (z >= -2.33) return 1;
                return 1;
            }
        };

        // Demographics auto-population from master dashboard
        window.addEventListener('message', function(event) {
            if (event.data.type === 'clientInfo') {
                const clientInfo = event.data.data;
                if (clientInfo.clientAge) {
                    document.getElementById('age').value = clientInfo.clientAge;
                }
                if (clientInfo.clientGender) {
                    document.getElementById('gender').value = 
                        clientInfo.clientGender === 'male' ? 'Male' : 'Female';
                }
                if (clientInfo.clientEducation) {
                    document.getElementById('education').value = clientInfo.clientEducation;
                    
                    // Auto-set education level based on years
                    const years = parseInt(clientInfo.clientEducation);
                    if (years >= 16) {
                        document.getElementById('educationLevel').value = 'bachelorPlus';
                    } else {
                        document.getElementById('educationLevel').value = 'lessThanBachelor';
                    }
                }
                if (clientInfo.readingLevel) {
                    document.getElementById('readingLevel').value = clientInfo.readingLevel;
                }
            }
        });

        // Input validation with red highlighting
        function validateInput(input, min, max) {
            const value = parseFloat(input.value);
            const isValid = input.value === '' || (!isNaN(value) && value >= min && value <= max);
            
            if (isValid) {
                input.classList.remove('validation-error');
            } else {
                input.classList.add('validation-error');
            }
            
            return isValid;
        }

        // Add validation listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('age').addEventListener('input', function() {
                validateInput(this, 18, 90);
            });

            document.getElementById('education').addEventListener('input', function() {
                validateInput(this, 8, 25);
                
                // Auto-update education level
                const years = parseInt(this.value);
                const levelSelect = document.getElementById('educationLevel');
                if (years >= 16) {
                    levelSelect.value = 'bachelorPlus';
                } else if (years > 0) {
                    levelSelect.value = 'lessThanBachelor';
                }
            });

            document.getElementById('readingLevel').addEventListener('input', function() {
                validateInput(this, 1, 16);
            });

            document.getElementById('delay0').addEventListener('input', function() {
                validateInput(this, 0, 15);
            });

            document.getElementById('delay9').addEventListener('input', function() {
                validateInput(this, 0, 15);
            });

            document.getElementById('delay18').addEventListener('input', function() {
                validateInput(this, 0, 15);
            });
        });

        function checkValidation() {
            const inputs = document.querySelectorAll('input[type="number"]');
            let hasErrors = false;
            
            inputs.forEach(input => {
                if (input.classList.contains('validation-error')) {
                    hasErrors = true;
                }
            });
            
            if (hasErrors) {
                alert('Please correct the highlighted fields before generating the report.');
                return false;
            }
            
            return true;
        }

        // Use external database for AACN ranges (same as other tests)
        function getPerformanceRange(percentile) {
            if (window.NeuroscriptDB) {
                const data = window.NeuroscriptDB.getByPercentile(percentile);
                return data ? data.aacn : 'Average';
            }
            
            // Fallback if database not loaded
            if (percentile >= 98) return 'Exceptionally High';
            if (percentile >= 91) return 'High';
            if (percentile >= 75) return 'High Average';
            if (percentile >= 25) return 'Average';
            if (percentile >= 9) return 'Below Average';
            if (percentile >= 2) return 'Low';
            return 'Exceptionally Low';
        }

        // Use external database for Heaton impairment levels (same as other tests)
        function getHeatonLevel(percentile) {
            if (window.NeuroscriptDB) {
                const data = window.NeuroscriptDB.getByPercentile(percentile);
                return data && data.heaton !== 'Normal' ? data.heaton : null;
            }
            
            // Fallback if database not loaded
            if (percentile <= 2) return 'severe level of impairment';
            if (percentile <= 9) return 'moderate to severe level of impairment';
            if (percentile <= 16) return 'mild to moderate level of impairment';
            return null;
        }

        // Format performance description exactly like other tests
        function formatPerformanceDescription(percentile, range, heatonLevel) {
            let description = `${range} range (${percentile}th percentile)`;
            if (heatonLevel) {
                description += `, indicating a ${heatonLevel}`;
            }
            return description;
        }

        function generateValidationWarnings(data) {
            let warnings = [];

            // Age boundary warnings
            if (data.age < 21 || data.age > 60) {
                warnings.push("⚠️ Age outside Shura et al. (2016) normative range (21-60 years) - interpret with caution");
            }

            // Reading level warnings
            if (!data.readingLevel) {
                warnings.push("⚠️ Reading level not assessed - may affect instruction comprehension");
            } else if (data.readingLevel < 5) {
                warnings.push("⚠️ Grade <5 reading level - instruction comprehension may be compromised");
            }

            // Unusual performance patterns
            if (data.delay9 > 0 && data.delay0 > 0 && data.delay9 > data.delay0) {
                warnings.push("⚠️ 9-second recall better than immediate - unusual pattern requiring review");
            }

            if (data.delay18 > 0 && data.delay9 > 0 && data.delay18 > data.delay9) {
                warnings.push("⚠️ 18-second recall better than 9-second - highly unusual pattern");
            }

            // Working memory decay analysis
            if (data.delay0 > 0 && data.delay18 > 0) {
                const totalDecay = data.delay0 - data.delay18;
                if (totalDecay > 10) {
                    warnings.push("⚠️ Severe working memory decay - consider validity or significant impairment");
                }
            }

            // Floor effects
            if (data.delay18 === 0) {
                warnings.push("⚠️ Zero recall at 18 seconds - consider severe impairment or validity concerns");
            }

            if (data.delay0 > 0 && data.delay0 < 12) {
                warnings.push("⚠️ Poor immediate recall - consider hearing, attention, or comprehension issues");
            }

            return warnings;
        }

        function generateTrigramsReport() {
            if (!checkValidation()) {
                return;
            }

            console.log("Generate Trigrams Report function called");

            // Check if external database is loaded
            if (!window.NeuroscriptDB) {
                document.getElementById('output').innerHTML = '<div class="warning"><h4>⚠️ Database Error</h4><p>External normative database not loaded. Please refresh the page and try again.</p></div>';
                document.getElementById('output').style.display = 'block';
                return;
            }

            // Get input data
            const data = {
                age: parseInt(document.getElementById('age').value) || 0,
                gender: document.getElementById('gender').value,
                educationLevel: document.getElementById('educationLevel').value,
                education: parseInt(document.getElementById('education').value) || 0,
                readingLevel: parseFloat(document.getElementById('readingLevel').value) || null,
                delay0: parseInt(document.getElementById('delay0').value) || 0,
                delay9: parseInt(document.getElementById('delay9').value) || 0,
                delay18: parseInt(document.getElementById('delay18').value) || 0
            };

            console.log("Processing data:", data);

            // Require 9-second and 18-second scores
            if (!data.delay9 || !data.delay18) {
                alert('Please enter both 9-second and 18-second delay scores to generate the report.');
                return;
            }

            // Require education level selection
            if (!data.educationLevel) {
                alert('Please select the education level (Bachelor\'s degree or higher vs. less than Bachelor\'s).');
                return;
            }

            const warnings = generateValidationWarnings(data);
            const gender = data.gender;
            const pronoun = gender === 'Male' ? 'His' : 'Her';
            const pronounLower = gender === 'Male' ? 'his' : 'her';

            try {
                // Calculate percentiles using Shura norms with education stratification
                const perc0 = data.delay0 > 0 ? shuraNorms.getPercentile(data.delay0, 0, data.educationLevel) : 0;
                const perc9 = shuraNorms.getPercentile(data.delay9, 9, data.educationLevel);
                const perc18 = shuraNorms.getPercentile(data.delay18, 18, data.educationLevel);

                console.log("Percentiles:", { perc0, perc9, perc18 });

                // Get AACN ranges and Heaton levels using external database
                const range0 = data.delay0 > 0 ? getPerformanceRange(perc0) : '';
                const range9 = getPerformanceRange(perc9);
                const range18 = getPerformanceRange(perc18);

                const heaton0 = data.delay0 > 0 ? getHeatonLevel(perc0) : null;
                const heaton9 = getHeatonLevel(perc9);
                const heaton18 = getHeatonLevel(perc18);

                // Format performance descriptions exactly like other tests
                const desc0 = data.delay0 > 0 ? formatPerformanceDescription(perc0, range0, heaton0) : '';
                const desc9 = formatPerformanceDescription(perc9, range9, heaton9);
                const desc18 = formatPerformanceDescription(perc18, range18, heaton18);

                // Generate clinical narrative
                let narrative = `On a test of working memory requiring recall of letter sequences following distraction, `;
                narrative += `${pronounLower} performance fell within the ${desc9} following a 9-second delay `;
                
                // Use connector logic like other tests
                const connector = (range9 === range18) ? 'and' : 'but';
                narrative += `${connector} in the ${desc18} following an 18-second delay. `;

                if (data.delay0 > 0) {
                    narrative += `Immediate recall was in the ${desc0}. `;
                }

                // Add clinical interpretation based on working memory decay
                const decay9to18 = data.delay9 - data.delay18;
                if (decay9to18 <= 1) {
                    narrative += `This pattern shows minimal decay over the delay intervals, suggesting adequate working memory maintenance.`;
                } else if (decay9to18 <= 3) {
                    narrative += `This pattern shows normal decay over the delay intervals.`;
                } else if (decay9to18 <= 5) {
                    narrative += `This pattern shows moderately rapid decay over the delay intervals, indicating working memory difficulties.`;
                } else {
                    narrative += `This pattern shows rapid decay over the delay intervals, suggesting significant working memory impairment.`;
                }

                currentNarrative = narrative;

                // Build score table for master dashboard
                currentScoreTable = `
                    <h3>Consonant Trigrams Test Score Summary</h3>
                    <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 15px;">
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 8px; text-align: left;">Delay Condition</th>
                            <th style="padding: 8px; text-align: center;">Raw Score</th>
                            <th style="padding: 8px; text-align: center;">Percentile</th>
                            <th style="padding: 8px; text-align: center;">Performance Range</th>
                        </tr>`;

                if (data.delay0 > 0) {
                    currentScoreTable += `
                        <tr>
                            <td style="padding: 8px;">0-Second Delay (Immediate)</td>
                            <td style="padding: 8px; text-align: center;">${data.delay0}/15</td>
                            <td style="padding: 8px; text-align: center;">${perc0}th</td>
                            <td style="padding: 8px; text-align: center;">${range0}</td>
                        </tr>`;
                }

                currentScoreTable += `
                        <tr>
                            <td style="padding: 8px;">9-Second Delay</td>
                            <td style="padding: 8px; text-align: center;">${data.delay9}/15</td>
                            <td style="padding: 8px; text-align: center;">${perc9}th</td>
                            <td style="padding: 8px; text-align: center;">${range9}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">18-Second Delay</td>
                            <td style="padding: 8px; text-align: center;">${data.delay18}/15</td>
                            <td style="padding: 8px; text-align: center;">${perc18}th</td>
                            <td style="padding: 8px; text-align: center;">${range18}</td>
                        </tr>
                    </table>`;

                // Build complete report for display
                let report = `<h2><b>Consonant Trigrams Test Report</b></h2>`;
                
                report += `<h3><b>Clinical Interpretation</b></h3>`;
                report += `<p>${narrative}</p>`;

                report += `<h3><b>Score Summary</b></h3>`;
                report += currentScoreTable;

                // Technical details section
                report += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px;">`;
                report += `<h4><b>Technical Details</b></h4>`;
                report += `<p><strong>Working Memory Analysis:</strong></p>`;
                if (data.delay0 > 0) {
                    report += `<p>• Decay from 0 to 9 seconds: ${data.delay0 - data.delay9} letters</p>`;
                }
                report += `<p>• Decay from 9 to 18 seconds: ${data.delay9 - data.delay18} letters</p>`;
                if (data.delay0 > 0) {
                    report += `<p>• Total decay: ${data.delay0 - data.delay18} letters</p>`;
                }
                
                const educationText = data.educationLevel === 'bachelorPlus' ? 
                    'Bachelor\'s degree or higher' : 'Less than Bachelor\'s degree';
                report += `<p><strong>Education Stratification:</strong> ${educationText}</p>`;
                report += `<p><strong>Age Range:</strong> Validated for ages 21-60 years</p>`;
                report += `</div>`;

                // Normative source citation
                report += `<div class="technical-note">`;
                report += `<h4><b>📚 Normative Data Source</b></h4>`;
                report += `<p><strong>Reference:</strong> Shura, R.D., Rowland, J.A., & Miskey, H.M. (2016). Auditory Consonant Trigrams: A Psychometric Update. <em>Archives of Clinical Neuropsychology, 31</em>(1), 47-57.</p>`;
                report += `<p><strong>Sample:</strong> Healthy US Veterans (n=58), ages 21-60, validity tested with Word Memory Test</p>`;
                report += `<p><strong>Reliability:</strong> Cronbach's α = 0.79 for total score</p>`;
                report += `<p><strong>Education Effect:</strong> Significant effect found for Bachelor's degree or higher education level</p>`;
                report += `</div>`;

                // Add validation warnings if any
                if (warnings.length > 0) {
                    report += `<div class="warning">`;
                    report += `<h4><b>⚠️ Validation Alerts</b></h4>`;
                    warnings.forEach(warning => {
                        report += `<p style="margin: 5px 0;">${warning}</p>`;
                    });
                    report += `</div>`;
                }

                document.getElementById('output').innerHTML = report;
                document.getElementById('output').style.display = 'block';

            } catch (error) {
                console.error("Error generating report:", error);
                document.getElementById('output').innerHTML = '<div class="warning"><h4>⚠️ Error</h4><p>Error generating report: ' + error.message + '</p></div>';
                document.getElementById('output').style.display = 'block';
            }
        }

        function completeTest() {
            if (!currentNarrative) {
                alert('Please generate the report first before completing the test.');
                return;
            }
            
            // Send completion message to master dashboard
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'testComplete',
                    testName: 'consonant-trigrams',
                    narrative: currentNarrative,
                    scoreTable: currentScoreTable
                }, '*');
            }
            alert('Consonant Trigrams test completed and results sent to master dashboard!');
        }
    </script>
</body>
</html>
