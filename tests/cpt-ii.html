<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPT-II Clinical Report Generator</title>
    <script src="../neuroscript-norms.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .input-group label {
            min-width: 180px;
            font-weight: bold;
            color: #333;
        }
        .input-group input, .input-group select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .section-header {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 20px 0 15px 0;
            font-weight: bold;
        }
        .score-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .score-grid > div {
            display: flex;
            align-items: center;
        }
        .score-grid label {
            min-width: 150px;
            font-weight: bold;
            color: #333;
        }
        .score-grid input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .generate-btn, .complete-btn, .load-data-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        .generate-btn:hover, .complete-btn:hover, .load-data-btn:hover {
            background: #0056b3;
        }
        .load-data-btn {
            background: #28a745;
        }
        .load-data-btn:hover {
            background: #1e7e34;
        }
        .output-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 30px;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }
        h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .validation-error {
            border: 2px solid red !important;
            background-color: #ffe6e6 !important;
        }
        .printout-layout {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
            margin-bottom: 20px;
        }
        .measure-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .measure-row:last-child {
            border-bottom: none;
        }
        .measure-label {
            font-weight: bold;
            color: #333;
        }
        .measure-input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CPT-II Clinical Report Generator <span style="font-size: 0.6em; color: #6c757d;">v2.6</span></h1>
        <p>Enter CPT-II scores to generate clinical narrative text in Neuroscript format</p>

        <div class="input-section">
            <h3>Demographics</h3>
            <div class="input-group">
                <label>Age (years):</label>
                <input type="number" id="age" value="" min="6" max="70" placeholder="6-70">
            </div>
            <div class="input-group">
                <label>Gender:</label>
                <select id="gender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="input-group">
                <label>Education (years):</label>
                <input type="number" id="education" value="" min="6" max="25" placeholder="6-25">
            </div>
            <div class="input-group">
                <label>Reading Level (grade):</label>
                <input type="number" id="readingLevel" value="" placeholder="Optional" min="1" max="16" step="0.1">
            </div>

            <div class="printout-layout">
                <div class="section-header">CPT-II T-Scores (From CPT-II Printout)</div>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px; font-weight: bold; background: #e9ecef; padding: 8px; border-radius: 4px;">
                    <div>Measure</div>
                    <div style="text-align: center;">T-Score</div>
                    <div style="text-align: center;">Range</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Omissions</div>
                    <input type="number" id="omissions" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="omissionsRange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Commissions</div>
                    <input type="number" id="commissions" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="commissionsRange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Hit RT</div>
                    <input type="number" id="hitRT" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="hitRTRange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Hit RT SE</div>
                    <input type="number" id="hitRTSE" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="hitRTSERange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Variability</div>
                    <input type="number" id="variability" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="variabilityRange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Detectability (d')</div>
                    <input type="number" id="detectability" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="detectabilityRange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
            </div>

            <div class="section-header">Additional Measures (Optional)</div>
            <div class="score-grid">
                <div>
                    <label>Response Style β:</label>
                    <input type="number" id="responseStyle" value="" placeholder="Response bias" step="0.01">
                </div>
                <div>
                    <label>Perseverations:</label>
                    <input type="number" id="perseverations" value="" placeholder="0+" min="0">
                </div>
            </div>

            <button class="load-data-btn" onclick="loadTestData()">Load Test Data</button>
            <button class="generate-btn" onclick="generateCPTReport()">Generate CPT-II Report</button>
            <button class="complete-btn" onclick="completeTest()">Complete Test</button>
        </div>

        <div id="output" class="output-section" style="display:none;">
            <!-- Generated report will appear here -->
        </div>
    </div>

    <script>
        // Data management
        let currentNarrative = '';
        let currentScoreTable = '';

        // Load external database check
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CPT-II v2.6 loaded - NARRATIVE STEPS 1-2 (NORMAL METRIC)');
            console.log('Database check:', typeof window.NeuroscriptDB);
            
            if (typeof window.NeuroscriptDB === 'undefined') {
                console.warn('External database not loaded - using CPT-II specific conversions');
            } else {
                console.log('Database loaded, but using CPT-II specific inverted scoring logic');
            }

            // Add input validation
            setupInputValidation();
        });

        function loadTestData() {
            // Demographics
            document.getElementById('age').value = 54;
            document.getElementById('gender').value = 'Female';
            document.getElementById('education').value = 16;
            document.getElementById('readingLevel').value = 12;
            
            // CPT-II scores - realistic example from printout
            document.getElementById('omissions').value = 65;
            document.getElementById('commissions').value = 58;
            document.getElementById('hitRT').value = 52;
            document.getElementById('hitRTSE').value = 62;
            document.getElementById('variability').value = 59;
            document.getElementById('detectability').value = 48;
            document.getElementById('responseStyle').value = 0.87;
            document.getElementById('perseverations').value = 2;
            
            console.log('Test data loaded successfully');
            
            // Update range displays
            updateRangeDisplays();
        }

        function setupInputValidation() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateInput(this);
                    updateRangeDisplays();
                });
            });
        }

        function validateInput(input) {
            const value = parseFloat(input.value);
            const min = parseFloat(input.min);
            const max = parseFloat(input.max);
            
            if (input.value && (isNaN(value) || (min && value < min) || (max && value > max))) {
                input.classList.add('validation-error');
            } else {
                input.classList.remove('validation-error');
            }
        }

        function updateRangeDisplays() {
            const measures = ['omissions', 'commissions', 'hitRT', 'hitRTSE', 'variability', 'detectability'];
            
            measures.forEach(measure => {
                const input = document.getElementById(measure);
                const rangeDiv = document.getElementById(measure + 'Range');
                
                if (input.value && !input.classList.contains('validation-error')) {
                    const tScore = parseInt(input.value);
                    const range = getCPTRange(tScore);
                    rangeDiv.textContent = range;
                    rangeDiv.style.color = tScore >= 60 ? '#dc3545' : '#28a745';
                } else {
                    rangeDiv.textContent = '—';
                    rangeDiv.style.color = '#666';
                }
            });
        }

        // CPT-II COMPLETE 7-POINT AACN SCALE with INVERTED SCORING - v2.5 FIX
        function getCPTRange(tScore) {
            console.log(`getCPTRange called with CPT-II T-score: ${tScore}`);
            
            // CPT-II COMPLETE AACN scale with INVERTED scoring
            // Higher T-scores = worse performance = lower AACN descriptors
            if (tScore >= 70) {
                console.log('Returning: Exceptionally Low (T≥70 = very poor performance)');
                return "Exceptionally Low";  // Very poor performance (≤2nd percentile equivalent)
            }
            if (tScore >= 65) {
                console.log('Returning: Low Average (T≥65 = poor performance)');
                return "Low Average";  // Poor performance (3rd-9th percentile equivalent)
            }
            if (tScore >= 60) {
                console.log('Returning: Below Average (T≥60 = below average performance)');
                return "Below Average";  // Below average performance (10th-25th percentile equivalent)
            }
            if (tScore >= 55) {
                console.log('Returning: Average (T≥55 = low average performance)');
                return "Average";  // Low average performance (26th-49th percentile equivalent)
            }
            if (tScore >= 45) {
                console.log('Returning: Average (T=45-54 = average performance)');
                return "Average";  // Average performance (50th-75th percentile equivalent)
            }
            if (tScore >= 40) {
                console.log('Returning: High Average (T=40-44 = good performance)');
                return "High Average";  // Good performance (76th-89th percentile equivalent)
            }
            if (tScore >= 35) {
                console.log('Returning: Above Average (T=35-39 = very good performance)');
                return "Above Average";  // Very good performance (90th-97th percentile equivalent)
            }
            
            console.log('Returning: Exceptionally High (T<35 = excellent performance)');
            return "Exceptionally High";  // Excellent performance (≥98th percentile equivalent)
        }

        // Use external database for AACN ranges and Heaton descriptors with CPT-II INVERTED SCORING
        function getPerformanceRange(percentile) {
            if (!window.NeuroscriptDB) {
                console.error('Database not available for range conversion');
                return 'Database Error';
            }
            
            let closest = window.NeuroscriptDB.conversionTable.reduce((prev, curr) => 
                Math.abs(curr.percentile - percentile) < Math.abs(prev.percentile - percentile) ? curr : prev
            );
            
            return closest.aacn;
        }

        function getHeatonLevel(percentile) {
            if (!window.NeuroscriptDB) {
                return null;
            }
            
            let closest = window.NeuroscriptDB.conversionTable.reduce((prev, curr) => 
                Math.abs(curr.percentile - percentile) < Math.abs(prev.percentile - percentile) ? curr : prev
            );
            
            return closest.heaton !== 'Normal' ? closest.heaton : null;
        }

        function formatPerformanceDescription(percentile, range, heaton) {
            if (heaton) {
                return `${range} range (${percentile}th percentile), indicating ${heaton}`;
            } else {
                return `${range} range (${percentile}th percentile)`;
            }
        }

        // NARRATIVE-SPECIFIC: Normal metric conversion (high scores = better performance) - v2.6
        function convertTScoreToPercentileNarrative(tScore) {
            console.log(`Converting CPT-II T-score ${tScore} to percentile for NARRATIVE (normal metric)`);
            
            // For narrative: Use NORMAL scoring interpretation (high = better)
            // This matches other tests in the system
            if (tScore >= 70) return 98;   // Excellent = 98th percentile
            if (tScore >= 65) return 93;   // Superior = 93rd percentile
            if (tScore >= 60) return 84;   // High Average = 84th percentile  
            if (tScore >= 55) return 69;   // Average = 69th percentile
            if (tScore >= 50) return 50;   // Average = 50th percentile
            if (tScore >= 45) return 31;   // Average = 31st percentile
            if (tScore >= 40) return 16;   // Below Average = 16th percentile
            if (tScore >= 35) return 7;    // Low = 7th percentile
            return 2;                      // Very Low = 2nd percentile
        }

        // NARRATIVE-SPECIFIC: Normal AACN ranges (high scores = better performance)
        function getPerformanceRangeNarrative(percentile) {
            console.log(`Getting NARRATIVE performance range for percentile: ${percentile}`);
            
            // Complete 7-point AACN scale for narrative (normal interpretation)
            if (percentile >= 98) return "Exceptionally High";
            if (percentile >= 91) return "Above Average";     
            if (percentile >= 75) return "High Average";
            if (percentile >= 25) return "Average";
            if (percentile >= 9) return "Below Average";
            if (percentile >= 2) return "Low Average";
            return "Exceptionally Low";
        }

        function getHeatonLevelNarrative(percentile) {
            console.log(`Getting Heaton level for NARRATIVE percentile: ${percentile}`);
            
            // Heaton impairment descriptors for percentiles ≤16th (normal metric)
            if (percentile <= 2) return "a severe level of impairment";
            if (percentile <= 9) return "a moderate to severe level of impairment";
            if (percentile <= 16) return "a mild to moderate level of impairment";
            return null; // No impairment descriptor for >16th percentile
        }

        function formatPerformanceDescriptionNarrative(percentile, range, heaton) {
            if (heaton) {
                return `${range} range (${percentile}th percentile), indicating ${heaton}`;
            } else {
                return `${range} range (${percentile}th percentile)`;
            }
        }

        // CPT-II COMPLETE 7-POINT AACN scale with inverted logic - v2.5
        function getPerformanceRange(percentile) {
            console.log(`Getting performance range for percentile: ${percentile}`);
            
            // Complete 7-point AACN scale
            if (percentile <= 2) return "Exceptionally Low";
            if (percentile <= 9) return "Low Average";      // Added missing label
            if (percentile <= 25) return "Below Average";
            if (percentile <= 49) return "Average";
            if (percentile <= 75) return "Average";         // Average spans broader range
            if (percentile <= 89) return "High Average";
            if (percentile <= 97) return "Above Average";   // Added missing label
            return "Exceptionally High";
        }

        function getHeatonLevel(percentile) {
            console.log(`Getting Heaton level for percentile: ${percentile}`);
            
            if (percentile <= 2) return "a severe level of impairment";
            if (percentile <= 9) return "a moderate to severe level of impairment";
            if (percentile <= 16) return "a mild to moderate level of impairment";
            if (percentile <= 25) return "a mild level of impairment";
            return null; // No impairment descriptor for normal range
        }

        function getCPTInterpretation(measure, tScore) {
            const interpretations = {
                omissions: {
                    high: "suggesting difficulty sustaining attention and increased inattentiveness",
                    typical: "indicating typical sustained attention",
                    low: "suggesting good sustained attention"
                },
                commissions: {
                    high: "indicating impulsivity and difficulty inhibiting responses",
                    typical: "suggesting typical response inhibition",
                    low: "indicating good response control"
                },
                hitRT: {
                    high: "suggesting slowed processing speed",
                    typical: "indicating typical response speed",
                    low: "suggesting fast response speed"
                },
                hitRTSE: {
                    high: "indicating inconsistent response speed",
                    typical: "suggesting consistent response times",
                    low: "indicating very consistent responding"
                },
                variability: {
                    high: "suggesting variable attention and inconsistent performance",
                    typical: "indicating consistent attention",
                    low: "suggesting very consistent attention"
                },
                detectability: {
                    high: "indicating good perceptual sensitivity",
                    typical: "suggesting typical perceptual sensitivity", 
                    low: "indicating poor perceptual sensitivity"
                }
            };

            const interp = interpretations[measure];
            if (!interp) return "";

            if (tScore >= 60) return interp.high;
            if (tScore >= 45) return interp.typical;
            return interp.low;
        }

        function generateValidationWarnings(data) {
            let warnings = [];

            // Age boundary warnings
            if (data.age < 6 || data.age > 70) {
                warnings.push("⚠️ Age outside CPT-II normative range (6-70 years)");
            }

            // Reading level concerns
            if (!data.readingLevel) {
                warnings.push("⚠️ Reading level not assessed - may affect instruction comprehension");
            } else if (data.readingLevel < 5) {
                warnings.push("⚠️ Grade <5 reading level - instruction comprehension may be compromised");
            }

            // Extreme scores
            if (data.omissions >= 70) {
                warnings.push("⚠️ Very high omissions (T≥70) - consider effort, comprehension, or severe inattention");
            }

            if (data.commissions >= 70) {
                warnings.push("⚠️ Very high commissions (T≥70) - suggests significant impulsivity");
            }

            // Response pattern analysis
            if (data.omissions >= 65 && data.commissions >= 65) {
                warnings.push("⚠️ Both high omissions and commissions - unusual pattern requiring review");
            }

            // Perseverations
            if (data.perseverations > 10) {
                warnings.push("⚠️ High perseverations (>10) - consider response set difficulties");
            }

            // Response bias
            if (data.responseStyle > 1.0) {
                warnings.push("⚠️ Conservative response style (β>1.0) - may indicate cautious approach");
            } else if (data.responseStyle < 0.5) {
                warnings.push("⚠️ Liberal response style (β<0.5) - may indicate impulsive approach");
            }

            return warnings;
        }

        function checkValidation() {
            const inputs = document.querySelectorAll('input[type="number"]');
            let hasErrors = false;
            
            inputs.forEach(input => {
                if (input.classList.contains('validation-error')) {
                    hasErrors = true;
                }
            });
            
            if (hasErrors) {
                alert('Please correct the highlighted fields before generating the report.');
                return false;
            }
            
            return true;
        }

        function generateCPTReport() {
            if (!checkValidation()) {
                return;
            }

            console.log("Generate CPT-II Report function called");

            // Check if external database is loaded
            if (!window.NeuroscriptDB) {
                document.getElementById('output').innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;"><h4>⚠️ Database Error</h4><p>External normative database not loaded. Please refresh the page.</p></div>';
                document.getElementById('output').style.display = 'block';
                return;
            }

            // Check if minimum required fields are filled
            const omissions = document.getElementById('omissions').value;
            const commissions = document.getElementById('commissions').value;
            
            if (!omissions && !commissions) {
                document.getElementById('output').innerHTML = `<div style="background: #fff3cd; padding: 15px; border-radius: 5px;"><p><strong>Note:</strong> Please enter test scores to generate the report.</p></div>`;
                document.getElementById('output').style.display = 'block';
                return;
            }

            const data = {
                age: parseInt(document.getElementById('age').value) || 0,
                gender: document.getElementById('gender').value,
                education: parseInt(document.getElementById('education').value) || 0,
                readingLevel: document.getElementById('readingLevel').value ? 
                    parseFloat(document.getElementById('readingLevel').value) : null,
                omissions: parseInt(document.getElementById('omissions').value) || 0,
                commissions: parseInt(document.getElementById('commissions').value) || 0,
                hitRT: parseInt(document.getElementById('hitRT').value) || 0,
                hitRTSE: parseInt(document.getElementById('hitRTSE').value) || 0,
                variability: parseInt(document.getElementById('variability').value) || 0,
                detectability: parseInt(document.getElementById('detectability').value) || 0,
                responseStyle: parseFloat(document.getElementById('responseStyle').value) || null,
                perseverations: parseInt(document.getElementById('perseverations').value) || 0
            };

            const warnings = generateValidationWarnings(data);
            const gender = data.gender;
            const pronoun = gender === 'Male' ? 'His' : 'Her';
            const pronounLower = gender === 'Male' ? 'his' : 'her';
            const heShe = gender === 'Male' ? 'He' : 'She';

            let report = '';

            // NARRATIVE GENERATION with NORMAL METRIC (Steps 1-2) - v2.6
            report += `<h3><b>Attention</b></h3>\n`;
            
            // Step 1: Introduction
            report += `<p>${heShe} was administered a test of visual vigilance and sustained attention (CPT-II).</p>\n\n`;

            // Step 2: d' (Detectability) score statement  
            if (data.detectability > 0) {
                const detPercentileNarrative = convertTScoreToPercentileNarrative(data.detectability);
                const detRangeNarrative = getPerformanceRangeNarrative(detPercentileNarrative);
                const detHeatonNarrative = getHeatonLevelNarrative(detPercentileNarrative);
                const detDescNarrative = formatPerformanceDescriptionNarrative(detPercentileNarrative, detRangeNarrative, detHeatonNarrative);
                
                report += `<p>On this measure, ${pronounLower} overall ability to discriminate targets from non-targets was within the ${detDescNarrative}.</p>\n\n`;
            }

            // Store for completion
            currentNarrative = report.replace(/<[^>]*>/g, '').trim();

            // Generate score table for master dashboard
            const adminMeasures = [];
            if (data.omissions) {
                const omissionPercentile = convertTScoreToPercentile(data.omissions);
                const omissionRange = getPerformanceRange(omissionPercentile);
                adminMeasures.push(['Omissions', data.omissions, omissionRange]);
            }
            if (data.commissions) {
                const commissionPercentile = convertTScoreToPercentile(data.commissions);
                const commissionRange = getPerformanceRange(commissionPercentile);
                adminMeasures.push(['Commissions', data.commissions, commissionRange]);
            }
            if (data.hitRT) {
                const rtPercentile = convertTScoreToPercentile(data.hitRT);
                const rtRange = getPerformanceRange(rtPercentile);
                adminMeasures.push(['Hit RT', data.hitRT, rtRange]);
            }
            if (data.hitRTSE) {
                const rtsePercentile = convertTScoreToPercentile(data.hitRTSE);
                const rtseRange = getPerformanceRange(rtsePercentile);
                adminMeasures.push(['Hit RT SE', data.hitRTSE, rtseRange]);
            }
            if (data.variability) {
                const varPercentile = convertTScoreToPercentile(data.variability);
                const varRange = getPerformanceRange(varPercentile);
                adminMeasures.push(['Variability', data.variability, varRange]);
            }
            if (data.detectability) {
                const detPercentile = convertTScoreToPercentile(data.detectability);
                const detRange = getPerformanceRange(detPercentile);
                adminMeasures.push(['Detectability', data.detectability, detRange]);
            }

            currentScoreTable = `
                <h3>CPT-II Score Summary</h3>
                <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 15px;">
                    <tr style="background-color: #f8f9fa;">
                        <th style="padding: 8px; text-align: left;">CPT-II Measure</th>
                        <th style="padding: 8px; text-align: center;">T-Score</th>
                        <th style="padding: 8px; text-align: center;">Range</th>
                    </tr>
                    ${adminMeasures.map(measure => `
                        <tr>
                            <td style="padding: 8px;">${measure[0]}</td>
                            <td style="padding: 8px; text-align: center;">${measure[1]}</td>
                            <td style="padding: 8px; text-align: center;">${measure[2]}</td>
                        </tr>
                    `).join('')}
                </table>
            `;

            // Technical details section
            report += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px;">`;
            report += `<h4><b>Technical Details</b></h4>`;
            report += `<p><strong>CPT-II T-Scores:</strong></p>`;
            if (data.omissions) {
                const omissionPercentile = convertTScoreToPercentile(data.omissions);
                report += `<p>• Omissions: ${data.omissions} (${omissionPercentile}th percentile)</p>`;
            }
            if (data.commissions) {
                const commissionPercentile = convertTScoreToPercentile(data.commissions);
                report += `<p>• Commissions: ${data.commissions} (${commissionPercentile}th percentile)</p>`;
            }
            if (data.hitRT) {
                const rtPercentile = convertTScoreToPercentile(data.hitRT);
                report += `<p>• Hit RT: ${data.hitRT} (${rtPercentile}th percentile)</p>`;
            }
            if (data.variability) {
                const varPercentile = convertTScoreToPercentile(data.variability);
                report += `<p>• Variability: ${data.variability} (${varPercentile}th percentile)</p>`;
            }
            if (data.perseverations) report += `<p>• Perseverations: ${data.perseverations}</p>`;
            if (data.responseStyle) report += `<p>• Response Style β: ${data.responseStyle.toFixed(2)}</p>`;
            report += `<p><strong>Note:</strong> T-scores ≥60 are considered clinically significant. Higher T-scores indicate worse performance on the CPT-II.</p>`;
            report += `</div>`;

            // Add validation warnings if any
            if (warnings.length > 0) {
                report += `<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 20px;">`;
                report += `<h4><b>⚠️ Validation Alerts</b></h4>`;
                warnings.forEach(warning => {
                    report += `<p style="margin: 5px 0;">${warning}</p>`;
                });
                report += `</div>`;
            }

            document.getElementById('output').innerHTML = report;
            document.getElementById('output').style.display = 'block';
        }

        function completeTest() {
            if (!currentNarrative) {
                alert('Please generate the report first before completing the test.');
                return;
            }

            const results = {
                narrative: currentNarrative,
                scoreTable: currentScoreTable,
                testName: 'CPT-II',
                completedAt: new Date().toISOString()
            };

            window.parent.postMessage({
                type: 'testComplete',
                testName: 'cpt-ii',
                results: results
            }, '*');

            console.log('CPT-II v2.6 test completed and sent to master dashboard');
        }

        // Listen for client info from parent
        window.addEventListener('message', function(event) {
            if (event.data.type === 'clientInfo') {
                const clientInfo = event.data.data;
                
                if (clientInfo.clientAge) {
                    document.getElementById('age').value = clientInfo.clientAge;
                }
                
                if (clientInfo.clientGender) {
                    document.getElementById('gender').value = clientInfo.clientGender === 'male' ? 'Male' : 'Female';
                }
                
                if (clientInfo.clientEducation) {
                    document.getElementById('education').value = clientInfo.clientEducation;
                }
                
                console.log('Client demographics populated from master dashboard');
            }
        });
    </script>
</body>
</html>
