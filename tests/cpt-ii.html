<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPT-II Clinical Report Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .section-header {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .generate-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .generate-btn:hover {
            background: #0056b3;
        }
        .output-section {
            background: white;
            border: 2px solid #dee2e6;
            padding: 25px;
            margin-top: 30px;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }
        h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CPT-II Clinical Report Generator</h1>
        <p>Enter CPT-II T-scores to generate clinical narrative text in Neuroscript format</p>
        
        <div class="input-section">
            <h3>Demographics</h3>
            <div class="input-group">
                <label>Gender:</label>
                <select id="gender">
                    <option value="Male">Male</option>
                    <option value="Female" selected>Female</option>
                </select>
            </div>
            <div class="input-group">
                <label>Reading Level (grade):</label>
                <input type="number" id="readingLevel" value="" placeholder="Optional" min="1" max="16" step="0.1">
            </div>

            <div class="section-header">Primary CPT-II Measures (T-Scores)</div>
            <div class="score-grid">
                <div>
                    <label>Omissions T-Score:</label>
                    <input type="number" id="omissionsTScore" value="69.51" min="20" max="100">
                </div>
                <div>
                    <label>Commissions T-Score:</label>
                    <input type="number" id="commissionsTScore" value="56.40" min="20" max="100">
                </div>
                <div>
                    <label>Hit RT T-Score:</label>
                    <input type="number" id="hitRTTScore" value="50.50" min="20" max="100">
                </div>
                <div>
                    <label>Hit RT Std Error T-Score:</label>
                    <input type="number" id="hitRTStdErrorTScore" value="54.92" min="20" max="100">
                </div>
                <div>
                    <label>Variability T-Score:</label>
                    <input type="number" id="variabilityTScore" value="57.45" min="20" max="100">
                </div>
                <div>
                    <label>Detectability (d') T-Score:</label>
                    <input type="number" id="detectabilityTScore" value="57.46" min="20" max="100" step="0.01">
                </div>
                <div>
                    <label>Response Style (β) T-Score:</label>
                    <input type="number" id="responseStyleTScore" value="53.84" min="20" max="100">
                </div>
                <div>
                    <label>Perseverations T-Score:</label>
                    <input type="number" id="perseverationsTScore" value="85.39" min="20" max="100">
                </div>
            </div>

            <div class="section-header">Block Change Measures (T-Scores)</div>
            <div class="score-grid">
                <div>
                    <label>Hit RT Block Change T-Score:</label>
                    <input type="number" id="hitRTBlockChangeTScore" value="56.34" min="20" max="100">
                </div>
                <div>
                    <label>Hit SE Block Change T-Score:</label>
                    <input type="number" id="hitSEBlockChangeTScore" value="57.93" min="20" max="100">
                </div>
                <div>
                    <label>Hit RT ISI Change T-Score:</label>
                    <input type="number" id="hitRTISIChangeTScore" value="37.73" min="20" max="100">
                </div>
                <div>
                    <label>Hit SE ISI Change T-Score:</label>
                    <input type="number" id="hitSEISIChangeTScore" value="32.66" min="20" max="100">
                </div>
            </div>

            <div class="section-header">Raw Values for Context</div>
            <div class="score-grid">
                <div>
                    <label>Omissions (raw):</label>
                    <input type="number" id="omissionsRaw" value="7" min="0" max="100">
                </div>
                <div>
                    <label>Commissions (raw):</label>
                    <input type="number" id="commissionsRaw" value="13" min="0" max="100">
                </div>
                <div>
                    <label>Hit RT (ms):</label>
                    <input type="number" id="hitRTRaw" value="409.43" min="200" max="800" step="0.01">
                </div>
                <div>
                    <label>Perseverations (raw):</label>
                    <input type="number" id="perseverationsRaw" value="2" min="0" max="50">
                </div>
            </div>

            <button class="generate-btn" onclick="generateCPTReport()">Generate CPT-II Report</button>
        </div>

        <div id="output" class="output-section" style="display:none;">
            <!-- Generated report will appear here -->
        </div>
    </div>

    <script>
        function getClinicalRange(tScore) {
            const convertedScore = convertCPTScore(tScore);
            if (convertedScore >= 90) return "within normal limits";
            if (convertedScore >= 60) return "Moderately Atypical";
            return "Markedly Atypical";
        }

        function getImpairmentLevel(tScore) {
            const convertedScore = convertCPTScore(tScore);
            if (convertedScore >= 90) return "Average";
            if (convertedScore >= 80) return "Below Average";
            if (convertedScore >= 70) return "Mildly Impaired";
            if (convertedScore >= 55) return "Mildly to Moderately Impaired";
            if (convertedScore >= 40) return "Moderately Impaired";
            return "Severely Impaired";
        }

        function convertCPTScore(tScore) {
            // Convert CPT-II inverted T-scores to traditional scoring
            // CPT T-score 57.46 becomes 50 - (57.46 - 50) = 42.54
            return 50 - (tScore - 50);
        }

        function getDetectabilityRange(tScore) {
            const convertedScore = convertCPTScore(tScore);
            console.log(`T-score: ${tScore}, Converted: ${convertedScore}`);
            if (convertedScore >= 110) return "Superior";
            if (convertedScore >= 90) return "Average";
            if (convertedScore >= 30) return "Below Average";  // Much broader range
            if (convertedScore >= 20) return "Mildly Impaired";
            if (convertedScore >= 10) return "Mildly to Moderately Impaired";
            return "Severely Impaired";
        }

        function getCommissionLevel(tScore) {
            if (tScore >= 65) return "very significantly higher than average";
            if (tScore >= 60) return "significantly higher than average";
            if (tScore >= 55) return "higher than average";
            return "average";
        }

        function getOmissionLevel(tScore) {
            if (tScore >= 65) return "very significantly higher than average";
            if (tScore >= 60) return "significantly higher than average";
            if (tScore >= 55) return "higher than average";
            return "average";
        }

        function getRTLevel(tScore) {
            if (tScore >= 60) return "significantly slower than average";
            if (tScore >= 55) return "slower than average";
            if (tScore <= 40) return "significantly faster than average";
            if (tScore <= 45) return "faster than average";
            return "average";
        }

        function getVariabilityLevel(tScore) {
            if (tScore >= 60) return "varied considerably";
            if (tScore >= 55) return "varied moderately";
            return "were consistent";
        }

        function getProgressiveLoss(blockChangeTScore) {
            return blockChangeTScore >= 60;
        }

        function isImpulsivePattern(commissionsTScore, hitRTTScore) {
            return commissionsTScore >= 55 && hitRTTScore <= 50;
        }

        function generateValidationWarnings(data) {
            let warnings = [];

            // Extreme detectability impairment
            if (data.detectabilityTScore >= 70) {
                warnings.push("⚠️ Severely impaired detectability - consider validity, sensory, or comprehension factors");
            }

            // Reading level concerns
            if (!data.readingLevel) {
                warnings.push("⚠️ Reading level not assessed - may affect instruction comprehension");
            } else if (data.readingLevel < 5) {
                warnings.push("⚠️ Grade <5 reading level - instruction comprehension may be compromised");
            }

            // Unusual response style
            if (data.responseStyleTScore >= 65 || data.responseStyleTScore <= 35) {
                warnings.push("⚠️ Unusual response style detected - may affect interpretation");
            }

            // Multiple elevated measures
            const elevatedCount = [
                data.omissionsTScore,
                data.commissionsTScore,
                data.detectabilityTScore,
                data.variabilityTScore
            ].filter(score => score >= 60).length;

            if (elevatedCount >= 3) {
                warnings.push("⚠️ Multiple elevated measures - consider comprehensive evaluation");
            }

            return warnings;
        }

        function generateCPTReport() {
            const data = {
                gender: document.getElementById('gender').value,
                readingLevel: document.getElementById('readingLevel').value ? 
                    parseFloat(document.getElementById('readingLevel').value) : null,
                omissionsTScore: parseFloat(document.getElementById('omissionsTScore').value),
                commissionsTScore: parseFloat(document.getElementById('commissionsTScore').value),
                hitRTTScore: parseFloat(document.getElementById('hitRTTScore').value),
                hitRTStdErrorTScore: parseFloat(document.getElementById('hitRTStdErrorTScore').value),
                variabilityTScore: parseFloat(document.getElementById('variabilityTScore').value),
                detectabilityTScore: parseFloat(document.getElementById('detectabilityTScore').value),
                responseStyleTScore: parseFloat(document.getElementById('responseStyleTScore').value),
                perseverationsTScore: parseFloat(document.getElementById('perseverationsTScore').value),
                hitRTBlockChangeTScore: parseFloat(document.getElementById('hitRTBlockChangeTScore').value),
                hitSEBlockChangeTScore: parseFloat(document.getElementById('hitSEBlockChangeTScore').value),
                hitRTISIChangeTScore: parseFloat(document.getElementById('hitRTISIChangeTScore').value),
                hitSEISIChangeTScore: parseFloat(document.getElementById('hitSEISIChangeTScore').value),
                omissionsRaw: parseInt(document.getElementById('omissionsRaw').value),
                commissionsRaw: parseInt(document.getElementById('commissionsRaw').value),
                hitRTRaw: parseFloat(document.getElementById('hitRTRaw').value),
                perseverationsRaw: parseInt(document.getElementById('perseverationsRaw').value)
            };

            const warnings = generateValidationWarnings(data);

            const gender = data.gender;
            const pronoun = gender === 'Male' ? 'His' : 'Her';
            const pronounLower = gender === 'Male' ? 'his' : 'her';
            const heShe = gender === 'Male' ? 'He' : 'She';
            const heSheLower = gender === 'Male' ? 'he' : 'she';

            let report = `<h3><b>Attention</b></h3>\n`;

            // Main interpretation paragraph
            const detectabilityRange = getDetectabilityRange(data.detectabilityTScore);
            console.log(`Debug: d' T-score = ${data.detectabilityTScore}, converted = ${convertCPTScore(data.detectabilityTScore)}, range = ${detectabilityRange}`);
            const omissionLevel = getOmissionLevel(data.omissionsTScore);
            const commissionLevel = getCommissionLevel(data.commissionsTScore);
            const rtLevel = getRTLevel(data.hitRTTScore);
            const variabilityLevel = getVariabilityLevel(data.variabilityTScore);

            report += `<p>${pronoun} ability to discriminate between targets and nontargets on a sustained visual vigilance task (CPT) was in the ${detectabilityRange} range. `;
            
            report += `${heShe} committed ${omissionLevel === "average" ? "an" : "a"} ${omissionLevel} number of errors of omission (not responding when ${heSheLower} should have responded) and ${commissionLevel === "average" ? "an" : "a"} ${commissionLevel} number of errors of commission (responding when ${heSheLower} should not have responded). `;

            report += `${pronoun} reaction times were ${rtLevel} overall; ${pronounLower} reaction times ${variabilityLevel} throughout the session. `;

            // Impulsivity vs inattention pattern
            if (isImpulsivePattern(data.commissionsTScore, data.hitRTTScore)) {
                report += `The number of errors of commission along with the fast reaction time, suggested impulsive responding. `;
            } else if (data.commissionsTScore < 55 && data.omissionsTScore >= 60) {
                report += `The low number of errors of commission indicated no significant problems with impulsive responding. `;
            }

            // Progressive loss of attention
            const progressiveLoss = getProgressiveLoss(data.hitRTBlockChangeTScore);
            if (progressiveLoss) {
                report += `A progressive loss of attention was suggested over the 14-minute duration of the test.`;
            } else {
                report += `No progressive loss of attention was noted over the 14-minute duration of the test.`;
            }

            report += `</p>\n\n`;

            // Technical details section
            report += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px;">`;
            report += `<h4><b>Technical Details</b></h4>`;
            report += `<p><strong>Primary Measures:</strong></p>`;
            report += `<p>• Omissions: ${data.omissionsRaw} errors (T=${data.omissionsTScore}) - ${getClinicalRange(data.omissionsTScore)}</p>`;
            report += `<p>• Commissions: ${data.commissionsRaw} errors (T=${data.commissionsTScore}) - ${getClinicalRange(data.commissionsTScore)}</p>`;
            report += `<p>• Hit Reaction Time: ${data.hitRTRaw}ms (T=${data.hitRTTScore}) - ${getClinicalRange(data.hitRTTScore)}</p>`;
            report += `<p>• Detectability (d'): T=${data.detectabilityTScore} - ${getClinicalRange(data.detectabilityTScore)}</p>`;
            report += `<p>• Variability: T=${data.variabilityTScore} - ${getClinicalRange(data.variabilityTScore)}</p>`;
            report += `<p>• Perseverations: ${data.perseverationsRaw} responses (T=${data.perseverationsTScore}) - ${getClinicalRange(data.perseverationsTScore)}</p>`;
            report += `<p><strong>Note:</strong> Higher T-scores indicate worse performance on CPT-II</p>`;
            report += `</div>`;

            // Add validation warnings if any
            if (warnings.length > 0) {
                report += `<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 20px;">`;
                report += `<h4><b>⚠️ Validation Alerts</b></h4>`;
                warnings.forEach(warning => {
                    report += `<p style="margin: 5px 0;">${warning}</p>`;
                });
                report += `</div>`;
            }

            document.getElementById('output').innerHTML = report;
            document.getElementById('output').style.display = 'block';
        }

        // Auto-generate on page load
        window.onload = function() {
            generateCPTReport();
        };
    </script>
</body>
</html>
