<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPT-II Clinical Report Generator</title>
    <script src="../neuroscript-norms.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .input-group label {
            min-width: 180px;
            font-weight: bold;
            color: #333;
        }
        .input-group input, .input-group select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .section-header {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 20px 0 15px 0;
            font-weight: bold;
        }
        .score-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .score-grid > div {
            display: flex;
            align-items: center;
        }
        .score-grid label {
            min-width: 150px;
            font-weight: bold;
            color: #333;
        }
        .score-grid input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .generate-btn, .complete-btn, .load-data-btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        .generate-btn:hover, .complete-btn:hover, .load-data-btn:hover {
            background: #0056b3;
        }
        .load-data-btn {
            background: #28a745;
        }
        .load-data-btn:hover {
            background: #1e7e34;
        }
        .output-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 30px;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }
        h3 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .validation-error {
            border: 2px solid red !important;
            background-color: #ffe6e6 !important;
        }
        .printout-layout {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
            margin-bottom: 20px;
        }
        .measure-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .measure-row:last-child {
            border-bottom: none;
        }
        .measure-label {
            font-weight: bold;
            color: #333;
        }
        .measure-input {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CPT-II Clinical Report Generator <span style="font-size: 0.6em; color: #6c757d;">v3.4</span></h1>
        <p>Enter CPT-II scores to generate clinical narrative text in Neuroscript format</p>

        <div class="input-section">
            <h3>Demographics</h3>
            <div class="input-group">
                <label>Age (years):</label>
                <input type="number" id="age" value="" min="6" max="70" placeholder="6-70">
            </div>
            <div class="input-group">
                <label>Gender:</label>
                <select id="gender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="input-group">
                <label>Education (years):</label>
                <input type="number" id="education" value="" min="6" max="25" placeholder="6-25">
            </div>
            <div class="input-group">
                <label>Reading Level (grade):</label>
                <input type="number" id="readingLevel" value="" placeholder="Optional" min="1" max="16" step="0.1">
            </div>

            <div class="printout-layout">
                <div class="section-header">CPT-II T-Scores (From CPT-II Printout)</div>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px; font-weight: bold; background: #e9ecef; padding: 8px; border-radius: 4px;">
                    <div>Measure</div>
                    <div style="text-align: center;">T-Score</div>
                    <div style="text-align: center;">Range</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Omissions</div>
                    <input type="number" id="omissions" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="omissionsRange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Commissions</div>
                    <input type="number" id="commissions" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="commissionsRange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Hit RT</div>
                    <input type="number" id="hitRT" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="hitRTRange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Hit RT SE</div>
                    <input type="number" id="hitRTSE" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="hitRTSERange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Variability</div>
                    <input type="number" id="variability" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="variabilityRange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
                
                <div class="measure-row">
                    <div class="measure-label">Detectability (d')</div>
                    <input type="number" id="detectability" class="measure-input" placeholder="30-90" min="30" max="90">
                    <div id="detectabilityRange" style="text-align: center; font-size: 12px; color: #666;">—</div>
                </div>
            </div>

            <div class="section-header">Additional Measures (Optional)</div>
            <div class="score-grid">
                <div>
                    <label>Response Style β:</label>
                    <input type="number" id="responseStyle" value="" placeholder="Response bias" step="0.01">
                </div>
                <div>
                    <label>Perseverations:</label>
                    <input type="number" id="perseverations" value="" placeholder="0+" min="0">
                </div>
            </div>

            <button class="load-data-btn" onclick="loadTestData()">Load Test Data</button>
            <button class="generate-btn" onclick="generateCPTReport()">Generate CPT-II Report</button>
            <button class="complete-btn" onclick="completeTest()">Complete Test</button>
        </div>

        <div id="output" class="output-section" style="display:none;">
            <!-- Generated report will appear here -->
        </div>
    </div>

    <script>
        // Data management
        let currentNarrative = '';
        let currentScoreTable = '';

        console.log('CPT-II v3.1 loaded - FRESH BUILD');

        function loadTestData() {
            console.log('Loading test data...');
            document.getElementById('age').value = 54;
            document.getElementById('gender').value = 'Female';
            document.getElementById('education').value = 16;
            document.getElementById('readingLevel').value = 12;
            
            document.getElementById('omissions').value = 65;
            document.getElementById('commissions').value = 58;
            document.getElementById('hitRT').value = 52;
            document.getElementById('hitRTSE').value = 62;
            document.getElementById('variability').value = 59;
            document.getElementById('detectability').value = 48;
            document.getElementById('responseStyle').value = 0.87;
            document.getElementById('perseverations').value = 2;
            
            updateRangeDisplays();
            console.log('Test data loaded successfully');
        }

        function getCPTErrorDescriptor(tScore) {
        // CPT SPEED descriptors from statconv file - v3.2
        function getCPTSpeedDescriptor(tScore) {
            console.log(`Getting CPT Speed descriptor for T-score: ${tScore}`);
            
            let cptPercentile, descriptor;
            
            // CPT SPEED descriptors from statconv with INVERTED percentiles
            if (tScore >= 77) {
                cptPercentile = 99;
                descriptor = "significantly slower than average";
            } else if (tScore >= 73) {
                cptPercentile = 95;
                descriptor = "significantly slower than average";
            } else if (tScore >= 57) {
                cptPercentile = 76;
                descriptor = "slower than average";
            } else if (tScore >= 45) {
                cptPercentile = 50;
                descriptor = "within normal limits";
            } else if (tScore >= 37) {
                cptPercentile = 24;
                descriptor = "slightly faster than average";
            } else if (tScore >= 30) {
                cptPercentile = 7;
                descriptor = "significantly faster than average";
            } else {
                cptPercentile = 2;
                descriptor = "very significantly faster than average";
            }
            
            // Convert to normal metric: 100 - CPT percentile
            const normalPercentile = 100 - cptPercentile;
            console.log(`Speed T=${tScore} -> CPT %ile=${cptPercentile} -> Normal %ile=${normalPercentile} -> "${descriptor}"`);
            
            return {descriptor: descriptor, percentile: normalPercentile};
        }

        // Helper function to determine if errors are "higher than average" or higher
        function isHighErrorLevel(descriptor) {
            return descriptor.includes("higher than average") || descriptor.includes("significantly higher") || descriptor.includes("very significantly higher");
        }

        // Helper function to determine if reaction times are slow/fast
        function getSpeedCategory(descriptor) {
            if (descriptor.includes("slower")) return "slow";
            if (descriptor.includes("faster")) return "fast";
            return "normal";
        }
            console.log(`Getting CPT Error descriptor for T-score: ${tScore}`);
            
            let cptPercentile, descriptor;
            
            if (tScore >= 77) {
                cptPercentile = 99;
                descriptor = "a very significantly higher than average number";
            } else if (tScore >= 73) {
                cptPercentile = 95;
                descriptor = "a very significantly higher than average number";
            } else if (tScore >= 69) {
                cptPercentile = 91;
                descriptor = "a significantly higher than average number";
            } else if (tScore >= 57) {
                cptPercentile = 76;
                descriptor = "a higher than average number";
            } else if (tScore >= 45) {
                cptPercentile = 50;
                descriptor = "an average number";
            } else if (tScore >= 37) {
                cptPercentile = 24;
                descriptor = "a fewer than average number";
            } else if (tScore >= 30) {
                cptPercentile = 7;
                descriptor = "a well below average number";
            } else {
                cptPercentile = 2;
                descriptor = "very few";
            }
            
            const normalPercentile = 100 - cptPercentile;
            console.log(`T=${tScore} -> CPT %ile=${cptPercentile} -> Normal %ile=${normalPercentile} -> "${descriptor}"`);
            
            return {descriptor: descriptor, percentile: normalPercentile};
        }

        // CPT COMPLETE 7-POINT AACN SCALE with INVERTED SCORING
        function getCPTRange(tScore) {
            if (tScore >= 70) return "Exceptionally Low";
            if (tScore >= 65) return "Low Average";
            if (tScore >= 60) return "Below Average";
            if (tScore >= 55) return "Average";
            if (tScore >= 45) return "Average";
            if (tScore >= 40) return "High Average";
            if (tScore >= 35) return "Above Average";
            return "Exceptionally High";
        }

        // NARRATIVE functions (normal metric)
        function convertTScoreToPercentileNarrative(tScore) {
            if (tScore >= 70) return 98;
            if (tScore >= 65) return 93;
            if (tScore >= 60) return 84;
            if (tScore >= 55) return 69;
            if (tScore >= 50) return 50;
            if (tScore >= 45) return 31;
            if (tScore >= 40) return 16;
            if (tScore >= 35) return 7;
            return 2;
        }

        function getPerformanceRangeNarrative(percentile) {
            if (percentile >= 98) return "Exceptionally High";
            if (percentile >= 91) return "Above Average";     
            if (percentile >= 75) return "High Average";
            if (percentile >= 25) return "Average";
            if (percentile >= 9) return "Below Average";
            if (percentile >= 2) return "Low Average";
            return "Exceptionally Low";
        }

        function getHeatonLevelNarrative(percentile) {
            if (percentile <= 2) return "a severe level of impairment";
            if (percentile <= 9) return "a moderate to severe level of impairment";
            if (percentile <= 16) return "a mild to moderate level of impairment";
            return null;
        }

        function formatPerformanceDescriptionNarrative(percentile, range, heaton) {
            if (heaton) {
                return `${range} range (${percentile}th percentile), indicating ${heaton}`;
            } else {
                return `${range} range (${percentile}th percentile)`;
            }
        }

        function loadTestData() {
            console.log('Loading test data...');
            document.getElementById('age').value = 54;
            document.getElementById('gender').value = 'Female';
            document.getElementById('education').value = 16;
            document.getElementById('readingLevel').value = 12;
            
            document.getElementById('omissions').value = 65;
            document.getElementById('commissions').value = 58;
            document.getElementById('hitRT').value = 52;
            document.getElementById('hitRTSE').value = 62;
            document.getElementById('variability').value = 59;
            document.getElementById('detectability').value = 48;
            document.getElementById('responseStyle').value = 0.87;
            document.getElementById('perseverations').value = 2;
            
            updateRangeDisplays();
            console.log('Test data loaded successfully');
        }
            const measures = ['omissions', 'commissions', 'hitRT', 'hitRTSE', 'variability', 'detectability'];
            
            measures.forEach(measure => {
                const input = document.getElementById(measure);
                const rangeDiv = document.getElementById(measure + 'Range');
                
                if (input.value && !input.classList.contains('validation-error')) {
                    const tScore = parseInt(input.value);
                    const range = getCPTRange(tScore);
                    rangeDiv.textContent = range;
                    rangeDiv.style.color = tScore >= 60 ? '#dc3545' : '#28a745';
                } else {
                    rangeDiv.textContent = '—';
                    rangeDiv.style.color = '#666';
                }
            });
        }

        function updateRangeDisplays() {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateInput(this);
                    updateRangeDisplays();
                });
            });
        }

        function setupInputValidation() {
            const value = parseFloat(input.value);
            const min = parseFloat(input.min);
            const max = parseFloat(input.max);
            
            if (input.value && (isNaN(value) || (min && value < min) || (max && value > max))) {
                input.classList.add('validation-error');
            } else {
                input.classList.remove('validation-error');
            }
        }

        function validateInput(input) {
            console.log('Generate CPT-II Report function called');

            const data = {
                age: parseInt(document.getElementById('age').value) || 0,
                gender: document.getElementById('gender').value,
                education: parseInt(document.getElementById('education').value) || 0,
                readingLevel: document.getElementById('readingLevel').value ? 
                    parseFloat(document.getElementById('readingLevel').value) : null,
                omissions: parseInt(document.getElementById('omissions').value) || 0,
                commissions: parseInt(document.getElementById('commissions').value) || 0,
                hitRT: parseInt(document.getElementById('hitRT').value) || 0,
                hitRTSE: parseInt(document.getElementById('hitRTSE').value) || 0,
                variability: parseInt(document.getElementById('variability').value) || 0,
                detectability: parseInt(document.getElementById('detectability').value) || 0,
                responseStyle: parseFloat(document.getElementById('responseStyle').value) || null,
                perseverations: parseInt(document.getElementById('perseverations').value) || 0
            };

            console.log('Data collected:', data);

            const gender = data.gender;
            const pronoun = gender === 'Male' ? 'His' : 'Her';
            const pronounLower = gender === 'Male' ? 'his' : 'her';
            const heShe = gender === 'Male' ? 'He' : 'She';

            let report = '';

            // NARRATIVE GENERATION - Steps 1-3
            report += `<h3><b>Attention</b></h3>\n`;
            
            // Step 1: Introduction
            report += `<p>${heShe} was administered a test of visual vigilance and sustained attention (CPT-II).</p>\n\n`;

            // Step 2: d' (Detectability) score statement  
            if (data.detectability > 0) {
                const detPercentileNarrative = convertTScoreToPercentileNarrative(data.detectability);
                const detRangeNarrative = getPerformanceRangeNarrative(detPercentileNarrative);
                const detHeatonNarrative = getHeatonLevelNarrative(detPercentileNarrative);
                const detDescNarrative = formatPerformanceDescriptionNarrative(detPercentileNarrative, detRangeNarrative, detHeatonNarrative);
                
                report += `<p>On this measure, ${pronounLower} overall ability to discriminate targets from non-targets was within the ${detDescNarrative}.</p>\n\n`;
            }

            // Step 3: Omissions and Commissions statement
            console.log('Checking omissions/commissions:', data.omissions, data.commissions);
            
            let omissionData = null;
            let commissionData = null;
            
            if (data.omissions > 0 || data.commissions > 0) {
                console.log('Processing omissions/commissions errors statement');
                
                if (data.omissions > 0 && data.commissions > 0) {
                    console.log('Both omissions and commissions present');
                    omissionData = getCPTErrorDescriptor(data.omissions);
                    commissionData = getCPTErrorDescriptor(data.commissions);
                    
                    const connector = (Math.abs(omissionData.percentile - commissionData.percentile) > 20) ? "although" : "and";
                    
                    const errorStatement = `However, ${heShe} committed ${omissionData.descriptor} (${omissionData.percentile}th percentile) of errors of omission (not responding when ${heShe.toLowerCase()} should have responded), ${connector} ${commissionData.descriptor} (${commissionData.percentile}th percentile) of errors of commission (responding when ${heShe.toLowerCase()} should not have responded).`;
                    
                    console.log('Error statement:', errorStatement);
                    report += `<p>${errorStatement}</p>\n\n`;
                    
                } else if (data.omissions > 0) {
                    console.log('Only omissions present');
                    omissionData = getCPTErrorDescriptor(data.omissions);
                    
                    const errorStatement = `However, ${heShe} committed ${omissionData.descriptor} (${omissionData.percentile}th percentile) of errors of omission (not responding when ${heShe.toLowerCase()} should have responded).`;
                    
                    console.log('Error statement:', errorStatement);
                    report += `<p>${errorStatement}</p>\n\n`;
                    
                } else if (data.commissions > 0) {
                    console.log('Only commissions present');
                    commissionData = getCPTErrorDescriptor(data.commissions);
                    
                    const errorStatement = `However, ${heShe} committed ${commissionData.descriptor} (${commissionData.percentile}th percentile) of errors of commission (responding when ${heShe.toLowerCase()} should not have responded).`;
                    
                    console.log('Error statement:', errorStatement);
                    report += `<p>${errorStatement}</p>\n\n`;
                }
            } else {
                console.log('No omissions or commissions to process');
            }

            // Step 4: Reaction Times statement - v3.2
            if (data.hitRT > 0) {
                console.log('Processing reaction times statement');
                const speedData = getCPTSpeedDescriptor(data.hitRT);
                
                const rtStatement = `${pronoun} reaction times were ${speedData.descriptor} (${speedData.percentile}th percentile).`;
                console.log('RT statement:', rtStatement);
                report += `<p>${rtStatement}</p>\n\n`;
            }

            // Step 5: Interpretive statement based on error patterns - v3.2
            console.log('Processing interpretive statement');
            
            const highOmissions = omissionData && isHighErrorLevel(omissionData.descriptor);
            const highCommissions = commissionData && isHighErrorLevel(commissionData.descriptor);
            
            let speedCategory = "normal";
            if (data.hitRT > 0) {
                const speedData = getCPTSpeedDescriptor(data.hitRT);
                speedCategory = getSpeedCategory(speedData.descriptor);
            }
            
            console.log('Pattern analysis:', {highOmissions, highCommissions, speedCategory});
            
            if (highOmissions && speedCategory === "slow") {
                const interpretStatement = `The high number of errors of omission and slow reaction times are indicative of significant inattention.`;
                console.log('Interpretive statement (omissions + slow):', interpretStatement);
                report += `<p>${interpretStatement}</p>\n\n`;
            } else if (highOmissions) {
                const interpretStatement = `The high number of errors of omission are indicative of significant inattention.`;
                console.log('Interpretive statement (omissions only):', interpretStatement);
                report += `<p>${interpretStatement}</p>\n\n`;
            }
            
            if (highCommissions && speedCategory === "fast") {
                const interpretStatement = `The high number of errors of commission and fast reaction times are indicative of significant impulsivity.`;
                console.log('Interpretive statement (commissions + fast):', interpretStatement);
                report += `<p>${interpretStatement}</p>\n\n`;
            } else if (highCommissions) {
                const interpretStatement = `The high number of errors of commission are indicative of significant impulsivity.`;
                console.log('Interpretive statement (commissions only):', interpretStatement);
                report += `<p>${interpretStatement}</p>\n\n`;
            }

            // Store for completion
            currentNarrative = report.replace(/<[^>]*>/g, '').trim();

            // Technical details section
            report += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px;">`;
            report += `<h4><b>Technical Details</b></h4>`;
            report += `<p><strong>CPT-II T-Scores:</strong></p>`;
            if (data.omissions) report += `<p>• Omissions: ${data.omissions}</p>`;
            if (data.commissions) report += `<p>• Commissions: ${data.commissions}</p>`;
            if (data.hitRT) report += `<p>• Hit RT: ${data.hitRT}</p>`;
            if (data.variability) report += `<p>• Variability: ${data.variability}</p>`;
            if (data.detectability) report += `<p>• Detectability: ${data.detectability}</p>`;
            if (data.perseverations) report += `<p>• Perseverations: ${data.perseverations}</p>`;
            if (data.responseStyle) report += `<p>• Response Style β: ${data.responseStyle.toFixed(2)}</p>`;
            report += `<p><strong>Note:</strong> T-scores ≥60 are considered clinically significant. Higher T-scores indicate worse performance on the CPT-II.</p>`;
            report += `</div>`;

            console.log('Final report:', report);
            
            document.getElementById('output').innerHTML = report;
            document.getElementById('output').style.display = 'block';
        }

        function completeTest() {
            if (!currentNarrative) {
                alert('Please generate the report first before completing the test.');
                return;
            }

            const results = {
                narrative: currentNarrative,
                scoreTable: currentScoreTable,
                testName: 'CPT-II',
                completedAt: new Date().toISOString()
            };

            window.parent.postMessage({
                type: 'testComplete',
                testName: 'cpt-ii',
                results: results
            }, '*');

            console.log('CPT-II v3.4 test completed and sent to master dashboard');
        }

        // Listen for client info from parent
        window.addEventListener('message', function(event) {
            if (event.data.type === 'clientInfo') {
                const clientInfo = event.data.data;
                
                if (clientInfo.clientAge) {
                    document.getElementById('age').value = clientInfo.clientAge;
                }
                
                if (clientInfo.clientGender) {
                    document.getElementById('gender').value = clientInfo.clientGender === 'male' ? 'Male' : 'Female';
                }
                
                if (clientInfo.clientEducation) {
                    document.getElementById('education').value = clientInfo.clientEducation;
                }
                
                console.log('Client demographics populated from master dashboard');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupInputValidation();
            console.log('CPT-II v3.4 initialization complete - ALL FUNCTIONS DEFINED FIRST');
        });
    </script>
</body>
</html>
